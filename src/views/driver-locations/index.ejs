<%- include('../partials/navbar') %>

<style>
  /* ========== DRIVER LOCATIONS PAGE STYLES ========== */
  /* Theme-aware styles using CSS variables */
  
  .locations-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
  }

  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .page-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
  }

  .refresh-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--btn-primary-bg, linear-gradient(135deg, #3b82f6, #2563eb));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  .refresh-btn:hover {
    background: var(--btn-primary-hover, linear-gradient(135deg, #2563eb, #1d4ed8));
    transform: translateY(-1px);
  }

  .refresh-btn.loading {
    opacity: 0.7;
    pointer-events: none;
  }

  /* Header Buttons - Theme Aware */
  .header-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    color: #ffffff !important;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none !important;
    box-shadow: var(--shadow-sm);
  }

  .header-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
    color: #ffffff !important;
  }

  .header-btn.btn-primary {
    background: var(--accent-primary);
  }

  .header-btn.btn-primary:hover {
    background: var(--accent-primary-hover);
  }

  .header-btn.btn-purple {
    background: var(--accent-secondary, #6366f1);
  }

  .header-btn.btn-purple:hover {
    background: #4f46e5;
  }

  .header-btn.btn-indigo {
    background: #8b5cf6;
  }

  .header-btn.btn-indigo:hover {
    background: #7c3aed;
  }

  .header-btn.loading {
    opacity: 0.7;
    pointer-events: none;
  }

  /* Map Legend */
  .map-legend {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--text-secondary);
  }

  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .legend-dot.green { background: #22c55e; }
  .legend-dot.yellow { background: #eab308; }
  .legend-dot.red { background: #ef4444; }
  .legend-dot.black { background: #374151; }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal-content {
    background: var(--bg-card);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-default);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
  }

  .modal-body {
    padding: 24px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid var(--border-default);
  }

  .btn-cancel {
    padding: 10px 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    cursor: pointer;
    color: var(--text-primary);
  }

  .btn-send {
    padding: 10px 24px;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-send:hover {
    background: #059669;
  }

  /* Light theme button fix - more contrast */
  [data-theme="light"] .header-btn {
    color: #ffffff !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }

  [data-theme="light"] .header-btn.btn-purple,
  [data-theme="light"] .header-btn.btn-indigo {
    background: var(--accent-primary) !important;
  }

  [data-theme="light"] .header-btn.btn-purple:hover,
  [data-theme="light"] .header-btn.btn-indigo:hover {
    background: var(--accent-primary-hover) !important;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .stat-card .value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .stat-card .label {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .stat-card.success .value { color: var(--success); }
  .stat-card.warning .value { color: var(--warning); }
  .stat-card.info .value { color: var(--accent-primary); }

  /* Map Container */
  .map-container {
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    box-shadow: var(--shadow-sm);
  }

  .map-placeholder {
    font-size: 48px;
  }

  .map-info {
    color: var(--text-muted);
    font-size: 14px;
    text-align: center;
  }

  #map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
  }

  /* Locations Table */
  .locations-section {
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .section-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .last-update {
    font-size: 12px;
    color: var(--text-muted);
  }

  .table-container {
    overflow-x: auto;
  }

  .locations-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .locations-table th,
  .locations-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-default);
  }

  .locations-table th {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--table-header-bg, rgba(0, 0, 0, 0.05));
  }

  .locations-table tbody tr {
    background: var(--bg-surface);
    transition: background 0.15s;
  }

  .locations-table tbody tr:hover {
    background: var(--table-row-hover, rgba(59, 130, 246, 0.08));
  }

  .driver-name {
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tracking-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }

  .tracking-badge.active {
    background: var(--success-light);
    color: var(--success-text, #10b981);
  }

  .tracking-badge.inactive {
    background: var(--bg-surface-alt, rgba(148, 163, 184, 0.15));
    color: var(--text-muted);
  }

  .coords {
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    color: var(--text-muted);
  }

  .speed-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    background: var(--accent-primary-light);
    color: var(--accent-primary);
  }

  .speed-badge.moving {
    background: var(--success-light);
    color: var(--success-text, #10b981);
  }

  .speed-badge.stopped {
    background: var(--bg-surface-alt, rgba(148, 163, 184, 0.15));
    color: var(--text-muted);
  }

  .time-ago {
    font-size: 12px;
    color: var(--text-muted);
  }

  .time-ago.recent {
    color: var(--success);
  }

  .time-ago.old {
    color: var(--warning);
  }

  .time-ago.very-old {
    color: var(--danger);
  }

  .no-location {
    color: var(--text-dimmed);
    font-style: italic;
  }

  .action-btn {
    padding: 6px 12px;
    background: var(--accent-primary-light);
    color: var(--accent-primary);
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: var(--accent-secondary-light);
    color: var(--accent-secondary);
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-state .icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .empty-state p {
    font-size: 16px;
    margin: 0;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .locations-container {
      padding: 16px;
    }

    .page-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .locations-table {
      font-size: 12px;
    }

    .locations-table th,
    .locations-table td {
      padding: 8px 12px;
    }
  }
</style>

<div class="locations-container">
  <div class="page-header">
    <h1>ğŸ“ ÅofÃ¶r KonumlarÄ±</h1>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      <button class="header-btn btn-success" onclick="openBroadcastModal()" style="background: #10b981;">
        ğŸ“¢ Toplu Mesaj
      </button>
      <a href="/driver-locations/api/export" class="header-btn btn-orange" style="background: #f59e0b; color: #fff !important;">
        ğŸ“¥ CSV Ä°ndir
      </a>
      <a href="/driver-locations/management" class="header-btn btn-purple" style="color: #fff !important;">
        âš™ï¸ ÅofÃ¶r YÃ¶netimi
      </a>
      <a href="/driver-messages" class="header-btn btn-indigo" style="color: #fff !important;">
        ğŸ’¬ Mesajlar
      </a>
      <button class="header-btn btn-danger" onclick="openDebugModal()" style="background: #991b1b;">
        ğŸ”§ Debug
      </button>
      <button class="header-btn btn-primary" onclick="refreshLocations()">
        ğŸ”„ Yenile
      </button>
    </div>
  </div>

  <!-- Broadcast Modal -->
  <div id="broadcast-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“¢ TÃ¼m ÅofÃ¶rlere Mesaj GÃ¶nder</h3>
        <button class="modal-close" onclick="closeBroadcastModal()">&times;</button>
      </div>
      <div class="modal-body">
        <textarea id="broadcast-message" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-default); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
        <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
          Bu mesaj tÃ¼m aktif ÅŸofÃ¶rlere gÃ¶nderilecektir.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeBroadcastModal()">Ä°ptal</button>
        <button class="btn-send" onclick="sendBroadcast()">ğŸ“¤ GÃ¶nder</button>
      </div>
    </div>
  </div>

  <!-- Debug Panel Modal (Password Protected) -->
  <div id="debug-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%);">
        <h3 style="color: white;">ğŸ”’ Debug Paneli</h3>
        <button class="modal-close" onclick="closeDebugModal()" style="color: white;">&times;</button>
      </div>
      <div id="debug-login" class="modal-body" style="text-align: center; padding: 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
        <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Debug paneline eriÅŸmek iÃ§in ÅŸifre girin</p>
        <input type="password" id="debug-password" placeholder="Åifre..." style="width: 100%; padding: 12px; border: 2px solid var(--border-default); border-radius: 8px; font-size: 16px; text-align: center;">
        <p id="debug-error" style="color: #ef4444; font-size: 13px; margin-top: 8px; display: none;">YanlÄ±ÅŸ ÅŸifre!</p>
        <button onclick="verifyDebugPassword()" style="margin-top: 16px; width: 100%; padding: 12px; background: #1f2937; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">ğŸ”“ GiriÅŸ</button>
      </div>
      <div id="debug-panel" class="modal-body" style="display: none; padding: 24px;">
        <div style="font-size: 32px; margin-bottom: 8px; text-align: center;">âš™ï¸</div>
        <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px; text-align: center;">Tehlikeli iÅŸlemler - Dikkatli kullanÄ±n!</p>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button onclick="closeDebugModal(); openDeleteMessagesModal();" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            ğŸ—‘ï¸ TÃ¼m MesajlarÄ± Sil
          </button>
          <button onclick="closeDebugModal(); openDeleteLocationsModal();" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            ğŸ“ TÃ¼m KonumlarÄ± Sil
          </button>
        </div>
        
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-default);">
          <p style="font-size: 11px; color: var(--text-muted); text-align: center;">âš ï¸ Bu iÅŸlemler geri alÄ±namaz</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Messages Modal -->
  <div id="delete-messages-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h3 style="color: white;">âš ï¸ TÃ¼m MesajlarÄ± Sil</h3>
        <button class="modal-close" onclick="closeDeleteMessagesModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—‘ï¸</div>
        <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">TÃ¼m ÅŸofÃ¶r mesajlarÄ± silinecek!</p>
        <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Bu iÅŸlem geri alÄ±namaz. TÃ¼m ÅŸofÃ¶rlerle olan mesaj geÃ§miÅŸi kalÄ±cÄ± olarak silinecektir.</p>
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <p style="font-size: 13px; color: #991b1b; margin: 0;">âš ï¸ Onaylamak iÃ§in aÅŸaÄŸÄ±ya <strong>"SÄ°L"</strong> yazÄ±n</p>
        </div>
        <input type="text" id="delete-confirm-input" placeholder="SÄ°L yazÄ±n..." style="width: 100%; padding: 12px; border: 2px solid #fecaca; border-radius: 8px; font-size: 16px; text-align: center; text-transform: uppercase;">
      </div>
      <div class="modal-footer" style="justify-content: center; gap: 12px;">
        <button class="btn-cancel" onclick="closeDeleteMessagesModal()">Ä°ptal</button>
        <button id="confirm-delete-btn" class="btn-send" onclick="deleteAllMessages()" style="background: #ef4444;" disabled>ğŸ—‘ï¸ KalÄ±cÄ± Olarak Sil</button>
      </div>
    </div>
  </div>

  <!-- Delete Locations Modal -->
  <div id="delete-locations-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);">
        <h3 style="color: white;">ğŸš¨ TÃ¼m Konum Verilerini Sil</h3>
        <button class="modal-close" onclick="closeDeleteLocationsModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“ğŸ—‘ï¸</div>
        <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #991b1b;">DÄ°KKAT! TÃœM KONUM VERÄ°LERÄ° SÄ°LÄ°NECEK!</p>
        <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Bu iÅŸlem tÃ¼m ÅŸofÃ¶rlerin konum geÃ§miÅŸini ve mevcut konumlarÄ±nÄ± kalÄ±cÄ± olarak silecektir. Bu iÅŸlem <strong>geri alÄ±namaz!</strong></p>
        
        <div style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <p style="font-size: 13px; color: #991b1b; margin: 0 0 12px 0;">âš ï¸ <strong>1. Onay:</strong> AÅŸaÄŸÄ±ya <strong>"KONUMLARI SÄ°L"</strong> yazÄ±n</p>
          <input type="text" id="delete-locations-input" placeholder="KONUMLARI SÄ°L yazÄ±n..." style="width: 100%; padding: 12px; border: 2px solid #fecaca; border-radius: 8px; font-size: 14px; text-align: center;">
        </div>
        
        <div style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 16px;">
          <p style="font-size: 13px; color: #991b1b; margin: 0 0 12px 0;">âš ï¸ <strong>2. Onay:</strong> Onay kutusunu iÅŸaretleyin</p>
          <label style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="delete-locations-checkbox" style="width: 20px; height: 20px;">
            <span style="font-size: 14px; color: #991b1b;">Evet, tÃ¼m konum verilerini silmek istiyorum</span>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center; gap: 12px;">
        <button class="btn-cancel" onclick="closeDeleteLocationsModal()">Ä°ptal</button>
        <button id="confirm-delete-locations-btn" class="btn-send" onclick="deleteAllLocations()" style="background: #991b1b;" disabled>ğŸš¨ KalÄ±cÄ± Olarak Sil</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>
  <style>
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      min-width: 300px;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      font-size: 14px;
      font-weight: 500;
    }
    .toast.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .toast.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    .toast-icon {
      font-size: 24px;
    }
    .toast-content {
      flex: 1;
    }
    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .toast-message {
      opacity: 0.9;
      font-size: 13px;
    }
    .toast-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background 0.2s;
    }
    .toast-close:hover {
      background: rgba(255,255,255,0.3);
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>

  <!-- Legend -->
  <div class="map-legend">
    <span class="legend-item"><span class="legend-dot green"></span> Son 5dk</span>
    <span class="legend-item"><span class="legend-dot yellow"></span> Son 30dk</span>
    <span class="legend-item"><span class="legend-dot red"></span> 30dk+ durgun</span>
    <span class="legend-item"><span class="legend-dot black"></span> Takip kapalÄ±</span>
  </div>

  <% 
    const trackingDrivers = locations.filter(l => l.is_tracking === 1);
    const recentLocations = locations.filter(l => {
      if (!l.recorded_at) return false;
      const diff = Date.now() - new Date(l.recorded_at).getTime();
      return diff < 60 * 60 * 1000; // Son 1 saat
    });
    const totalDrivers = locations.length;
  %>

  <div class="stats-grid">
    <div class="stat-card info">
      <div class="value"><%= totalDrivers %></div>
      <div class="label">Toplam ÅofÃ¶r</div>
    </div>
    <div class="stat-card success">
      <div class="value"><%= trackingDrivers.length %></div>
      <div class="label">Takip Aktif</div>
    </div>
    <div class="stat-card warning">
      <div class="value"><%= recentLocations.length %></div>
      <div class="label">Son 1 Saatte Aktif</div>
    </div>
  </div>

  <!-- Map Container - Ready for Leaflet/Google Maps integration -->
  <div class="map-container" id="map-container">
    <div id="map"></div>
  </div>

  <div class="locations-section">
    <div class="section-header">
      <h2>ğŸš› ÅofÃ¶r Listesi</h2>
      <span class="last-update" id="last-update">Son gÃ¼ncelleme: Åimdi</span>
    </div>

    <% if (locations.length === 0) { %>
      <div class="empty-state">
        <div class="icon">ğŸš›</div>
        <p>HenÃ¼z ÅŸofÃ¶r kaydÄ± yok veya konum verisi alÄ±nmamÄ±ÅŸ.</p>
      </div>
    <% } else { %>
      <div class="table-container">
        <table class="locations-table" id="locations-table">
          <thead>
            <tr>
              <th>ÅofÃ¶r</th>
              <th>Plaka</th>
              <th>Durum</th>
              <th>Konum</th>
              <th>HÄ±z</th>
              <th>Son GÃ¼ncelleme</th>
              <th>Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody>
            <% locations.forEach(function(loc) { 
              const hasLocation = loc.latitude && loc.longitude;
              let timeAgoClass = '';
              let timeAgoText = 'Veri yok';
              
              if (loc.recorded_at) {
                const diff = Date.now() - new Date(loc.recorded_at).getTime();
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                
                if (minutes < 5) {
                  timeAgoClass = 'recent';
                  timeAgoText = 'Az Ã¶nce';
                } else if (minutes < 60) {
                  timeAgoClass = 'recent';
                  timeAgoText = minutes + ' dk Ã¶nce';
                } else if (hours < 24) {
                  timeAgoClass = 'old';
                  timeAgoText = hours + ' saat Ã¶nce';
                } else {
                  timeAgoClass = 'very-old';
                  timeAgoText = Math.floor(hours / 24) + ' gÃ¼n Ã¶nce';
                }
              }
            %>
              <tr data-driver-id="<%= loc.driver_id %>" 
                  data-lat="<%= loc.latitude || '' %>" 
                  data-lng="<%= loc.longitude || '' %>"
                  data-recorded-at="<%= loc.recorded_at || '' %>"
                  data-is-tracking="<%= loc.is_tracking ? '1' : '0' %>"
                  data-phone="<%= loc.phone || '' %>"
                  data-truck-plate="<%= loc.truck_plate || '' %>">
                <td>
                  <span class="driver-name">
                    ğŸ§‘â€âœˆï¸ <%= loc.driver_name || 'ÅofÃ¶r #' + loc.driver_id %>
                  </span>
                  <% if (loc.phone) { %>
                    <br><small style="color: var(--text-muted);">ğŸ“ <%= loc.phone %></small>
                  <% } %>
                </td>
                <td>
                  <% if (loc.truck_plate) { %>
                    <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 12px;">
                      ğŸš› <%= loc.truck_plate %>
                    </span>
                  <% } else { %>
                    <span style="color: var(--text-muted, #64748b);">-</span>
                  <% } %>
                </td>
                <td>
                  <% if (loc.is_tracking) { %>
                    <span class="tracking-badge active">ğŸŸ¢ Takipte</span>
                  <% } else { %>
                    <span class="tracking-badge inactive">âšª KapalÄ±</span>
                  <% } %>
                </td>
                <td>
                  <% if (hasLocation) { %>
                    <span class="coords">
                      <%= loc.latitude.toFixed(6) %>, <%= loc.longitude.toFixed(6) %>
                    </span>
                  <% } else { %>
                    <span class="no-location">Konum yok</span>
                  <% } %>
                </td>
                <td>
                  <% if (hasLocation) { %>
                    <span class="speed-badge <%= loc.speed > 5 ? 'moving' : 'stopped' %>">
                      ğŸï¸ <%= Math.round(loc.speed || 0) %> km/h
                    </span>
                  <% } else { %>
                    <span class="no-location">-</span>
                  <% } %>
                </td>
                <td>
                  <span class="time-ago <%= timeAgoClass %>"><%= timeAgoText %></span>
                </td>
                <td>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <% if (loc.phone) { %>
                      <a href="tel:<%= loc.phone %>" class="action-btn" style="background: #3b82f6; padding: 6px 10px;" title="Telefon">
                        ğŸ“
                      </a>
                      <a href="https://wa.me/<%= loc.phone.replace(/[^0-9]/g, '') %>" target="_blank" class="action-btn" style="background: #22c55e; padding: 6px 10px;" title="WhatsApp">
                        ğŸ’¬
                      </a>
                    <% } %>
                    <a href="/driver-locations/<%= loc.driver_id %>/history" class="action-btn" style="padding: 6px 10px;" title="GeÃ§miÅŸ">
                      ğŸ“œ
                    </a>
                    <a href="/driver-messages/<%= loc.driver_id %>" class="action-btn msg-btn" data-driver-id="<%= loc.driver_id %>" style="background: linear-gradient(135deg, #667eea, #764ba2); position: relative; padding: 6px 10px;" title="Mesaj">
                      âœ‰ï¸
                      <% if (unreadCounts[loc.driver_id] > 0) { %>
                        <span class="msg-badge" id="badge-<%= loc.driver_id %>"><%= unreadCounts[loc.driver_id] %></span>
                      <% } else { %>
                        <span class="msg-badge" id="badge-<%= loc.driver_id %>" style="display: none;">0</span>
                      <% } %>
                    </a>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Initialize map
  let map;
  let markers = {};

  document.addEventListener('DOMContentLoaded', function() {
    initMap();
    addMarkersFromTable();
  });

  function initMap() {
    // Default center: Turkey
    map = L.map('map').setView([39.0, 35.0], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
  }

  // Get marker color based on last update time and tracking status
  function getMarkerColor(recordedAt, isTracking) {
    if (!isTracking) return '#374151'; // Black/Gray - tracking off
    if (!recordedAt) return '#374151';
    
    const diff = Date.now() - new Date(recordedAt).getTime();
    const minutes = diff / 60000;
    
    if (minutes < 5) return '#22c55e';   // Green - last 5 min
    if (minutes < 30) return '#eab308';  // Yellow - last 30 min
    return '#ef4444';                     // Red - 30+ min idle
  }

  function addMarkersFromTable() {
    const rows = document.querySelectorAll('#locations-table tbody tr');
    const bounds = [];
    
    rows.forEach(row => {
      const driverId = row.dataset.driverId;
      const lat = parseFloat(row.dataset.lat);
      const lng = parseFloat(row.dataset.lng);
      const recordedAt = row.dataset.recordedAt;
      const isTracking = row.dataset.isTracking === '1';
      
      if (!isNaN(lat) && !isNaN(lng)) {
        const driverName = row.querySelector('.driver-name').textContent.trim().replace('ğŸ§‘â€âœˆï¸ ', '');
        const speed = row.querySelector('.speed-badge')?.textContent.trim() || '0 km/h';
        const phone = row.dataset.phone || '';
        const truckPlate = row.dataset.truckPlate || '-';
        const timeAgo = row.querySelector('.time-ago')?.textContent.trim() || '-';
        
        const markerColor = getMarkerColor(recordedAt, isTracking);
        
        // Create custom colored icon
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background:${markerColor}; color:white; padding:6px 10px; border-radius:16px; font-size:11px; font-weight:600; white-space:nowrap; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:flex; align-items:center; gap:4px;">
                   ğŸš› ${driverName}
                 </div>`,
          iconSize: null,
          iconAnchor: [60, 30]
        });
        
        const marker = L.marker([lat, lng], { icon: icon }).addTo(map);
        
        // Enhanced popup with phone/WhatsApp buttons
        const popupContent = `
          <div style="min-width: 220px; font-family: system-ui, sans-serif;">
            <div style="font-weight: 700; font-size: 15px; margin-bottom: 8px; color: #1f2937;">
              ğŸ§‘â€âœˆï¸ ${driverName}
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
              ğŸš› <strong>${truckPlate}</strong>
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
              ğŸï¸ HÄ±z: <strong>${speed}</strong>
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
              ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}
            </div>
            <div style="font-size: 12px; color: #9ca3af; margin-bottom: 10px;">
              ğŸ• ${timeAgo}
            </div>
            ${phone ? `
            <div style="display: flex; gap: 8px; margin-top: 10px;">
              <a href="tel:${phone}" style="flex:1; padding: 8px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 600;">
                ğŸ“ Ara
              </a>
              <a href="https://wa.me/${phone.replace(/[^0-9]/g, '')}" target="_blank" style="flex:1; padding: 8px; background: #22c55e; color: white; text-decoration: none; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 600;">
                ğŸ’¬ WhatsApp
              </a>
            </div>
            ` : ''}
            <div style="margin-top: 10px;">
              <a href="/driver-locations/${driverId}/history" style="display: block; padding: 8px; background: #6366f1; color: white; text-decoration: none; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 600;">
                ğŸ“œ GeÃ§miÅŸi GÃ¶rÃ¼ntÃ¼le
              </a>
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent, { maxWidth: 280 });
        
        markers[driverId] = marker;
        bounds.push([lat, lng]);
      }
    });
    
    // Fit map to show all markers
    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }

  // Broadcast Modal Functions
  function openBroadcastModal() {
    document.getElementById('broadcast-modal').style.display = 'flex';
    document.getElementById('broadcast-message').focus();
  }

  function closeBroadcastModal() {
    document.getElementById('broadcast-modal').style.display = 'none';
    document.getElementById('broadcast-message').value = '';
  }

  function showToast(type, title, message, duration = 4000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
      success: 'âœ…',
      error: 'âŒ',
      warning: 'âš ï¸'
    };
    
    toast.innerHTML = `
      <span class="toast-icon">${icons[type] || 'ğŸ“¢'}</span>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
    `;
    
    container.appendChild(toast);
    
    // Auto remove after duration
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-in forwards';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // Debug Panel Functions
  const DEBUG_PASSWORD = 'amkturan123';  // Åifreyi buradan deÄŸiÅŸtirebilirsiniz
  let debugAuthenticated = false;

  function openDebugModal() {
    document.getElementById('debug-modal').style.display = 'flex';
    document.getElementById('debug-password').value = '';
    document.getElementById('debug-error').style.display = 'none';
    
    if (debugAuthenticated) {
      document.getElementById('debug-login').style.display = 'none';
      document.getElementById('debug-panel').style.display = 'block';
    } else {
      document.getElementById('debug-login').style.display = 'block';
      document.getElementById('debug-panel').style.display = 'none';
      setTimeout(() => document.getElementById('debug-password').focus(), 100);
    }
  }

  function closeDebugModal() {
    document.getElementById('debug-modal').style.display = 'none';
  }

  function verifyDebugPassword() {
    const password = document.getElementById('debug-password').value;
    if (password === DEBUG_PASSWORD) {
      debugAuthenticated = true;
      document.getElementById('debug-login').style.display = 'none';
      document.getElementById('debug-panel').style.display = 'block';
      document.getElementById('debug-error').style.display = 'none';
    } else {
      document.getElementById('debug-error').style.display = 'block';
      document.getElementById('debug-password').value = '';
      document.getElementById('debug-password').focus();
    }
  }

  // Enter key for debug password
  document.getElementById('debug-password').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') verifyDebugPassword();
  });

  function sendBroadcast() {
    const message = document.getElementById('broadcast-message').value.trim();
    if (!message) {
      showToast('warning', 'UyarÄ±', 'LÃ¼tfen bir mesaj yazÄ±n');
      return;
    }

    const btn = document.querySelector('.btn-send');
    btn.disabled = true;
    btn.textContent = 'â³ GÃ¶nderiliyor...';

    fetch('/driver-locations/api/broadcast', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: message })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast('success', 'BaÅŸarÄ±lÄ±! ğŸ‰', data.message);
        closeBroadcastModal();
      } else {
        showToast('error', 'Hata', data.message);
      }
    })
    .catch(err => {
      console.error('Broadcast error:', err);
      showToast('error', 'BaÄŸlantÄ± HatasÄ±', 'GÃ¶nderim baÅŸarÄ±sÄ±z oldu');
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = 'ğŸ“¤ GÃ¶nder';
    });
  }

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeBroadcastModal();
      closeDebugModal();
      closeDeleteMessagesModal();
      closeDeleteLocationsModal();
    }
  });

  // Delete Messages Modal Functions
  function openDeleteMessagesModal() {
    document.getElementById('delete-messages-modal').style.display = 'flex';
    document.getElementById('delete-confirm-input').value = '';
    document.getElementById('confirm-delete-btn').disabled = true;
  }

  function closeDeleteMessagesModal() {
    document.getElementById('delete-messages-modal').style.display = 'none';
    document.getElementById('delete-confirm-input').value = '';
  }

  // Enable/disable delete button based on input
  document.getElementById('delete-confirm-input').addEventListener('input', function(e) {
    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = e.target.value.toUpperCase() !== 'SÄ°L';
  });

  function deleteAllMessages() {
    const input = document.getElementById('delete-confirm-input').value.toUpperCase();
    if (input !== 'SÄ°L') {
      showToast('warning', 'UyarÄ±', 'LÃ¼tfen "SÄ°L" yazarak onaylayÄ±n');
      return;
    }

    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = true;
    btn.innerHTML = 'â³ Siliniyor...';

    fetch('/driver-locations/api/delete-all-messages', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast('success', 'BaÅŸarÄ±lÄ±! ğŸ—‘ï¸', data.message);
        closeDeleteMessagesModal();
      } else {
        showToast('error', 'Hata', data.message);
      }
    })
    .catch(err => {
      console.error('Delete messages error:', err);
      showToast('error', 'BaÄŸlantÄ± HatasÄ±', 'Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu');
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = 'ğŸ—‘ï¸ KalÄ±cÄ± Olarak Sil';
    });
  }

  // Delete Locations Modal Functions
  function openDeleteLocationsModal() {
    document.getElementById('delete-locations-modal').style.display = 'flex';
    document.getElementById('delete-locations-input').value = '';
    document.getElementById('delete-locations-checkbox').checked = false;
    document.getElementById('confirm-delete-locations-btn').disabled = true;
  }

  function closeDeleteLocationsModal() {
    document.getElementById('delete-locations-modal').style.display = 'none';
    document.getElementById('delete-locations-input').value = '';
    document.getElementById('delete-locations-checkbox').checked = false;
  }

  // Check both conditions for delete locations
  function checkDeleteLocationsConditions() {
    const input = document.getElementById('delete-locations-input').value.toUpperCase();
    const checkbox = document.getElementById('delete-locations-checkbox').checked;
    const btn = document.getElementById('confirm-delete-locations-btn');
    btn.disabled = !(input === 'KONUMLARI SÄ°L' && checkbox);
  }

  document.getElementById('delete-locations-input').addEventListener('input', checkDeleteLocationsConditions);
  document.getElementById('delete-locations-checkbox').addEventListener('change', checkDeleteLocationsConditions);

  function deleteAllLocations() {
    const input = document.getElementById('delete-locations-input').value.toUpperCase();
    const checkbox = document.getElementById('delete-locations-checkbox').checked;
    
    if (input !== 'KONUMLARI SÄ°L' || !checkbox) {
      showToast('warning', 'UyarÄ±', 'LÃ¼tfen tÃ¼m onaylarÄ± tamamlayÄ±n');
      return;
    }

    const btn = document.getElementById('confirm-delete-locations-btn');
    btn.disabled = true;
    btn.innerHTML = 'â³ Siliniyor...';

    fetch('/driver-locations/api/delete-all-locations', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast('success', 'BaÅŸarÄ±lÄ±! ğŸ“ğŸ—‘ï¸', data.message);
        closeDeleteLocationsModal();
        // Refresh page to show empty state
        setTimeout(() => window.location.reload(), 2000);
      } else {
        showToast('error', 'Hata', data.message);
      }
    })
    .catch(err => {
      console.error('Delete locations error:', err);
      showToast('error', 'BaÄŸlantÄ± HatasÄ±', 'Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu');
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = 'ğŸš¨ KalÄ±cÄ± Olarak Sil';
    });
  }

  function refreshLocations() {
    const btn = document.querySelector('.btn-primary');
    btn.classList.add('loading');
    btn.innerHTML = 'â³ YÃ¼kleniyor...';
    
    fetch('/driver-locations/api/latest')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Update last update time
          document.getElementById('last-update').textContent = 'Son gÃ¼ncelleme: Åimdi';
          
          // Reload page to refresh data
          window.location.reload();
        }
      })
      .catch(err => {
        console.error('Refresh error:', err);
        alert('Yenileme baÅŸarÄ±sÄ±z');
      })
      .finally(() => {
        btn.classList.remove('loading');
        btn.innerHTML = 'ğŸ”„ Yenile';
      });
  }

  // Auto-refresh every 30 seconds
  setInterval(function() {
    fetch('/driver-locations/api/latest')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('last-update').textContent = 'Son gÃ¼ncelleme: ' + new Date().toLocaleTimeString('tr-TR');
        }
      })
      .catch(err => console.error('Auto-refresh error:', err));
  }, 30000);
</script>

<style>
  .msg-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--btn-danger-bg, linear-gradient(135deg, #ef4444, #dc2626));
    color: white;
    font-size: 11px;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    box-shadow: var(--shadow-sm);
    animation: badgePulse 2s infinite;
  }
  
  @keyframes badgePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  
  .msg-btn {
    position: relative;
  }
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
  // Socket.IO for real-time message notifications
  const socket = io();
  const currentUser = '<%= currentUser?.username || "operator" %>';
  
  console.log('[DriverLocations] Socket connected:', socket.connected);
  
  socket.on('connect', () => {
    console.log('[DriverLocations] Socket connected, joining driver_messages_panel');
    // Join driver messages panel for notifications
    socket.emit('joinDriverMessagesPanel', { username: currentUser });
  });
  
  // Also emit on page load if already connected
  if (socket.connected) {
    socket.emit('joinDriverMessagesPanel', { username: currentUser });
  }
  
  // Listen for new messages from drivers
  socket.on('driver_new_message', (data) => {
    console.log('[DriverLocations] New message from driver:', data);
    updateBadge(data.driverId);
    playNotificationSound();
  });
  
  // Debug: listen for all events
  socket.onAny((eventName, ...args) => {
    console.log('[DriverLocations] Socket event:', eventName, args);
  });
  
  // Update badge for a driver
  function updateBadge(driverId) {
    const badge = document.getElementById('badge-' + driverId);
    if (badge) {
      const currentCount = parseInt(badge.textContent) || 0;
      badge.textContent = currentCount + 1;
      badge.style.display = 'flex';
    }
  }
  
  // Play notification sound
  function playNotificationSound() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;
      
      oscillator.start();
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {}
  }
  
  // Cleanup
  window.addEventListener('beforeunload', () => {
    socket.emit('leaveDriverMessagesPanel');
  });
</script>
