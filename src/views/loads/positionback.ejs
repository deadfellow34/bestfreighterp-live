<style>
  .position-detail-page {
    max-width: 100%;
    margin: 0 auto 32px;
    padding: 8px 24px 24px;
    box-sizing: border-box;
  }

  .position-detail-header {
    display: flex;
    gap: 18px;
    align-items: flex-start;
  }

  .position-detail-header-center {
    display: none !important;
  }

  .modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  /* Modal overlay defaults: hidden until activated */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 99999;
    width: 100%;
    height: 100%;
    background: rgba(2, 6, 23, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal-content {
    background: linear-gradient(180deg,#0b1220 0%, #0f1724 100%);
    border: 1px solid rgba(148,163,184,0.04);
    border-radius: 12px;
    width: auto;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 14px 40px rgba(2,6,23,0.6);
    padding: 12px;
    margin: 20px;
  }

  /* Ensure small modals (confirmation/toast-like) don't span full width */
  .modal-content[style*="max-width:"] {
    width: auto !important;
  }

  .modal-btn-cancel {
    background: #374151;
    color: #e5e7eb;
  }

  .modal-btn-cancel:hover {
    background: #4b5563;
  }

  .modal-btn-confirm {
    background: #22c55e;
    color: white;
  }

  .modal-btn-confirm:hover {
    background: #16a34a;
  }

  .modal-btn-warning {
    background: #f59e0b;
    color: white;
  }

  .modal-btn-warning:hover {
    background: #d97706;
  }

  .expense-card {
    background: rgba(15, 23, 42, 0.9);
    border-radius: 12px;
    border: 1px solid #1f2937;
    padding: 16px;
    margin-bottom: 16px;
  }

  .expense-card h3 {
    margin: 0 0 12px;
    font-size: 16px;
    font-weight: 600;
    color: #f9fafb;
  }

  .expense-form {
    display: grid;
    grid-template-columns: 150px 120px 1fr 100px;
    gap: 10px;
    align-items: end;
  }

  .expense-form label {
    font-size: 11px;
    text-transform: uppercase;
    color: #9ca3af;
    display: block;
    margin-bottom: 4px;
  }

  .expense-form input,
  .expense-form select {
    background: #020617;
    border: 1px solid #1f2937;
    border-radius: 6px;
    padding: 7px 9px;
    color: #e5e7eb;
    font-size: 13px;
    width: 100%;
    box-sizing: border-box;
  }

  .expense-list {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .expense-item {
    background: #020617;
    border: 1px solid #1f2937;
    border-radius: 8px;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .expense-item-info {
    display: flex;
    gap: 16px;
    align-items: center;
    font-size: 13px;
  }

  .expense-item-type {
    font-weight: 600;
    color: #60a5fa;
    min-width: 140px;
  }

  .expense-item-amount {
    color: #e5e7eb;
  }

  .expense-item-notes {
    color: #9ca3af;
    font-size: 12px;
  }

  .loads-table-card {
    background: rgba(15, 23, 42, 0.9);
    border-radius: 12px;
    border: 1px solid #1f2937;
    padding: 14px 16px 16px;
    box-sizing: border-box;
  }

  .loads-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .loads-table thead th {
    text-align: left;
    padding: 6px 8px;
    font-weight: 500;
    color: #9ca3af;
    border-bottom: 1px solid #111827;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .loads-table tbody td {
    padding: 7px 8px;
    border-bottom: 1px solid #374151;
    color: #e5e7eb;
    vertical-align: middle;
    background: #1f2937;
  }

  .loads-table tbody tr:last-child td {
    border-bottom: none;
  }

  .loads-table tbody tr:hover {
    background: #374151 !important;
  }

  .loads-table tbody tr:hover td {
    background: #374151;
  }

  .loads-small {
    font-size: 12px;
    color: #d1d5db;
  }

  .loads-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-start;
  }

  .inline-edit-input,
  .inline-edit-select {
    width: 100%;
    padding: 8px 10px;
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 14px;
    line-height: 1.2;
    transition: all 0.2s;
  }

  .inline-edit-input:focus,
  .inline-edit-select:focus {
    outline: none;
    border-color: #3b82f6;
    background: #111827;
  }

  .inline-edit-input:hover,
  .inline-edit-select:hover {
    border-color: #4b5563;
  }

  /* Increase table row padding and minimum height for better touch/click targets */
  .loads-table td {
    padding: 10px 8px;
    vertical-align: middle;
  }

  .loads-table tbody tr {
    min-height: 56px;
  }

  @media (max-width: 900px) {
    .position-detail-page {
      padding: 8px 12px 24px;
    }

    .position-detail-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .expense-form {
      grid-template-columns: 1fr;
    }

    .loads-table {
      font-size: 12px;
    }

    .loads-table thead th {
      padding: 4px 6px;
      font-size: 11px;
    }

    .loads-table tbody td {
      padding: 6px 4px;
    }
  }

  /* Navbar stilleri */
  .navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 28px;
    background: linear-gradient(90deg, #020617 0%, #0b1120 50%, #020617 100%);
    border-bottom: 1px solid #1f2937;
    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.9);
  }

  .nav-left,
  .nav-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand {
    font-weight: 700;
    font-size: 17px;
    color: #f9fafb;
    text-decoration: none;
    padding: 6px 10px;
    border-radius: 999px;
    background: radial-gradient(circle at 0 0, #3b82f6 0, #0b1120 55%);
    box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.3);
  }

  .nav-link {
    color: #9ca3af;
    text-decoration: none;
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 999px;
    transition: all 0.15s ease;
  }

  .nav-link:hover {
    color: #e5e7eb;
    background-color: rgba(148, 163, 184, 0.18);
  }

  .user-info {
    font-size: 13px;
    color: #9ca3af;
    padding: 4px 10px;
    border-radius: 999px;
    background-color: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(55, 65, 81, 0.9);
  }

  .logout-form {
    margin: 0;
    display: inline;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 7px 16px;
    border-radius: 999px;
    border: none;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.15s ease;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: #fff;
  }

  .btn:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }

  .btn-outline {
    background: transparent;
    border: 1px solid #374151;
    color: #9ca3af;
  }

  .btn-outline:hover {
    background: rgba(55, 65, 81, 0.3);
    border-color: #4b5563;
    color: #e5e7eb;
    transform: none;
    box-shadow: none;
  }

  .btn-sm {
    padding: 5px 12px;
    font-size: 12px;
  }

  /* Placeholder styling for Ä°hracat Poz input */
  .ihr-placeholder::placeholder {
    color: #ef4444 !important;
    font-weight: 700 !important;
    opacity: 1 !important;
  }
</style>

<%- include('../partials/navbar') %>

<div class="position-detail-page">
  <div class="position-detail-header">
    <div class="position-detail-header-left">
      <h1>
        Pozisyon <%= positionNo %>
        <% if (repTruck || repTrailer) { %>
          <span style="font-size: 30px; color: #60a5fa; margin-left: 20px;">
            <% if (repTruck) { %>
              ğŸšš 
              <% if (typeof repTruckId !== 'undefined' && repTruckId) { %>
                <a href="/vehicles/<%= repTruckId %>" style="color:inherit; text-decoration:none;"> <%= repTruck %></a>
              <% } else { %>
                <%= repTruck %>
              <% } %>
            <% } %>
            <% if (repTrailer) { %>
              / ğŸš› 
              <% if (typeof repTrailerId !== 'undefined' && repTrailerId) { %>
                <a href="/vehicles/<%= repTrailerId %>" style="color:inherit; text-decoration:none;"> <%= repTrailer %></a>
              <% } else { %>
                <%= repTrailer %>
              <% } %>
            <% } %>
          </span>
        <% } %>
      </h1>

      <!-- Action area: Ä°hracat Poz first, then TamamlandÄ±, then Masraf Yok -->
      <div class="position-action-buttons" style="display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap;">
      
        <% if (loads[0].status !== 'completed') { %>
          <button type="button" class="btn" style="background: #22c55e; color: white; border: none; font-size:15px; padding:10px 18px; border-radius:10px; font-weight:700;" onclick="showCompleteModal()">
            Dosya TamamlandÄ±
          </button>
        <% } else { %>
          <button type="button" class="btn" style="background: #f59e0b; color: white; border: none; font-size:15px; padding:10px 18px; border-radius:10px; font-weight:700;" onclick="showReopenModal()">
            KaydÄ± Ã‡ek
          </button>
        <% } %>

        <% if (loads[0].no_expense === 1) { %>
          <button type="button" class="btn" style="background: #ef4444; color: white; border: none; font-size:15px; padding:10px 18px; border-radius:10px; font-weight:700;" onclick="showUnmarkNoExpenseModal()">
            Masraf Yok
          </button>
        <% } else { %>
          <button type="button" class="btn" style="background: #6b7280; color: white; border: none; font-size:15px; padding:10px 18px; border-radius:10px; font-weight:700;" onclick="showMarkNoExpenseModal()">
            Masraf Yok
          </button>
        <% } %>
      </div>
    </div>

    <!-- Center column intentionally left empty (arrival control moved to right-side actions) -->
    <div class="position-detail-header-center" style="flex:1; display:flex; justify-content:center; align-items:center;"></div>

    <div style="display: flex; gap: 16px; margin-left: auto; align-items: flex-start;">
      <!-- VarÄ±ÅŸ Tarihi -->
      <form id="position-info-inline-form" method="POST" action="/loads/position/<%= encodeURIComponent(positionNo) %>/update-vehicle" style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:13px; font-weight:600; color:#9ca3af;">VarÄ±ÅŸ:</span>
        <input type="date" id="pos_inline_unloading_date" name="unloading_date" value="<%= loads[0].unloading_date || '' %>" style="background:#0f172a; border:1px solid #334155; border-radius:8px; padding:6px 10px; color:#e5e7eb; font-size:13px; width:130px;" />
        <button type="submit" class="btn" style="background:#10b981; color:#021018; padding:6px 10px; font-size:12px; border-radius:6px; font-weight:700;">âœ”</button>
      </form>

      <!-- Antrepo Liste ve PDF ButonlarÄ± - Alt Alta -->
      <div style="display:flex; flex-direction:column; gap:6px;">
        <button type="button" onclick="openAntrepoListeModal()" class="btn" style="padding:8px 16px; font-size:13px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #059669, #10b981); border:1px solid #10b981;">
          <span style="font-weight:700; color:#fff;">ğŸ“¦ Antrepo Liste</span>
        </button>
        <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/ameta" class="btn btn-outline" target="_blank" style="padding:8px 16px; font-size:13px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center;">
          <span style="font-weight:700;">ğŸ“„ AMETA PDF</span>
        </a>
        <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/yl" class="btn btn-outline" target="_blank" style="padding:8px 16px; font-size:13px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center;">
          <span style="font-weight:700;">ğŸ“„ YL PDF</span>
        </a>
      </div>
      <!-- 'KaydÄ± Bitir' moved next to 'Masraf Yok' in the header -->
      <!-- '+ Bu Pozisyona Yeni YÃ¼k Ekle' removed per request -->
      <button type="button" class="btn btn-outline" onclick="openDistanceCalculator()" id="distance-calculator-btn" style="padding:10px 18px; font-size:15px; border-radius:10px; display:flex; align-items:center; gap:12px;">
        <span style="font-weight:700;">ğŸš› AraÃ§ KM Hesapla</span>
        <div id="btn-km-summary" style="display:none; margin-left:6px; padding:6px 12px; background:#0f172a; color:#e6eef6; border-radius:10px; font-size:13px; font-weight:600; line-height:1.1; min-width:280px;">
          <!-- Top: Subtotals -->
          <div id="btn-subtotals" style="font-size:12px; color:#9ca3af;">YÃ¼kleme: 0.0 | VarÄ±ÅŸ: 0.0 | Ã‡Ä±kÄ±ÅŸ: 0.0</div>

          <!-- Next: Ä°ngiltere KM (accounting total) -->
          <div style="display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-top:8px;">
            <div style="flex:1"></div>
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:11px; color:#9ca3af;">Ä°ngiltere KM</span>
              <span id="btn-acc-km" style="background:#22c55e; color:#021; padding:6px 10px; border-radius:8px; font-weight:800; font-size:14px;">0.0 km</span>
            </div>
          </div>

          <!-- Europa loading label removed per UI request -->

          <!-- Europa KM pill and list -->
          <div style="display:flex; align-items:center; justify-content:flex-end; gap:12px; margin-top:6px;">
            <div style="flex:1"></div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
              <div style="display:flex; gap:8px; align-items:center;">
                <span style="font-size:11px; color:#9ca3af;">Avrupa KM</span>
                <span id="btn-eu-km" style="background:#7c3aed; color:#fff; padding:6px 10px; border-radius:8px; font-weight:800; font-size:14px;">0.0 km</span>
              </div>
              <div id="btn-eu-list" style="font-size:11px; color:#9ca3af; opacity:0.95;">Avrupa segmentleri: -</div>
            </div>
          </div>

          <!-- Emphasized total at bottom -->
          <div id="btn-totalall" style="margin-top:8px; display:flex; width:100%;">
            <div style="flex:1"></div>
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:11px; color:#9ca3af;">TÃ¼m KM</span>
              <span id="btn-totalall-val" style="background: linear-gradient(90deg,#16a34a,#10b981); color:#021; padding:8px 14px; border-radius:12px; font-weight:900; font-size:15px;">0.0 km</span>
            </div>
          </div>
        </div>
      </button>
    </div>
  </div>

  <!-- MÃ¼hÃ¼r ve Masraf Grid -->
  <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-top: 20px;">
    
    <!-- MÃ¼hÃ¼r No ve MRN NO -->
    <div class="expense-card">
      <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ”’ MÃ¼hÃ¼r No & ğŸ“‹ MRN NO</h3>
      
      <!-- MÃ¼hÃ¼r SeÃ§imi -->
      <form id="seal-form" action="/loads/position/<%= encodeURIComponent(positionNo) %>/seal" method="POST" style="display: flex; gap: 6px; margin-bottom: 12px;">
        <input type="hidden" name="confirm_mark_seal_used" id="confirm_mark_seal_used" value="0" />
        <select name="seal_code" style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 6px 8px; color: #e5e7eb; font-size: 13px; flex: 1;">
          <option value="">MÃ¼hÃ¼r SeÃ§iniz...</option>
          <% if (seals && seals.length) { %>
            <% seals.forEach(function (seal) { %>
              <option value="<%= seal.code %>" <%= (loads[0].seal_code === seal.code) ? 'selected' : '' %>>
                <%= seal.code %>
              </option>
            <% }) %>
          <% } %>
        </select>
        <button type="submit" class="btn" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 13px;">
          Kaydet
        </button>
      </form>
      <!-- Confirmation modal for consuming a seal -->
      <div id="seal-confirm-modal" style="display:none; position:fixed; inset:0; z-index:1200; align-items:center; justify-content:center;">
        <div id="seal-confirm-backdrop" style="position:absolute; inset:0; background:rgba(2,6,23,0.6);"></div>
        <div style="position:relative; z-index:1201; width:420px; max-width:90%; background:#0b1220; border-radius:10px; padding:20px; box-shadow:0 8px 30px rgba(2,6,23,0.6); color:#e5e7eb; font-size:14px;">
          <h3 style="margin:0 0 8px 0; font-size:16px;">MÃ¼hÃ¼r OnayÄ±</h3>
          <p id="seal-confirm-text" style="margin:0 0 16px 0; color:#cbd5e1; font-size:13px;">SeÃ§ilen mÃ¼hÃ¼r sistemden silinecek ve bu pozisyonda kullanÄ±lacaktÄ±r. OnaylÄ±yor musunuz?</p>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="seal-confirm-cancel" class="btn btn-outline" style="background:transparent; color:#e5e7eb; border:1px solid #2b3948; padding:6px 10px;">Ä°ptal</button>
            <button id="seal-confirm-ok" class="btn" style="background:#ef4444; color:white; padding:6px 10px;">Tamam</button>
          </div>
        </div>
      </div>
      
      <% if (loads[0].seal_code) { %>
        <div style="margin-bottom: 12px; padding: 6px 8px; background: #020617; border: 1px solid #1f2937; border-radius: 6px; font-size: 11px; color: #22c55e;">
          âœ“ MÃ¼hÃ¼r: <strong><%= loads[0].seal_code %></strong>
        </div>
      <% } %>

      <!-- MRN NO Ekle -->
      <div style="display: flex; gap: 6px; margin-bottom: 8px;">
        <input 
          type="text" 
          id="mrn-input" 
          placeholder="MRN numarasÄ±"
          style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 6px 8px; color: #e5e7eb; font-size: 13px; flex: 1;"
        />
        <button 
          onclick="addMrnNo()"
          class="btn" 
          style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 13px;"
        >
          Ekle
        </button>
      </div>
      
      <div id="mrn-list" style="display: flex; flex-direction: column; gap: 4px; max-height: 120px; overflow-y: auto;">
        <% 
        const mrnList = loads[0].mrn_no ? loads[0].mrn_no.split(',').map(m => m.trim()).filter(m => m) : [];
        mrnList.forEach(function(mrn) { %>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; background: #020617; border: 1px solid #1f2937; border-radius: 6px; font-size: 10px;">
            <span style="color: #22c55e;">âœ“ <%= mrn %></span>
            <button 
              onclick="deleteMrnNo('<%= mrn %>')"
              style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 0 4px;"
              title="Sil"
            >Ã—</button>
          </div>
        <% }); %>
      </div>
    </div>

    <!-- Masraf Ekle -->
    <div class="expense-card">
      <h3 style="font-size: 16px; margin-bottom: 12px;">â• Masraf Ekle</h3>
      <form method="POST" action="/loads/position/<%= encodeURIComponent(positionNo) %>/expenses" style="display: flex; flex-direction: column; gap: 6px;">
        <select name="expense_type" required style="background: #020617; border: 1px solid #1f2937; border-radius: 4px; padding: 6px 8px; color: #e5e7eb; font-size: 13px;">
          <option value="turk_transport">TURK TRANSPORT</option>
          <option value="diger_masraflar">DÄ°ÄER MASRAFLAR</option>
        </select>
        
        <input type="number" step="0.01" name="cost_amount" required placeholder="Tutar" style="background: #020617; border: 1px solid #1f2937; border-radius: 4px; padding: 6px 8px; color: #e5e7eb; font-size: 13px;">
        
        <input type="text" name="notes" placeholder="Not (opsiyonel)" style="background: #020617; border: 1px solid #1f2937; border-radius: 4px; padding: 6px 8px; color: #e5e7eb; font-size: 13px;">
        
        <button type="submit" class="btn" style="padding: 6px 12px; font-size: 13px; width: 100%;">Ekle</button>
      </form>
    </div>

    <!-- Masraf DetaylarÄ± -->
    <div class="expense-card">
      <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ“‹ Masraf DetaylarÄ± (<%= expenses ? expenses.length : 0 %>)</h3>
      <% if (expenses && expenses.length > 0) { %>
        <div style="display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto;">
          <% expenses.forEach(function(exp) { 
            let dateStr = '';
            if (exp.created_at) {
              const date = new Date(exp.created_at);
              dateStr = date.toLocaleDateString('tr-TR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }
          %>
            <div style="background: #020617; border: 1px solid #1f2937; border-radius: 4px; padding: 5px 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
              <div style="display: flex; flex-direction: column; gap: 2px; flex: 1;">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span style="font-weight: 600; color: #60a5fa; font-size: 13px;">
                    <%= exp.expense_type === 'turk_transport' ? 'TURK TRANSPORT' : 'DÄ°ÄER MASRAFLAR' %>
                  </span>
                  <span style="color: #f9fafb; font-weight: 600;">
                    <%= exp.cost_amount %> <%= exp.expense_type === 'diger_masraflar' ? 'TL' : 'GBP' %>
                  </span>
                </div>
                <div style="display: flex; gap: 8px; font-size: 13px;">
                  <% if (dateStr) { %>
                    <span style="color: #6b7280;"><%= dateStr %></span>
                  <% } %>
                  <% if (exp.notes) { %>
                    <span style="color: #9ca3af;"><%= exp.notes %></span>
                  <% } %>
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-danger" 
                style="padding: 2px 8px; font-size: 13px;"
                onclick="openDeleteExpenseModal('<%= exp.id %>', '<%= exp.expense_type %>', '<%= exp.cost_amount %>')"
              >
                Sil
              </button>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div style="padding: 12px; text-align: center; color: #6b7280; font-size: 13px;">
          HenÃ¼z masraf eklenmemiÅŸ
        </div>
      <% } %>
    </div>

    <!-- Masraf Ã–zeti -->
    <div class="expense-card">
      <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ’° Masraf Ã–zeti</h3>
      <% if (expenses && expenses.length > 0) { 
        let turkTotal = 0, digerTotal = 0;
        expenses.forEach(exp => {
          if (exp.expense_type === 'turk_transport') turkTotal += parseFloat(exp.cost_amount) || 0;
          if (exp.expense_type === 'diger_masraflar') digerTotal += parseFloat(exp.cost_amount) || 0;
        });
        // EUR hesaplama
        const turkEUR = turkTotal * (rates.GBP / rates.EUR);
        const digerEUR = digerTotal / rates.EUR;
        const totalEUR = turkEUR + digerEUR;
      %>
        <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px;">
          <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: #020617; border-radius: 4px;">
            <span style="color: #9ca3af;">TURK TRANSPORT:</span>
            <strong style="color: #60a5fa;"><%= turkTotal.toFixed(2) %> GBP</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: #020617; border-radius: 4px;">
            <span style="color: #9ca3af;">DÄ°ÄER MASRAFLAR:</span>
            <strong style="color: #f59e0b;"><%= digerTotal.toFixed(2) %> TL</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: #1e293b; border-radius: 4px; margin-top: 4px;">
            <span style="color: #f9fafb; font-weight: 600;">Toplam KayÄ±t:</span>
            <strong style="color: #22c55e;"><%= expenses.length %></strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: #1e293b; border-radius: 4px;">
            <span style="color: #f9fafb; font-weight: 600;">EUR DeÄŸeri:</span>
            <strong style="color: #818cf8;"><%= totalEUR.toFixed(2) %> EUR</strong>
          </div>
        </div>
      <% } else { %>
        <div style="padding: 12px; text-align: center; color: #6b7280; font-size: 13px;">
          HenÃ¼z masraf eklenmemiÅŸ
        </div>
      <% } %>
    </div>

    <!-- Evrak YÃ¼kleme -->
    <div class="expense-card">
      <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ“„ Evraklar</h3>
      <div 
        id="dropZone"
        style="background: #020617; border: 2px dashed #374151; border-radius: 6px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;"
        onclick="openDocumentModal()"
      >
        <div style="color: #9ca3af; font-size: 13px; margin-bottom: 4px;">ğŸ“ Dosya SeÃ§ veya SÃ¼rÃ¼kle</div>
        <div style="color: #6b7280; font-size: 13px;">PDF, JPG, PNG, DOC, DOCX</div>
      </div>
      
      <!-- Evrak klasÃ¶rleri yatay -->
      <div style="display: flex; gap: 6px;">
        <div class="doc-folder" data-category="Evraklar" onclick="showDocumentsInFolder('Evraklar')" style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 8px; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1;">
          <div style="font-size: 16px; margin-bottom: 2px;">ğŸ“„</div>
          <div style="font-size: 13px; color: #e5e7eb; font-weight: 500;">Evraklar</div>
          <div class="doc-count" style="font-size: 13px; color: #6b7280; margin-top: 1px;">
            <%= documents ? documents.filter(d => d.category === 'Evraklar').length : 0 %>
          </div>
          <div style="margin-top:6px;">
            <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/files?category=Evraklar" target="_blank" onclick="event.stopPropagation();" class="btn btn-sm" style="padding:4px 8px; font-size:13px; margin-top:6px;">KlasÃ¶rÃ¼ AÃ§</a>
          </div>
        </div>
        <div class="doc-folder" data-category="CMR" onclick="showDocumentsInFolder('CMR')" style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 8px; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1;">
          <div style="font-size: 16px; margin-bottom: 2px;">ğŸš›</div>
          <div style="font-size: 13px; color: #e5e7eb; font-weight: 500;">Teslim CMR</div>
          <div class="doc-count" style="font-size: 13px; color: #6b7280; margin-top: 1px;">
            <%= documents ? documents.filter(d => d.category === 'CMR').length : 0 %>
          </div>
          <div style="margin-top:6px;">
            <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/files?category=CMR" target="_blank" onclick="event.stopPropagation();" class="btn btn-sm" style="padding:4px 8px; font-size:13px; margin-top:6px;">KlasÃ¶rÃ¼ AÃ§</a>
          </div>
        </div>
        <div class="doc-folder" data-category="Navlun" onclick="showDocumentsInFolder('Navlun')" style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 8px; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1;">
          <div style="font-size: 16px; margin-bottom: 2px;">ğŸ’°</div>
          <div style="font-size: 13px; color: #e5e7eb; font-weight: 500;">Navlun</div>
          <div class="doc-count" style="font-size: 13px; color: #6b7280; margin-top: 1px;">
            <%= documents ? documents.filter(d => d.category === 'Navlun').length : 0 %>
          </div>
          <div style="margin-top:6px;">
            <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/files?category=Navlun" target="_blank" onclick="event.stopPropagation();" class="btn btn-sm" style="padding:4px 8px; font-size:13px; margin-top:6px;">KlasÃ¶rÃ¼ AÃ§</a>
          </div>
        </div>
        <div class="doc-folder" data-category="T1/GMR" onclick="showDocumentsInFolder('T1/GMR')" style="background: #020617; border: 1px solid #1f2937; border-radius: 6px; padding: 8px; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1;">
          <div style="font-size: 16px; margin-bottom: 2px;">ğŸ“‹</div>
          <div style="font-size: 13px; color: #e5e7eb; font-weight: 500;">T1/GMR/CMR</div>
          <div class="doc-count" style="font-size: 9px; color: #6b7280; margin-top: 1px;">
            <%= documents ? documents.filter(d => d.category === 'T1/GMR').length : 0 %>
          </div>
          <div style="margin-top:6px;">
            <a href="/loads/position/<%= encodeURIComponent(positionNo) %>/files?category=T1%2FGMR" target="_blank" onclick="event.stopPropagation();" class="btn btn-sm" style="padding:4px 8px; font-size:13px; margin-top:6px;">KlasÃ¶rÃ¼ AÃ§</a>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      .doc-folder:hover {
        background: #1f2937 !important;
        border-color: #3b82f6 !important;
        transform: translateY(-2px);
      }
    </style>

  </div>

  <!-- Modal for Complete -->
  <div id="completeModal" class="modal-overlay" onclick="if(event.target === this) hideModal('completeModal');">
    <div class="modal-content" style="max-width:420px; padding:18px; background: linear-gradient(180deg,#071126,#0b1220); color:#e6eef6; border-radius:12px; box-shadow:0 18px 50px rgba(2,6,23,0.6); border:1px solid rgba(148,163,184,0.06);">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="width:36px; height:36px; border-radius:999px; background:#10b981; color:white; display:flex; align-items:center; justify-content:center; font-weight:700;">âœ“</div>
        <div style="font-size:15px; font-weight:700;">Pozisyon KaydÄ±nÄ± Tamamla</div>
      </div>
      <div class="modal-body" style="font-size:14px; color:#cbd5e1; margin-bottom:14px;">
        Pozisyon kaydedilecek ve bitmiÅŸ olarak iÅŸaretlenecektir. Emin misiniz?
      </div>
      <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('completeModal')" style="background:transparent; border:1px solid rgba(148,163,184,0.08); color:#cbd5e1; padding:8px 12px; border-radius:8px;">Ä°ptal</button>
        <form action="/loads/position/<%= encodeURIComponent(positionNo) %>/complete" method="POST" style="display: inline;">
          <button type="submit" class="modal-btn modal-btn-confirm" style="background:#10b981; color:white; padding:8px 12px; border-radius:8px; border:0;">Tamam</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Reopen -->
  <div id="reopenModal" class="modal-overlay" onclick="if(event.target === this) hideModal('reopenModal');">
    <div class="modal-content">
      <div class="modal-header">Pozisyon KaydÄ±nÄ± Geri Ã‡ek</div>
      <div class="modal-body">
        Pozisyon kaydÄ± tekrar aktif hale getirilecektir. Emin misiniz?
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('reopenModal')">Ä°ptal</button>
        <form action="/loads/position/<%= encodeURIComponent(positionNo) %>/reopen" method="POST" style="display: inline;">
          <button type="submit" class="modal-btn modal-btn-warning">Tamam</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Mark No Expense -->
  <div id="markNoExpenseModal" class="modal-overlay" onclick="if(event.target === this) hideModal('markNoExpenseModal');">
    <div class="modal-content" style="max-width:420px; padding:18px; background: linear-gradient(180deg,#071126,#0b1220); color:#e6eef6; border-radius:12px; box-shadow:0 18px 50px rgba(2,6,23,0.6); border:1px solid rgba(148,163,184,0.06);">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="width:36px; height:36px; border-radius:999px; background:#ef4444; color:white; display:flex; align-items:center; justify-content:center; font-weight:700;">Ã—</div>
        <div style="font-size:15px; font-weight:700;">Masraf Yok Ä°ÅŸaretle</div>
      </div>
      <div class="modal-body" style="font-size:14px; color:#cbd5e1; margin-bottom:14px;">
        Bu pozisyon "Masraf Yok" olarak iÅŸaretlenecektir. Emin misiniz?
      </div>
      <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('markNoExpenseModal')" style="background:transparent; border:1px solid rgba(148,163,184,0.08); color:#cbd5e1; padding:8px 12px; border-radius:8px;">Ä°ptal</button>
        <form action="/loads/position/<%= encodeURIComponent(positionNo) %>/mark-no-expense" method="POST" style="display: inline;">
          <button type="submit" class="modal-btn" style="background: #ef4444; color: white; padding:8px 12px; border-radius:8px; border:0;">Tamam</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Unmark No Expense -->
  <div id="unmarkNoExpenseModal" class="modal-overlay" onclick="if(event.target === this) hideModal('unmarkNoExpenseModal');">
    <div class="modal-content" style="max-width:420px; padding:18px; background: linear-gradient(180deg,#071126,#0b1220); color:#e6eef6; border-radius:12px; box-shadow:0 18px 50px rgba(2,6,23,0.6); border:1px solid rgba(148,163,184,0.06);">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="width:36px; height:36px; border-radius:999px; background:#10b981; color:white; display:flex; align-items:center; justify-content:center; font-weight:700;">âœ“</div>
        <div style="font-size:15px; font-weight:700;">Masraf Yok Ä°ÅŸaretini KaldÄ±r</div>
      </div>
      <div class="modal-body" style="font-size:14px; color:#cbd5e1; margin-bottom:14px;">
        Masraf Yok iÅŸareti kaldÄ±rÄ±lacaktÄ±r. Emin misiniz?
      </div>
      <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('unmarkNoExpenseModal')" style="background:transparent; border:1px solid rgba(148,163,184,0.08); color:#cbd5e1; padding:8px 12px; border-radius:8px;">Ä°ptal</button>
        <form action="/loads/position/<%= encodeURIComponent(positionNo) %>/unmark-no-expense" method="POST" style="display: inline;">
          <button type="submit" class="modal-btn modal-btn-confirm" style="background:#10b981; color:white; padding:8px 12px; border-radius:8px; border:0;">Tamam</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Expense -->
  <div id="deleteExpenseModal" class="modal-overlay" onclick="if(event.target === this) hideModal('deleteExpenseModal');">
    <div class="modal-content">
      <div class="modal-header">MasrafÄ± Sil</div>
      <div class="modal-body">
        <div id="deleteExpenseInfo" style="margin-bottom: 12px; padding: 10px; background: #020617; border-radius: 6px; border: 1px solid #1f2937;">
          <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">Silinecek Masraf:</div>
          <div style="font-size: 14px; font-weight: 600; color: #f9fafb;"></div>
        </div>
        <div style="color: #cbd5e1;">Bu masrafÄ± silmek istediÄŸinizden emin misiniz?</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('deleteExpenseModal')">Ä°ptal</button>
        <button id="deleteExpenseConfirmBtn" class="modal-btn" style="background: #ef4444; color: white;" onclick="deleteExpenseConfirmed()">Sil</button>
      </div>
    </div>
  </div>

  <!-- Modal for Document Upload -->
  <div id="documentUploadModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) hideDocumentModal();">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">Evrak YÃ¼kle</div>
      <div class="modal-body">
        <div id="selectedFilesInfo" style="margin-bottom: 12px; padding: 10px; background: #020617; border-radius: 6px; border: 1px solid #1f2937; font-size: 12px; color: #9ca3af;">
          Dosya seÃ§ilmedi
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 12px; color: #9ca3af; margin-bottom: 6px;">Kategori SeÃ§in:</label>
          <select id="categorySelect" style="width: 100%; padding: 8px; background: #020617; border: 1px solid #1f2937; border-radius: 6px; color: #e5e7eb; font-size: 13px;">
            <option value="Evraklar">ğŸ“„ Evraklar</option>
            <option value="CMR">ğŸš› CMR</option>
            <option value="Navlun">ğŸ’° Navlun</option>
            <option value="T1/GMR">ğŸ“‹ T1/GMR</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideDocumentModal()">Ä°ptal</button>
        <button class="modal-btn modal-btn-confirm" onclick="submitDocuments()">YÃ¼kle</button>
      </div>
    </div>
  </div>

  <!-- Modal for Document List -->
  <div id="documentListModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) hideDocumentListModal();">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div id="modalCategoryTitle"></div>
        <button onclick="hideDocumentListModal()" style="background: transparent; border: none; color: #9ca3af; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
      </div>
      <div class="modal-body">
        <div id="documentListContent" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
          <!-- Document list will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Document -->
  <div id="deleteDocumentModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) { this.style.display = 'none'; }">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">EvraÄŸÄ± Sil</div>
      <div class="modal-body">
        <div style="padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—‘ï¸</div>
          <div style="color: #f9fafb; font-size: 16px; font-weight: 500; margin-bottom: 8px;">
            Bu evraÄŸÄ± silmek istediÄŸinizden emin misiniz?
          </div>
          <div style="color: #9ca3af; font-size: 13px;">
            Bu iÅŸlem geri alÄ±namaz.
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('deleteDocumentModal').style.display='none'">Ä°ptal</button>
        <form id="deleteDocumentForm" style="display: inline;">
          <button type="submit" class="modal-btn" style="background: #ef4444; color: white;">Sil</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Load -->
  <div id="deleteLoadModal" class="modal-overlay" onclick="if(event.target === this) hideModal('deleteLoadModal');">
    <div class="modal-content">
      <div class="modal-header">YÃ¼kleme KaydÄ±nÄ± Sil</div>
      <div class="modal-body">
        <div id="deleteLoadInfo" style="margin-bottom: 12px; padding: 10px; background: #020617; border-radius: 6px; border: 1px solid #1f2937;">
          <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px;">
            <div>
              <span style="color: #9ca3af;">GÃ¶nderici:</span>
              <span id="deleteLoadSender" style="color: #f9fafb; font-weight: 600; margin-left: 8px;"></span>
            </div>
            <div>
              <span style="color: #9ca3af;">AlÄ±cÄ±:</span>
              <span id="deleteLoadConsignee" style="color: #f9fafb; font-weight: 600; margin-left: 8px;"></span>
            </div>
          </div>
            <script>
              (function(){
                const form = document.getElementById('seal-form');
                if (!form) return;
                const select = form.querySelector('select[name="seal_code"]');
                const hidden = document.getElementById('confirm_mark_seal_used');
                const modal = document.getElementById('seal-confirm-modal');
                const modalText = document.getElementById('seal-confirm-text');
                const btnOk = document.getElementById('seal-confirm-ok');
                const btnCancel = document.getElementById('seal-confirm-cancel');

                function showModal(text) {
                  if (modalText) modalText.textContent = text;
                  modal.style.display = 'flex';
                  document.body.style.overflow = 'hidden';
                }
                function hideModal() {
                  modal.style.display = 'none';
                  document.body.style.overflow = '';
                }

                form.addEventListener('submit', function(e){
                  const val = select ? select.value : '';
                  if (!val) return true; // no seal chosen â€” normal submit (or validation elsewhere)
                  if (hidden && (hidden.value === '1' || hidden.value === 'true')) return true; // already confirmed

                  e.preventDefault();
                  showModal('SeÃ§ilen mÃ¼hÃ¼r "' + val + '" sistemden silinecek ve bu pozisyonda kullanÄ±lacaktÄ±r. Devam etmek istiyor musunuz?');
                });

                btnCancel && btnCancel.addEventListener('click', function(){ hideModal(); });
                btnOk && btnOk.addEventListener('click', function(){
                  if (hidden) hidden.value = '1';
                  hideModal();
                  // submit the form programmatically
                  setTimeout(function(){ form.submit(); }, 50);
                });
              })();
            </script>
        </div>
        <div style="color: #cbd5e1;">Bu yÃ¼kleme kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('deleteLoadModal')">Ä°ptal</button>
        <button id="deleteLoadConfirmBtn" class="modal-btn" style="background: #ef4444; color: white;" onclick="deleteLoadConfirmed()">Sil</button>
      </div>
    </div>
  </div>

  <!-- Modal for Distance Calculator -->
  <div id="distanceCalculatorModal" class="modal-overlay" onclick="if(event.target === this) hideDistanceModal();">
    <div class="km-modal-content">
      <!-- Left Panel - Controls -->
      <div class="km-left-panel">
        <div class="km-header">
          <div class="km-title">
            <div class="km-icon">ğŸš›</div>
            <div>
              <h2>AraÃ§ KM Hesaplama</h2>
              <span class="km-subtitle">Mesafe ve mazot hesaplama aracÄ±</span>
            </div>
          </div>
          <button onclick="hideDistanceModal()" class="km-close-btn">Ã—</button>
        </div>

        <div class="km-form-section">
          <div class="km-input-group">
            <label>BaÅŸlangÄ±Ã§ Posta Kodu / Adres</label>
            <div class="km-input-wrapper">
              <span class="km-input-icon">ğŸ“</span>
              <input id="modal-postcode-from" type="text" placeholder="Posta Kodu ya da Adres Giriniz" autocomplete="off" />
            </div>
            <div id="modal-postcode-from-suggestions" class="km-suggestions"></div>
          </div>

          <div class="km-input-group">
            <label>BitiÅŸ Posta Kodu / Adres</label>
            <div class="km-input-wrapper">
              <span class="km-input-icon">ğŸ</span>
              <input id="modal-postcode-to" type="text" placeholder="Posta Kodu ya da Adres Giriniz" autocomplete="off" />
            </div>
            <div id="modal-postcode-to-suggestions" class="km-suggestions"></div>
          </div>

          <div class="km-row">
            <div class="km-input-group" style="flex:1;">
              <label>Segment Tipi</label>
              <div id="modal-segment-type-display" class="km-select" tabindex="0">
                <span id="modal-segment-type-value">ğŸ”µ YÃ¼kleme</span>
                <span class="km-select-arrow">â–¾</span>
              </div>
              <input type="hidden" id="modal-segment-type" value="loading" />
              <div id="modal-segment-type-list" class="km-select-dropdown">
                <div class="km-select-item" data-value="loading">ğŸ”µ YÃ¼kleme</div>
                <div class="km-select-item" data-value="unloading">ğŸŸ¢ BoÅŸaltma</div>
                <div class="km-select-item" data-value="exit">ğŸ”¶ Ã‡Ä±kÄ±ÅŸ</div>
                <div class="km-select-item" data-value="europe">ğŸ‡ªğŸ‡º Avrupa</div>
              </div>
            </div>
            <button onclick="calculateModalDistance()" class="km-calc-btn">
              <span>âš¡</span> Hesapla
            </button>
          </div>
        </div>

        <div id="distance-list" class="km-results-section" style="display:none;">
          <div class="km-results-header">
            <span class="km-results-icon">ğŸ“Š</span>
            <span>HESAPLANAN MESAFELER</span>
          </div>
          <div id="distance-items" class="km-distance-items"></div>
        </div>

        <div id="herstal-container" class="km-herstal-section">
          <label class="km-checkbox-label">
            <input id="herstal-checkbox" type="checkbox" />
            <span class="km-checkbox-custom"></span>
            <span>Ä°ngiltere Ã‡Ä±kÄ±ÅŸ Mazot HesabÄ±</span>
          </label>

          <div id="herstal-panel" class="km-herstal-panel" style="display:none;">
            <div class="km-herstal-title">ğŸ‡¬ğŸ‡§ Ä°NGÄ°LTERE Ã‡IKIÅ MAZOT HESABI</div>
            <div class="km-herstal-rows">
              <div class="km-herstal-row"><span>DOVER-DOVER</span><span id="herstal-original" class="km-val-green">-</span></div>
              <div class="km-herstal-row"><span>DD + HERSTAL</span><span id="herstal-step1" class="km-val-blue">-</span></div>
              <div class="km-herstal-row"><span>TOPLAM + EXTRA</span><span id="herstal-step2" class="km-val-blue">-</span></div>
              <div class="km-herstal-row"><span>HARCANAN MAZOT</span><span id="herstal-step3" class="km-val-blue">-</span></div>
              <div class="km-herstal-row km-herstal-final"><span>KALAN MAZOT</span><span id="herstal-final" class="km-val-orange">-</span></div>
              <div class="km-herstal-row km-herstal-extra"><span>HERSTAL MAZOT</span><span id="herstal-mazot" class="km-val-purple">-</span></div>
              <div class="km-herstal-row km-herstal-extra"><span>MACAR</span><span id="herstal-macar" class="km-val-purple">-</span></div>
            </div>
          </div>
        </div>

        <div id="avrupa-container" class="km-herstal-section" style="margin-top: 12px;">
          <label class="km-checkbox-label">
            <input id="avrupa-checkbox" type="checkbox" />
            <span class="km-checkbox-custom"></span>
            <span>Avrupa Mazot HesabÄ±</span>
          </label>

          <div id="avrupa-panel" class="km-herstal-panel" style="display:none;">
            <div class="km-herstal-title avrupa-title">ğŸ‡ªğŸ‡º AVRUPA MAZOT HESABI</div>
            <div class="km-herstal-rows">
              <div class="km-herstal-row"><span>Toplam Mesafe</span><span id="avrupa-total" class="km-val-green">-</span></div>
              <div class="km-herstal-row"><span>Son Nokta â†’ Macaristan</span><span id="avrupa-macar-km" class="km-val-blue">-</span></div>
              <div class="km-herstal-row"><span>Macaristan Ekleme</span><span id="avrupa-extra" class="km-val-blue">+ 1400 km</span></div>
              <div class="km-herstal-row km-herstal-final"><span>TOPLAM KM</span><span id="avrupa-final" class="km-val-orange">-</span></div>
              <div class="km-herstal-row"><span>HARCANAN MAZOT (x 0.3)</span><span id="avrupa-mazot-used" class="km-val-blue">-</span></div>
              <div class="km-herstal-row km-herstal-extra" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 8px; padding: 10px;"><span id="avrupa-kalan-label" style="color:#fff; font-weight:600;">KALAN MAZOT</span><span id="avrupa-mazot-result" style="color:#fff !important; font-weight:800; font-size:16px;">-</span></div>
              <div class="km-herstal-row km-herstal-extra" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); border-radius: 8px; padding: 10px; margin-top: 8px;"><span style="color:#fff; font-weight:600;">MACAR</span><span id="avrupa-macar-result" style="color:#ffffff !important; font-weight:800; font-size:18px; text-shadow: 0 0 10px rgba(255,255,255,0.5);">-</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Map & Result -->
      <div class="km-right-panel">
        <div class="km-map-header">Harita & Ã–zet</div>
        <div id="distance-map" class="km-map-container">
          <div class="km-map-placeholder">
            <div class="km-map-icon">ğŸ—ºï¸</div>
            <div>Mesafe hesaplandÄ±ÄŸÄ±nda rota burada gÃ¶sterilecektir</div>
          </div>
        </div>

        <div class="km-bottom-section">
          <div id="modal-distance-result" class="km-total-result" style="display:none;">
            <div class="km-total-label">TOPLAM MESAFE</div>
            <div id="modal-distance-value" class="km-total-value"></div>
          </div>

          <div class="km-action-buttons">
            <button id="save-distance-btn" onclick="saveDistanceCalculation()" class="km-btn km-btn-save">
              <span>ğŸ’¾</span> Kaydet
            </button>
            <button id="export-pdf-btn" onclick="exportKmPdf()" class="km-btn km-btn-pdf">
              <span>ğŸ“„</span> PDF Olarak DÄ±ÅŸa Aktar
            </button>
            <button id="close-distance-btn" onclick="hideDistanceModal()" class="km-btn km-btn-close">Kapat</button>
          </div>
        </div>
      </div>

      <style>
        .km-modal-content {
          max-width: 1400px; width: 96%; height: 90vh; 
          display: grid; grid-template-columns: 580px 1fr; gap: 0;
          background: #0a0f1a; border-radius: 20px; overflow: hidden;
          box-shadow: 0 25px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05);
        }
        .km-left-panel {
          background: linear-gradient(180deg, #0d1525 0%, #0a0f1a 100%);
          padding: 24px; display: flex; flex-direction: column; gap: 20px;
          overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.06);
        }
        .km-right-panel {
          background: linear-gradient(180deg, #080d16 0%, #0a0f1a 100%);
          padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }
        .km-header { display: flex; justify-content: space-between; align-items: center; }
        .km-title { display: flex; align-items: center; gap: 14px; }
        .km-icon { font-size: 36px; filter: drop-shadow(0 4px 12px rgba(59,130,246,0.3)); }
        .km-title h2 { margin: 0; font-size: 20px; font-weight: 700; color: #f1f5f9; }
        .km-subtitle { font-size: 12px; color: #64748b; }
        .km-close-btn {
          width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
          background: rgba(255,255,255,0.03); color: #94a3b8; font-size: 22px;
          cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .km-close-btn:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }

        .km-form-section {
          background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
          border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 16px;
        }
        .km-input-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .km-input-group label { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .km-input-wrapper {
          display: flex; align-items: center; gap: 10px;
          background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
          border-radius: 12px; padding: 0 14px; transition: all 0.2s;
        }
        .km-input-wrapper:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
        .km-input-icon { font-size: 16px; opacity: 0.7; }
        .km-input-wrapper input {
          flex: 1; background: transparent; border: none; padding: 14px 0;
          color: #e2e8f0; font-size: 14px; outline: none;
        }
        .km-input-wrapper input::placeholder { color: #475569; }
        .km-suggestions {
          display: none; position: absolute; left: 0; right: 0; top: 100%; margin-top: 6px;
          background: #111827; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
          max-height: 200px; overflow: auto; z-index: 100; padding: 6px;
        }

        .km-row { display: flex; gap: 12px; align-items: flex-end; }
        .km-select {
          background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
          border-radius: 12px; padding: 14px; color: #e2e8f0; font-size: 14px;
          display: flex; justify-content: space-between; align-items: center; cursor: pointer;
          transition: all 0.2s;
        }
        .km-select:hover { border-color: rgba(255,255,255,0.15); }
        .km-select-arrow { opacity: 0.5; font-size: 12px; }
        .km-select-dropdown {
          display: none; position: absolute; left: 0; right: 0; top: 100%; margin-top: 6px;
          background: #111827; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
          padding: 6px; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .km-select-item {
          padding: 12px 14px; border-radius: 8px; cursor: pointer; transition: all 0.15s;
          color: #cbd5e1; font-size: 14px;
        }
        .km-select-item:hover { background: rgba(59,130,246,0.15); color: #fff; }

        .km-calc-btn {
          background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white;
          border: none; border-radius: 12px; padding: 14px 24px; font-weight: 700;
          font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;
          transition: all 0.2s; box-shadow: 0 4px 20px rgba(59,130,246,0.3);
        }
        .km-calc-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(59,130,246,0.4); }

        .km-results-section { margin-top: 8px; }
        .km-results-header {
          display: flex; align-items: center; gap: 8px;
          font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 12px;
          text-transform: uppercase; letter-spacing: 0.5px;
        }
        .km-results-icon { font-size: 14px; }
        .km-distance-items { display: flex; flex-direction: column; gap: 6px; max-height: 35vh; overflow-y: auto; padding-right: 4px; }
        .km-distance-items::-webkit-scrollbar { width: 6px; }
        .km-distance-items::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 3px; }
        .km-distance-items::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .km-distance-items .segment-item {
          background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05);
          border-radius: 10px; padding: 10px 12px; font-size: 12px;
        }
        .km-distance-items .segment-item .segment-header {
          display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
        }
        .km-distance-items .segment-item .segment-title { color: #64748b; font-weight: 600; font-size: 11px; }
        .km-distance-items .segment-item .segment-km { color: #22c55e; font-weight: 700; font-size: 13px; }
        .km-distance-items .segment-item .segment-route {
          color: #94a3b8; font-size: 11px; line-height: 1.4;
          word-break: break-word; white-space: normal;
        }

        .km-herstal-section { margin-top: auto; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.05); }
        .km-checkbox-label {
          display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none;
          font-size: 13px; font-weight: 700; color: #e2e8f0;
        }
        .km-checkbox-label input { display: none; }
        .km-checkbox-custom {
          width: 20px; height: 20px; border: 2px solid #3b82f6; border-radius: 6px;
          display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .km-checkbox-label input:checked + .km-checkbox-custom {
          background: #3b82f6;
        }
        .km-checkbox-label input:checked + .km-checkbox-custom::after {
          content: 'âœ“'; color: white; font-size: 12px; font-weight: bold;
        }
        .km-herstal-panel {
          margin-top: 14px; padding: 16px; background: rgba(0,0,0,0.4);
          border: 1px solid rgba(255,255,255,0.06); border-radius: 14px;
        }
        .km-herstal-title { 
          font-size: 14px; 
          font-weight: 800; 
          color: #ffffff; 
          margin-bottom: 16px; 
          padding: 12px 16px; 
          border-radius: 10px; 
          background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          text-align: center;
          letter-spacing: 0.5px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .km-herstal-title.avrupa-title {
          background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        .km-herstal-rows { display: flex; flex-direction: column; gap: 10px; }
        .km-herstal-row {
          display: flex; justify-content: space-between; align-items: center;
          font-size: 13px; color: #94a3b8;
        }
        .km-herstal-final { margin-top: 8px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); }
        .km-herstal-extra { margin-top: 6px; padding-top: 8px; border-top: 1px dashed rgba(168,85,247,0.3); }
        .km-val-green { font-weight: 700; color: #22c55e; }
        .km-val-blue { font-weight: 700; color: #60a5fa; }
        .km-val-orange { font-weight: 800; color: #f59e0b; font-size: 18px; }
        .km-val-purple { font-weight: 700; color: #a855f7; font-size: 14px; }

        .km-map-header { font-size: 12px; color: #64748b; text-align: right; text-transform: uppercase; letter-spacing: 1px; }
        .km-map-container {
          flex: 1; background: linear-gradient(180deg, #0d1525, #080d16);
          border: 1px solid rgba(255,255,255,0.05); border-radius: 16px;
          display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .km-map-placeholder { text-align: center; color: #475569; }
        .km-map-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .km-map-placeholder > div:last-child { font-size: 13px; }

        .km-bottom-section { display: flex; gap: 16px; align-items: center; }
        .km-total-result {
          flex: 1; padding: 20px; border-radius: 14px;
          background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.05));
          border: 1px solid rgba(34,197,94,0.2);
        }
        .km-total-label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .km-total-value { font-size: 42px; font-weight: 900; color: #22c55e; font-family: 'JetBrains Mono', monospace; margin-top: 4px; }

        .km-action-buttons { display: flex; gap: 10px; flex-shrink: 0; }
        .km-btn {
          padding: 12px 18px; border-radius: 10px; font-weight: 600; font-size: 13px;
          cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; border: none;
        }
        .km-btn-save { background: linear-gradient(135deg, #16a34a, #22c55e); color: #052e16; }
        .km-btn-save:hover { box-shadow: 0 4px 20px rgba(34,197,94,0.4); }
        .km-btn-pdf { background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; }
        .km-btn-pdf:hover { box-shadow: 0 4px 20px rgba(59,130,246,0.4); }
        .km-btn-close { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; }
        .km-btn-close:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }

        @media (max-width: 1000px) {
          .km-modal-content { grid-template-columns: 1fr; height: auto; max-height: 95vh; }
          .km-left-panel { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); }
          .km-map-container { min-height: 300px; }
        }
      </style>
      <script>
        (function(){
          function initCustomSegmentSelect(){
            const display = document.getElementById('modal-segment-type-display');
            const list = document.getElementById('modal-segment-type-list');
            const input = document.getElementById('modal-segment-type');
            const valueSpan = document.getElementById('modal-segment-type-value');
            if (!display || !list || !input) return;

            function openList(){ list.style.display = 'block'; display.setAttribute('aria-expanded','true'); }
            function closeList(){ list.style.display = 'none'; display.setAttribute('aria-expanded','false'); }

            display.addEventListener('click', function(e){ e.stopPropagation(); if (list.style.display === 'block') { closeList(); } else { openList(); } });

            list.querySelectorAll('.km-select-item').forEach(function(item){
              item.addEventListener('click', function(e){ e.stopPropagation(); input.value = this.dataset.value || this.getAttribute('data-value'); if (valueSpan) valueSpan.textContent = this.textContent; closeList(); });
            });

            document.addEventListener('click', function(e){ if (!display.contains(e.target) && !list.contains(e.target)) { closeList(); } });

            display.addEventListener('keydown', function(e){ if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openList(); } if (e.key === 'Escape') { closeList(); } });
          }

          window.addEventListener('DOMContentLoaded', initCustomSegmentSelect);
        })();
      </script>
    </div>
  </div>

  <script>
    // Ã‡ekici seÃ§ilince ÅŸofÃ¶r adÄ±nÄ± otomatik doldur
    function updateDriverNameFromTruck() {
      const truckSelect = document.getElementById('truck_plate_select_pos');
      const driverInput = document.getElementById('driver_name_input_pos');
      const hiddenDriverInput = document.getElementById('hidden_driver_name');
      
      const selectedOption = truckSelect.options[truckSelect.selectedIndex];
      const driverName = selectedOption.getAttribute('data-driver') || '';
      
      if (driverName) {
        driverInput.value = driverName;
        if (hiddenDriverInput) {
          hiddenDriverInput.value = driverName;
        }
      }
    }

    // Kaydet butonuna basÄ±ldÄ±ÄŸÄ±nda select'i disable et (sÃ¶nÃ¼kleÅŸtir)
    function disableSelect(selectId) {
      setTimeout(() => {
        const selectElement = document.getElementById(selectId);
        if (selectElement) {
          selectElement.disabled = true;
          selectElement.style.opacity = '0.5';
          selectElement.style.cursor = 'not-allowed';
        }
      }, 50);
    }

    function showCompleteModal() {
      document.getElementById('completeModal').classList.add('active');
    }

    function showReopenModal() {
      document.getElementById('reopenModal').classList.add('active');
    }

    function showMarkNoExpenseModal() {
      document.getElementById('markNoExpenseModal').classList.add('active');
    }

    function showUnmarkNoExpenseModal() {
      document.getElementById('unmarkNoExpenseModal').classList.add('active');
    }

    function openDeleteExpenseModal(expenseId, expenseType, amount) {
      // store URL for JS-confirmed delete
      window.pendingDeleteExpenseUrl = '/loads/position/<%= encodeURIComponent(positionNo) %>/expenses/' + expenseId + '/delete';
      
      const typeName = expenseType === 'turk_transport' ? 'TURK TRANSPORT' : 'DÄ°ÄER MASRAFLAR';
      const currency = expenseType === 'diger_masraflar' ? 'TL' : 'GBP';
      const infoDiv = document.querySelector('#deleteExpenseInfo > div:last-child');
      infoDiv.innerHTML = typeName + ' - <span style="color: #60a5fa;">' + amount + ' ' + currency + '</span>';
      
      document.getElementById('deleteExpenseModal').classList.add('active');
    }

    function openDeleteLoadModal(loadId, customerName, consigneeName) {
      // store URL for JS-confirmed delete
      window.pendingDeleteLoadUrl = '/loads/' + loadId + '/delete';
      
      document.getElementById('deleteLoadSender').textContent = customerName || '-';
      document.getElementById('deleteLoadConsignee').textContent = consigneeName || '-';
      
      document.getElementById('deleteLoadModal').classList.add('active');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ESC tuÅŸu ile modal'Ä± kapat
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideModal('completeModal');
        hideModal('reopenModal');
        hideModal('markNoExpenseModal');
        hideModal('unmarkNoExpenseModal');
        hideModal('deleteExpenseModal');
        hideModal('deleteLoadModal');
        hideModal('distanceCalculatorModal');
      }
    });

    // Overlay'e tÄ±klanÄ±nca modal'Ä± kapat
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          hideModal(overlay.id);
        }
      });
    });

    // Confirmed delete via JS to avoid submitting surrounding forms accidentally
    async function deleteExpenseConfirmed() {
      const url = window.pendingDeleteExpenseUrl;
      if (!url) return;
      const btn = document.getElementById('deleteExpenseConfirmBtn');
      try {
        if (btn) btn.disabled = true;
        await fetch(url, { method: 'POST', credentials: 'same-origin' });
        window.location.reload();
      } catch (e) {
        console.error('Delete expense failed', e);
        if (btn) btn.disabled = false;
        alert('Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Konsolu kontrol edin.');
      }
    }

    async function deleteLoadConfirmed() {
      const url = window.pendingDeleteLoadUrl;
      if (!url) return;
      const btn = document.getElementById('deleteLoadConfirmBtn');
      try {
        if (btn) btn.disabled = true;
        await fetch(url, { method: 'POST', credentials: 'same-origin' });
        window.location.reload();
      } catch (e) {
        console.error('Delete load failed', e);
        if (btn) btn.disabled = false;
        alert('Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Konsolu kontrol edin.');
      }
    }

    // Specific hide function for distance modal to also cleanup the Leaflet map instance
    function hideDistanceModal() {
      const modal = document.getElementById('distanceCalculatorModal');
      if (modal) modal.classList.remove('active');
      try {
        if (window.distanceMap && typeof window.distanceMap.remove === 'function') {
          window.distanceMap.remove();
        }
      } catch (e) {
        console.warn('Error removing distance map', e);
      }
      window.distanceMap = null;
      window.distanceLayerGroup = null;
    }
  </script>

  <div class="loads-table-card" style="margin-top: 16px;">
    <% if (loads && loads.length > 0) { %>
      <table class="loads-table">
        <thead>
            <tr>
            <th>GÃ¶nderici AdÄ±</th>
            <th>AlÄ±cÄ± AdÄ±</th>
            <th>YÃ¼kleme Ãœkesi</th>
            <th>GÃ¼mrÃ¼k</th>
            <th>Antrepo</th>
            <th>Kap</th>
            <th>Kilo</th>
            <th>Malzeme Cinsi</th>
            <th>Fatura Kime</th>
            <th>Navlun TutarÄ±</th>
            <th>YDG TutarÄ±</th>
            <th>Ordino Bedeli (TL)</th>
            <th>Fatura No</th>
            <th>LDM</th>
            <th>REF</th>
            <th>UID</th>
            <th style="width: 120px;">Ä°ÅŸlemler</th>
          </tr>
        </thead>
        <tbody id="loadsTableBody">
          <% loads.forEach(function(load) { %>
            <tr data-load-id="<%= load.id %>">
              <td>
                <div style="position: relative;">
                  <input
                    type="text"
                    id="customer-input-<%= load.id %>"
                    class="inline-edit-input company-autocomplete"
                    data-field="customer_name"
                    data-load-id="<%= load.id %>"
                    data-allowed-types="sender,both"
                    value="<%= load.customer_name || '' %>"
                    placeholder="GÃ¶nderici seÃ§..."
                    autocomplete="off"
                  />
                  <div id="customer-sug-<%= load.id %>" class="autocomplete-suggestions" style="position: absolute; left: 0; right: 0; z-index: 50;
                    background: #0b1220; border: 1px solid #27323f; border-radius: 6px; max-height: 220px; overflow-y: auto; display: none; box-shadow: 0 8px 20px rgba(2,6,23,0.6);">
                  </div>
                </div>
              </td>

              <td>
                <div style="position: relative;">
                  <input
                    type="text"
                    id="consignee-input-<%= load.id %>"
                    class="inline-edit-input company-autocomplete"
                    data-field="consignee_name"
                    data-load-id="<%= load.id %>"
                    data-allowed-types="receiver,both"
                    value="<%= load.consignee_name || '' %>"
                    placeholder="AlÄ±cÄ± seÃ§..."
                    autocomplete="off"
                  />
                  <div id="consignee-sug-<%= load.id %>" class="autocomplete-suggestions" style="position: absolute; left: 0; right: 0; z-index: 50;
                    background: #0b1220; border: 1px solid #27323f; border-radius: 6px; max-height: 220px; overflow-y: auto; display: none; box-shadow: 0 8px 20px rgba(2,6,23,0.6);">
                  </div>
                </div>
              </td>

              <td>
                <input type="text" class="inline-edit-input" value="<%= [load.loading_city, load.loading_country].filter(Boolean).join(' / ') %>" 
                  onblur="updateLoadField(<%= load.id %>, 'loading_location', this.value)" 
                  placeholder="Åehir / Ãœlke">
              </td>

              <td>
                <input type="text" class="inline-edit-input" value="<%= load.unloading_country || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'unloading_country', this.value)" 
                  placeholder="GÃ¼mrÃ¼k">
              </td>

              <td>
                <input type="text" class="inline-edit-input" value="<%= load.unloading_city || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'unloading_city', this.value)" 
                  placeholder="Antrepo">
              </td>

              <td>
                <input type="number" class="inline-edit-input" style="width: 60px;" value="<%= load.packages || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'packages', this.value)" 
                  placeholder="Kap">
              </td>

              <td>
                <input type="number" class="inline-edit-input" style="width: 80px;" value="<%= load.gross_weight || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'gross_weight', this.value)" 
                  placeholder="Kilo">
              </td>

              <td>
                <input type="text" class="inline-edit-input" value="<%= load.goods_description || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'goods_description', this.value)" 
                  placeholder="Malzeme">
              </td>

              <td>
                <select class="inline-edit-select" onchange="updateLoadField(<%= load.id %>, 'fatura_kime', this.value)">
                  <option value="">-</option>
                  <% companies.filter(c => c.type === 'invoice' || c.type === 'both').forEach(function(company) { %>
                    <option value="<%= company.name %>" <%= load.fatura_kime === company.name ? 'selected' : '' %>><%= company.name %></option>
                  <% }); %>
                </select>
              </td>

              <td>
                <div style="display: flex; gap: 4px;">
                  <input type="number" class="inline-edit-input" style="width: 70px;" value="<%= load.navlun_amount || '' %>" 
                    onblur="updateLoadField(<%= load.id %>, 'navlun_amount', this.value)" 
                    placeholder="Tutar">
                  <select class="inline-edit-select" style="width: 60px;" onchange="updateLoadField(<%= load.id %>, 'navlun_currency', this.value)">
                    <option value="" <%= !load.navlun_currency ? 'selected' : '' %>>-</option>
                    <option value="EUR" <%= load.navlun_currency === 'EUR' ? 'selected' : '' %>>EUR</option>
                    <option value="GBP" <%= load.navlun_currency === 'GBP' ? 'selected' : '' %>>GBP</option>
                    <option value="USD" <%= load.navlun_currency === 'USD' ? 'selected' : '' %>>USD</option>
                    <option value="TRY" <%= load.navlun_currency === 'TRY' ? 'selected' : '' %>>TRY</option>
                  </select>
                </div>
              </td>

              <td>
                <input type="number" class="inline-edit-input" style="width: 80px;" value="<%= load.ydg_amount || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'ydg_amount', this.value)" 
                  placeholder="YDG (EUR)">
              </td>

              <td>
                <input type="number" class="inline-edit-input" style="width: 80px;" value="<%= load.ordino_cost || '' %>" 
                  onblur="updateLoadField(<%= load.id %>, 'ordino_cost', this.value)" 
                  placeholder="TL">
              </td>

              <td>
                <input type="text" class="inline-edit-input" style="width: 120px;" value="<%= load.fatura_no ? (String(load.fatura_no).startsWith('E-') ? load.fatura_no : ('E-' + load.fatura_no)) : '' %>"
                  onblur="updateLoadField(<%= load.id %>, 'fatura_no', this.value)"
                  placeholder="Fatura No">
              </td>

              <td>
                <input type="number" class="inline-edit-input" style="width: 80px;" value="<%= load.ldm || '' %>"
                  onblur="updateLoadField(<%= load.id %>, 'ldm', this.value)"
                  placeholder="LDM">
              </td>

              <td>
                <input type="text" class="inline-edit-input" style="width: 120px;" value="<%= load.ref || '' %>"
                  onblur="updateLoadField(<%= load.id %>, 'ref', this.value)"
                  placeholder="REF">
              </td>

              <td>
                <span class="uid-span" data-load-id="<%= load.id %>" data-has-uid="<%= load.uid ? '1' : '0' %>"><%= load.uid || '' %></span>
              </td>

              <td>
                <div class="loads-actions" onclick="event.stopPropagation();">
                  <button 
                    type="button"
                    class="btn btn-sm"
                    style="background: #3b82f6; color: white;"
                    data-load='<%- JSON.stringify(load) %>'
                    onclick="event.stopPropagation(); openMailModalForLoad(JSON.parse(this.getAttribute('data-load')), 'yukleme');"
                  >
                    YÃ¼kleme
                  </button>
                  <!-- Duplicate mail button (identical behavior, green) -->
                  <button 
                    type="button"
                    class="btn btn-sm"
                    style="background: #22c55e; color: white;"
                    data-load='<%- JSON.stringify(load) %>'
                    onclick="event.stopPropagation(); openMailModalForLoad(JSON.parse(this.getAttribute('data-load')), 'varis');"
                  >
                    VarÄ±ÅŸ
                  </button>
                  <button 
                    type="button"
                    class="btn btn-danger btn-sm"
                    data-load-id="<%= load.id %>"
                    data-customer-name="<%= (load.customer_name || '') %>"
                    data-consignee-name="<%= (load.consignee_name || '') %>"
                    onclick="event.stopPropagation(); const btn = event.currentTarget; openDeleteLoadModal(btn.dataset.loadId, btn.dataset.customerName, btn.dataset.consigneeName);"
                  >
                    Sil
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
      
      <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
        <button onclick="createEmptyLoad('<%= positionNo %>', this)" class="btn" id="btn-new-load" style="background: #10b981; color: white;">
          â• Yeni YÃ¼k
        </button>
      </div>
    <% } else { %>
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        Bu pozisyonda hiÃ§ yÃ¼kleme bulunamadÄ±.
      </div>
    <% } %>
  </div>
</div>

<script>
let currentMrnList = [];
let selectedFiles = [];

// Sayfa yÃ¼klenince mevcut MRN listesini al
window.addEventListener('DOMContentLoaded', function() {
  const mrnListDiv = document.getElementById('mrn-list');
  if (mrnListDiv) {
    const items = mrnListDiv.querySelectorAll('div');
    items.forEach(item => {
      const text = item.querySelector('span').textContent.replace('âœ“', '').trim();
      if (text) currentMrnList.push(text);
    });
  }
});

// Drag & Drop ve Multiple File Upload iÃ§in
const dropZone = document.getElementById('dropZone');
let hiddenFileInput;

function createHiddenFileInput() {
  if (!hiddenFileInput) {
    hiddenFileInput = document.createElement('input');
    hiddenFileInput.type = 'file';
    hiddenFileInput.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
    hiddenFileInput.multiple = true;
    hiddenFileInput.style.display = 'none';
    document.body.appendChild(hiddenFileInput);
    
    hiddenFileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        selectedFiles = Array.from(this.files);
        openDocumentModal();
      }
    });
  }
  return hiddenFileInput;
}

function openDocumentModal() {
  if (selectedFiles.length === 0) {
    createHiddenFileInput().click();
    return;
  }
  
  const modal = document.getElementById('documentUploadModal');
  const info = document.getElementById('selectedFilesInfo');
  info.textContent = selectedFiles.length + ' dosya seÃ§ildi: ' + selectedFiles.map(f => f.name).join(', ');
  modal.style.display = 'flex';
}

function hideDocumentModal() {
  document.getElementById('documentUploadModal').style.display = 'none';
  selectedFiles = [];
}

function submitDocuments() {
  const category = document.getElementById('categorySelect').value;
  const positionNo = '<%= positionNo %>';
  
  const formData = new FormData();
  selectedFiles.forEach(file => {
    formData.append('document', file);
  });
  formData.append('category', category);
  
  fetch('/loads/position/' + encodeURIComponent(positionNo) + '/upload-document', {
    method: 'POST',
    // include a header so server can detect AJAX requests
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
    body: formData
  })
  .then(res => {
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    // If server responded with JSON, parse it
    if (ct.includes('application/json')) {
      return res.json().then(data => ({ res, data }));
    }
    // If server returned HTML (e.g. redirect to login or an error page), capture text and throw a clear error
    return res.text().then(text => {
      let preview = text.replace(/\s+/g, ' ').trim().slice(0, 400);
      if (preview.length < text.length) preview += '...';
      throw new Error('Sunucudan beklenmeyen (HTML) yanÄ±t alÄ±ndÄ±: ' + preview);
    });
  })
  .then(({ res, data }) => {
    if (!res.ok) {
      throw new Error(data && data.message ? data.message : ('Sunucu hatasÄ±: ' + res.status));
    }
    if (data.success) {
      location.reload();
    } else {
      throw new Error(data.message || 'Bilinmeyen hata');
    }
  })
  .catch(err => {
    alert('YÃ¼kleme sÄ±rasÄ±nda hata oluÅŸtu: ' + err.message);
  });
}

function showNotification(message, type = 'success') {
  // Mevcut bildirimi kaldÄ±r
  const existingNotif = document.getElementById('notification');
  if (existingNotif) {
    existingNotif.remove();
  }
  
  // Yeni bildirim oluÅŸtur
  const notif = document.createElement('div');
  notif.id = 'notification';
  notif.textContent = message;
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    font-size: 14px;
    font-weight: 500;
    animation: slideIn 0.3s ease-out;
  `;
  
  // CSS animasyonu ekle
  if (!document.getElementById('notificationStyle')) {
    const style = document.createElement('style');
    style.id = 'notificationStyle';
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notif);
  
  // 3 saniye sonra kaldÄ±r
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => notif.remove(), 300);
  }, 3000);
}

// Global documents data
let documentsData = <%- JSON.stringify(documents || []) %>;

function showDocumentsInFolder(category) {
  const modal = document.getElementById('documentListModal');
  const title = document.getElementById('modalCategoryTitle');
  const content = document.getElementById('documentListContent');
  
  const icons = {
    'Evraklar': 'ğŸ“„',
    'CMR': 'ğŸš›',
    'Navlun': 'ğŸ’°',
    'T1/GMR': 'ğŸ“‹'
  };
  
  title.textContent = icons[category] + ' ' + category;
  
  const filtered = documentsData.filter(d => d.category === category && (!d.type || String(d.type).trim() === ''));
  
  if (filtered.length === 0) {
    content.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">Bu kategoride evrak yok</div>';
  } else {
    content.innerHTML = filtered.map(doc => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #020617; border: 1px solid #1f2937; border-radius: 6px;">
        <a href="/uploads/${doc.filename}" target="_blank" style="color: #60a5fa; text-decoration: none; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 12px;">
          ğŸ“ ${doc.original_name || doc.filename}
        </a>
        <button 
          onclick="deleteDocument('${doc.id}')"
          style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 0 4px; margin-left: 8px;"
          title="Sil"
        >Ã—</button>
      </div>
    `).join('');
  }
  
  modal.style.display = 'flex';
}

function hideDocumentListModal() {
  document.getElementById('documentListModal').style.display = 'none';
}

// Drag events
dropZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.style.borderColor = '#3b82f6';
  dropZone.style.background = '#1e3a8a15';
});

dropZone.addEventListener('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.style.borderColor = '#374151';
  dropZone.style.background = '#020617';
});

dropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  dropZone.style.borderColor = '#374151';
  dropZone.style.background = '#020617';
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    selectedFiles = Array.from(files);
    openDocumentModal();
  }
});

// Make each doc-folder a drop target that uploads directly into its category
const docFolders = document.querySelectorAll('.doc-folder');
docFolders.forEach(folder => {
  folder.addEventListener('dragover', function(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    this.style.borderColor = '#3b82f6';
    this.style.background = '#1e3a8a15';
  });

  folder.addEventListener('dragleave', function(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    this.style.borderColor = '#1f2937';
    this.style.background = '#020617';
  });

  folder.addEventListener('drop', function(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    this.style.borderColor = '#1f2937';
    this.style.background = '#020617';

    const files = ev.dataTransfer.files;
    if (files && files.length > 0) {
      selectedFiles = Array.from(files);
      const category = this.dataset.category || 'Evraklar';
      // set category in modal select (if exists) and upload immediately
      const categorySelect = document.getElementById('categorySelect');
      if (categorySelect) categorySelect.value = category;

      // Submit directly without opening modal for quicker UX
      submitDocuments();
    }
  });
});

function deleteDocument(docId) {
  const modal = document.getElementById('deleteDocumentModal');
  const form = document.getElementById('deleteDocumentForm');
  
  form.onsubmit = function(e) {
    e.preventDefault();
    
    fetch('/loads/document/' + docId + '/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Silme modalÄ±nÄ± kapat
        modal.style.display = 'none';
        
        // Global documents dizisinden ilgili evrakÄ± Ã§Ä±kar
        const deletedDocIndex = documentsData.findIndex(d => d.id == docId);
        if (deletedDocIndex !== -1) {
          const deletedDoc = documentsData.splice(deletedDocIndex, 1)[0];
          
          // KlasÃ¶r sayaÃ§larÄ±nÄ± gÃ¼ncelle
          const categoryFolders = document.querySelectorAll('.doc-folder');
          categoryFolders.forEach(folder => {
            const categoryNameEl = folder.querySelector('div:nth-child(2)');
            if (categoryNameEl && categoryNameEl.textContent.trim() === deletedDoc.category) {
              const countEl = folder.querySelector('.doc-count');
              if (countEl) {
                const currentCount = parseInt(countEl.textContent) || 0;
                countEl.textContent = Math.max(0, currentCount - 1);
              }
            }
          });
          
          // BaÅŸarÄ± bildirimi gÃ¶ster
          showNotification('Evrak baÅŸarÄ±yla silindi', 'success');
        }
        
        // Evrak listesini yenile (sayfa yenileme yerine)
        const currentCategory = document.getElementById('modalCategoryTitle').textContent.trim().split(' ')[1];
        if (currentCategory) {
          showDocumentsInFolder(currentCategory);
        }
      } else {
        showNotification('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + (data.message || 'Bilinmeyen hata'), 'error');
      }
    })
    .catch(err => {
      showNotification('Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: ' + err.message, 'error');
    });
  };
  
  modal.style.display = 'flex';
}

function addMrnNo() {
  const positionNo = '<%= positionNo %>';
  const mrnInput = document.getElementById('mrn-input');
  const mrnNo = mrnInput.value.trim();
  
  if (!mrnNo) {
    showMrnModal('LÃ¼tfen MRN numarasÄ± giriniz', 'warning');
    return;
  }
  
  if (currentMrnList.includes(mrnNo)) {
    showMrnModal('Bu MRN numarasÄ± zaten ekli!', 'warning');
    return;
  }
  
  // Yeni MRN'i listeye ekle
  currentMrnList.push(mrnNo);
  
  // Sunucuya kaydet
  fetch('/loads/position/' + encodeURIComponent(positionNo) + '/mrn', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mrn_no: currentMrnList.join(', ') })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Liste gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
      updateMrnList();
      mrnInput.value = '';
      showMrnModal('MRN NO baÅŸarÄ±yla eklendi!', 'success');
    } else {
      currentMrnList.pop(); // Hata varsa geri al
      showMrnModal('Hata: ' + (data.error || 'Bilinmeyen hata'), 'error');
    }
  })
  .catch(err => {
    currentMrnList.pop();
    showMrnModal('MRN NO eklenirken hata oluÅŸtu: ' + err.message, 'error');
  });
}

function deleteMrnNo(mrnToDelete) {
  const positionNo = '<%= positionNo %>';
  
  // Listeden kaldÄ±r
  currentMrnList = currentMrnList.filter(m => m !== mrnToDelete);
  
  // Sunucuya kaydet
  fetch('/loads/position/' + encodeURIComponent(positionNo) + '/mrn', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mrn_no: currentMrnList.join(', ') })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      updateMrnList();
      showMrnModal('MRN NO silindi', 'success');
    } else {
      currentMrnList.push(mrnToDelete); // Hata varsa geri ekle
      showMrnModal('Hata: ' + (data.error || 'Bilinmeyen hata'), 'error');
    }
  })
  .catch(err => {
    currentMrnList.push(mrnToDelete);
    showMrnModal('Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: ' + err.message, 'error');
  });
}

function updateMrnList() {
  const listDiv = document.getElementById('mrn-list');
  listDiv.innerHTML = '';
  
  currentMrnList.forEach(mrn => {
    const item = document.createElement('div');
    item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: #020617; border: 1px solid #1f2937; border-radius: 6px; font-size: 11px;';
    item.innerHTML = `
      <span style="color: #22c55e;">âœ“ ${mrn}</span>
      <button 
        onclick="deleteMrnNo('${mrn}')"
        style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 0 4px;"
        title="Sil"
      >Ã—</button>
    `;
    listDiv.appendChild(item);
  });
}

// Mesafe listesi iÃ§in global deÄŸiÅŸken
let distanceSegments = [];
// Helper: try postcodes.io (UK) first, then fallback to Nominatim (OpenStreetMap) for non-UK postal codes
async function geocodePostcode(postcode) {
  if (!postcode) return null;
  // Try postcodes.io (UK)
  try {
    const resp = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`);
    const data = await resp.json();
    if (data && data.status === 200 && data.result) {
      return { lat: data.result.latitude, lon: data.result.longitude, source: 'postcodes.io' };
    }
  } catch (e) {
    // ignore and fallback
  }

  // Fallback: Nominatim (OpenStreetMap) - returns first matching result
  try {
    const nomUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(postcode)}&limit=1`;
    const nomResp = await fetch(nomUrl, { headers: { 'Accept-Language': 'en' } });
    const nomData = await nomResp.json();
    if (nomData && nomData.length > 0) {
      const item = nomData[0];
      return { lat: parseFloat(item.lat), lon: parseFloat(item.lon), source: 'nominatim' };
    }
  } catch (e) {
    // ignore
  }

  return null;
}

// Nominatim search helper for address autocomplete (returns array of results)
async function nominatimSearch(query, limit = 6) {
  if (!query || query.length < 2) return [];
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=${limit}`;
    const resp = await fetch(url, { headers: { 'Accept-Language': 'en' } });
    const data = await resp.json();
    return Array.isArray(data) ? data : [];
  } catch (e) {
    return [];
  }
}

function renderLocationSuggestions(items, container, inputEl) {
  container.innerHTML = '';
  if (!items || items.length === 0) {
    container.style.display = 'none';
    return;
  }
  items.forEach(it => {
    const d = document.createElement('div');
    d.style.cssText = 'padding:8px; cursor:pointer; border-radius:6px; color:#e6eef6; font-size:13px;';
    d.innerHTML = `<div style="font-weight:700;">${it.display_name.split(',')[0]}</div><div style='font-size:12px;color:#9ca3af;margin-top:4px;'>${it.display_name}</div>`;
    d.addEventListener('click', function() {
      // Set input value and store coordinates on dataset
      inputEl.value = it.display_name;
      inputEl.dataset.lat = it.lat;
      inputEl.dataset.lon = it.lon;
      container.innerHTML = '';
      container.style.display = 'none';
      // move focus to next field
      try { inputEl.dispatchEvent(new Event('change')); } catch (e) {}
    });
    container.appendChild(d);
  });
  container.style.display = 'block';
}

function clearLocationSelection(inputEl, container) {
  if (inputEl) { inputEl.dataset.lat = ''; inputEl.dataset.lon = ''; }
  if (container) { container.innerHTML = ''; container.style.display = 'none'; }
}

function debounce(fn, wait) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

// Attach autocomplete handlers after DOM ready (modal inputs exist in page)
try {
  (function attachLocationAutocomplete(){
    const fromInput = document.getElementById('modal-postcode-from');
    const toInput = document.getElementById('modal-postcode-to');
    const fromContainer = document.getElementById('modal-postcode-from-suggestions');
    const toContainer = document.getElementById('modal-postcode-to-suggestions');
    if (!fromInput || !toInput || !fromContainer || !toContainer) return;

    const handlerFrom = debounce(async function(e) {
      const q = this.value.trim();
      if (!q) { clearLocationSelection(this, fromContainer); return; }
      // If looks like a short postcode (alphanumeric, <=8), still offer nominatim suggestions
      const results = await nominatimSearch(q);
      renderLocationSuggestions(results, fromContainer, fromInput);
      // clear any stale dataset if user types
      if (!results.length) { this.dataset.lat = ''; this.dataset.lon = ''; }
    }, 300);

    const handlerTo = debounce(async function(e) {
      const q = this.value.trim();
      if (!q) { clearLocationSelection(this, toContainer); return; }
      const results = await nominatimSearch(q);
      renderLocationSuggestions(results, toContainer, toInput);
      if (!results.length) { this.dataset.lat = ''; this.dataset.lon = ''; }
    }, 300);

    fromInput.addEventListener('input', handlerFrom);
    toInput.addEventListener('input', handlerTo);

    // If user manually clears or changes input, clear stored coords
    fromInput.addEventListener('change', function() { if (!this.value.trim()) clearLocationSelection(this, fromContainer); });
    toInput.addEventListener('change', function() { if (!this.value.trim()) clearLocationSelection(this, toContainer); });
  })();
} catch (e) {
  console.warn('Autocomplete attach error', e);
}

async function calculateModalDistance() {
  const fromEl = document.getElementById('modal-postcode-from');
  const toEl = document.getElementById('modal-postcode-to');
  const segmentType = document.getElementById('modal-segment-type').value;
  const fromVal = fromEl ? fromEl.value.trim() : '';
  const toVal = toEl ? toEl.value.trim() : '';

  if (!fromVal || !toVal) {
    showMrnModal('LÃ¼tfen her iki posta kodunu ya da adresi girin', 'warning');
    return;
  }

  try {
    // If user selected an autocomplete suggestion we store lat/lon on dataset
    let fromCoords = null;
    if (fromEl && fromEl.dataset && fromEl.dataset.lat && fromEl.dataset.lon) {
      fromCoords = { lat: parseFloat(fromEl.dataset.lat), lon: parseFloat(fromEl.dataset.lon), source: 'nominatim' };
    } else {
      // Geocode (postcode.io first then Nominatim)
      fromCoords = await geocodePostcode(fromVal);
    }
    if (!fromCoords) {
      showMrnModal('BaÅŸlangÄ±Ã§ konumu bulunamadÄ±', 'error');
      return;
    }

    let toCoords = null;
    if (toEl && toEl.dataset && toEl.dataset.lat && toEl.dataset.lon) {
      toCoords = { lat: parseFloat(toEl.dataset.lat), lon: parseFloat(toEl.dataset.lon), source: 'nominatim' };
    } else {
      toCoords = await geocodePostcode(toVal);
    }
    if (!toCoords) {
      showMrnModal('BitiÅŸ konumu bulunamadÄ±', 'error');
      return;
    }

    // KoordinatlarÄ± al
    const lat1 = fromCoords.lat;
    const lon1 = fromCoords.lon;
    const lat2 = toCoords.lat;
    const lon2 = toCoords.lon;
    
    let distance = 0;
    
    // OSRM API kullanarak gerÃ§ek yol mesafesi hesapla
    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
    
    try {
      const osrmResponse = await fetch(osrmUrl);
      const osrmData = await osrmResponse.json();
      
      if (osrmData.code === 'Ok' && osrmData.routes && osrmData.routes.length > 0) {
        const distanceInMeters = osrmData.routes[0].distance;
        distance = distanceInMeters / 1000; // km'ye Ã§evir
      }
    } catch (osrmError) {
      console.log('OSRM hatasÄ±, tahmini hesaplama yapÄ±lÄ±yor:', osrmError);
      // OSRM Ã§alÄ±ÅŸmazsa Haversine formÃ¼lÃ¼ ile tahmini hesapla (1.35 katsayÄ±lÄ±)
      const R = 6371; // DÃ¼nya yarÄ±Ã§apÄ± km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const straightDistance = R * c;
      distance = straightDistance * 1.35; // ~35% daha fazla
    }
    
    // Yeni segment ekle (koordinatlarÄ± da tut)
    distanceSegments.push({
      from: fromVal,
      to: toVal,
      distance: distance,
      type: segmentType,
      lat1: lat1,
      lon1: lon1,
      lat2: lat2,
      lon2: lon2
    });
    
    // Listeyi gÃ¼ncelle
    updateDistanceList();
    // HaritayÄ± da gÃ¼ncelle (varsa)
    try { updateDistanceMap(); } catch (e) { /* ignore if map not initialized */ }
    
    // Input alanlarÄ±nÄ± temizle ve "to" deÄŸerini "from"a taÅŸÄ±
    (function(){
      const fromEl = document.getElementById('modal-postcode-from');
      const toEl = document.getElementById('modal-postcode-to');
      if (fromEl) {
        fromEl.value = toVal;
        fromEl.dataset.lat = ''; fromEl.dataset.lon = '';
        const c = document.getElementById('modal-postcode-from-suggestions'); if (c) { c.innerHTML = ''; c.style.display = 'none'; }
      }
      if (toEl) {
        toEl.value = '';
        toEl.dataset.lat = ''; toEl.dataset.lon = '';
        const c2 = document.getElementById('modal-postcode-to-suggestions'); if (c2) { c2.innerHTML = ''; c2.style.display = 'none'; }
        try { toEl.focus(); } catch(e){}
      }
    })();
    
  } catch (error) {
    showMrnModal('Mesafe hesaplanÄ±rken hata oluÅŸtu', 'error');
    console.error(error);
  }
}

// Creates and shows a modern modal for editing To/CC before sending
function showSendConfirmModal(initialTo, initialCc, positionNo) {
  return new Promise((resolve) => {
    const toVal = (initialTo || []).join(', ');
    const ccVal = (initialCc || []).join(', ');
    let selectedFiles = [];
    let selectedDocIds = [];

    // modal container
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.background = 'rgba(0,0,0,0.55)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = 100000;

    modal.innerHTML = `
      <div style="width:720px; max-width:96%; background:#0b1220; color:#e5e7eb; border-radius:10px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(148,163,184,0.06);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div style="font-weight:700;">E-Posta GÃ¶nderimi â€” AlÄ±cÄ±larÄ± Kontrol Et</div>
          <button id="modalCloseBtn" style="background:transparent; border:0; color:#9ca3af; font-size:18px;">âœ•</button>
        </div>
        <div style="font-size:13px; color:#9ca3af; margin-bottom:8px;">AÅŸaÄŸÄ±da To ve CC alanlarÄ±nÄ± dÃ¼zenleyebilirsiniz. Adresleri virgÃ¼lle ayÄ±rÄ±n. DosyalarÄ± sÃ¼rÃ¼kleyip bÄ±rakabilir veya seÃ§ebilirsiniz. Eklenen dosyalar mail ile gÃ¶nderilecektir.</div>
        <div style="display:flex; gap:12px; margin-bottom:8px;">
          <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
            <label style="font-size:12px; color:#9ca3af;">To</label>
            <textarea id="modalToInput" style="min-height:60px; padding:8px; border-radius:6px; border:1px solid #233044; background:#020617; color:#e5e7eb;">${toVal}</textarea>
          </div>
          <div style="width:260px; display:flex; flex-direction:column; gap:6px;">
            <label style="font-size:12px; color:#9ca3af;">CC</label>
            <textarea id="modalCcInput" style="min-height:60px; padding:8px; border-radius:6px; border:1px solid #233044; background:#020617; color:#e5e7eb;">${ccVal}</textarea>
          </div>
        </div>

        <div id="modalDocList" style="border:2px solid rgba(35,48,68,0.3); padding:12px; border-radius:8px; background:#07101a; color:#9ca3af; margin-bottom:10px;">
          <div style="font-size:13px; color:#9ca3af; margin-bottom:8px;">Pozisyona yÃ¼klenmiÅŸ evraklar (tikleyin):</div>
          <div id="modalDocListInner" style="max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:6px;">
            <!-- docs will be inserted here -->
          </div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
          <button id="modalCancelBtn" style="background:#374151; color:#e5e7eb; padding:8px 12px; border-radius:6px; border:0;">Ä°ptal</button>
          <button id="modalSendBtn" style="background:#16a34a; color:white; padding:8px 12px; border-radius:6px; border:0;">GÃ¶nder</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    const docListInner = modal.querySelector('#modalDocListInner');
    const fileInput = modal.querySelector('#modalFileInput');
    const dropZone = modal.querySelector('#modalDropZone');
    const fileListDiv = modal.querySelector('#modalFileList');
    const chooseBtn = modal.querySelector('#chooseFilesBtn');

    // render existing documents for this position
    function renderDocList() {
      docListInner.innerHTML = '';
      const docs = (documentsData || []).filter(d => (d.position_no || '') === positionNo && (!d.type || String(d.type).trim() === ''));
      if (!docs || docs.length === 0) {
        docListInner.innerHTML = '<div style="color:#9ca3af; padding:8px;">Bu pozisyona ait evrak yok.</div>';
        return;
      }
      docs.forEach(d => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 8px';
        row.style.background = '#020617';
        row.style.borderRadius = '6px';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.dataset.docId = d.id;
        chk.addEventListener('change', function() {
          const id = this.dataset.docId;
          if (this.checked) {
            if (!selectedDocIds.includes(id)) selectedDocIds.push(id);
          } else {
            const idx = selectedDocIds.indexOf(id);
            if (idx !== -1) selectedDocIds.splice(idx,1);
          }
        });

        const label = document.createElement('a');
        label.href = '/uploads/' + encodeURIComponent((d.filename || '').split('/')[0]) + '/' + encodeURIComponent((d.category||'').replace(/\//g,'-')) + '/' + encodeURIComponent((d.filename || '').split('/').pop());
        label.target = '_blank';
        label.style.color = '#60a5fa';
        label.style.textDecoration = 'none';
        label.textContent = d.original_name || d.filename;

        left.appendChild(chk);
        left.appendChild(label);

        const meta = document.createElement('div');
        meta.style.fontSize = '12px';
        meta.style.color = '#9ca3af';
        meta.textContent = (d.created_at || '');

        row.appendChild(left);
        row.appendChild(meta);
        docListInner.appendChild(row);
      });
    }

    renderDocList();

    function renderFileList() {
      if (!fileListDiv) return; // no file-list area in this modal variant
      fileListDiv.innerHTML = '';
      if (!selectedFiles || selectedFiles.length === 0) {
        fileListDiv.textContent = 'HenÃ¼z dosya eklenmedi.';
        return;
      }
      selectedFiles.forEach((f, idx) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '6px 8px';
        row.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
        const left = document.createElement('div');
        left.style.color = '#e5e7eb';
        left.style.fontSize = '13px';
        left.textContent = f.name + ' (' + Math.round(f.size/1024) + ' KB)';
        const del = document.createElement('button');
        del.textContent = 'Sil';
        del.style.background = 'transparent';
        del.style.color = '#ef4444';
        del.style.border = '0';
        del.style.cursor = 'pointer';
        del.addEventListener('click', () => { selectedFiles.splice(idx,1); renderFileList(); });
        row.appendChild(left);
        row.appendChild(del);
        fileListDiv.appendChild(row);
      });
    }

    function addFiles(list) {
      for (let i=0;i<list.length;i++) {
        const f = list[i];
        // avoid duplicates by name+size
        if (!selectedFiles.some(sf => sf.name === f.name && sf.size === f.size)) selectedFiles.push(f);
      }
      renderFileList();
    }

    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#3b82f6'; });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#233044'; });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = '#233044'; if (e.dataTransfer && e.dataTransfer.files) addFiles(e.dataTransfer.files); });
    }
    if (chooseBtn && fileInput) {
      chooseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => { if (e.target && e.target.files) addFiles(e.target.files); fileInput.value = ''; });
    }

    const close = (result) => {
      if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
      resolve(result);
    };

    modal.querySelector('#modalCloseBtn').addEventListener('click', () => close({ ok: false }));
    modal.querySelector('#modalCancelBtn').addEventListener('click', () => close({ ok: false }));
    modal.querySelector('#modalSendBtn').addEventListener('click', () => {
      const toRaw = modal.querySelector('#modalToInput').value || '';
      const ccRaw = modal.querySelector('#modalCcInput').value || '';
      const toArr = toRaw.split(',').map(s => s.trim()).filter(Boolean);
      const ccArr = ccRaw.split(',').map(s => s.trim()).filter(Boolean);
      // Validate at least one to address
      if (!toArr.length || !toArr.some(a => a.indexOf('@') !== -1)) {
        alert('LÃ¼tfen en az bir geÃ§erli To adresi girin.');
        return;
      }
      close({ ok: true, toList: toArr, ccList: ccArr, files: selectedFiles.slice(), selectedDocs: selectedDocIds.slice() });
    });

    renderFileList();
  });
}

// Global compact address helper for modal rendering
function shortAddr(addr) {
  if (!addr) return '-';
  try {
    const parts = String(addr).split(',').map(s => s.trim()).filter(Boolean);
    const postcodeRegex = /[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}/i;
    let postcode = null;
    let city = null;
    let country = null;

    for (let i = 0; i < parts.length; i++) {
      const p = parts[i];
      const m = p.match(postcodeRegex);
      if (m) {
        postcode = m[0];
        const remaining = p.replace(m[0], '').trim();
        if (remaining) city = remaining;
        else if (parts[i+1]) city = parts[i+1];
        break;
      }
    }

    if (!postcode && parts.length) {
      const m2 = parts[0].match(/[A-Z0-9]{2,}\s*[A-Z0-9]{1,}/i);
      if (m2) postcode = m2[0];
    }

    if (!city) {
      const blacklist = ['england','united kingdom','uk','france','germany','spain','italy'];
      for (let i=0;i<parts.length;i++) {
        const p = parts[i];
        const pl = p.toLowerCase();
        if (postcode && p.indexOf(postcode) !== -1) continue;
        if (blacklist.some(b => pl.includes(b))) continue;
        if (p.length > 1 && p.length < 60) { city = p; break; }
      }
    }

    for (let i = parts.length - 1; i >= 0; i--) {
      const p = parts[i];
      const pl = p.toLowerCase();
      if (city && p === city) continue;
      if (postcode && p.indexOf(postcode) !== -1) continue;
      // Only skip non-country tokens here; accept country names like 'united kingdom' or 'france'
      const skip = ['county','state','region'];
      if (skip.some(s => pl === s || pl.includes(s))) continue;
      country = parts[i];
      break;
    }

    if (postcode && city && country) return postcode + ', ' + city + ', ' + country;
    if (postcode && city) return postcode + ', ' + city;
    if (postcode && country) return postcode + ', ' + country;
    if (postcode) return postcode;
    if (city && country) return city + ', ' + country;
    if (city) return city;
    return parts[0].length > 60 ? parts[0].slice(0,60) + 'â€¦' : parts[0];
  } catch (e) { return addr; }
}

// Modal-specific compact helper: only postcode + country (to keep list compact)
function shortAddrModal(addr) {
  if (!addr) return '-';
  try {
    const parts = String(addr).split(',').map(s => s.trim()).filter(Boolean);
    const postcodeRegex = /[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}/i;
    let postcode = null;
    let postcodeIdx = -1;
    let country = null;
    let city = null;

    // find postcode and its index
    for (let i = 0; i < parts.length; i++) {
      const p = parts[i];
      const m = p.match(postcodeRegex);
      if (m) { postcode = m[0]; postcodeIdx = i; break; }
    }

    // pick trailing part as country if it's not postcode
    for (let i = parts.length - 1; i >= 0; i--) {
      const p = parts[i];
      if (postcode && p.indexOf(postcode) !== -1) continue;
      const pl = p.toLowerCase();
      const skip = ['county','state','region','street','road'];
      if (skip.some(s => pl === s || pl.includes(s))) continue;
      country = p;
      break;
    }

    // determine city: prefer text near postcode, otherwise pick first non-country token
    if (postcodeIdx >= 0) {
      const part = parts[postcodeIdx];
      const after = part.replace(postcode, '').trim();
      if (after) city = after;
      else if (parts[postcodeIdx + 1]) city = parts[postcodeIdx + 1];
    }
    if (!city) {
      for (let i = 0; i < parts.length; i++) {
        const p = parts[i];
        if (p === country) continue;
        if (postcode && p.indexOf(postcode) !== -1) continue;
        const pl = p.toLowerCase();
        const skip2 = ['street','road','no','apt','blok','mahalle'];
        if (skip2.some(s => pl === s || pl.includes(s))) continue;
        city = p; break;
      }
    }

    // If this is a UK address and city looks like a facility (SEGRO, Gateway, Park, Industrial Estate, Depot, Terminal, Port, etc.),
    // try to pick a more suitable city/token. Otherwise show postcode + city (truncate if too long).
    try {
      const plCountry = (country || '').toLowerCase();
      const isUK = plCountry.includes('united kingdom') || plCountry === 'uk' || plCountry.includes('england');
      const facilityKeywords = ['segro','gateway','park','industrial','estate','depot','terminal','port','warehouse','business','centre','center','logistics','distribution'];
      if (isUK && city) {
        const cityLow = city.toLowerCase();
        const isFacility = facilityKeywords.some(k => cityLow.includes(k));
        if (isFacility) {
          // try to find another part that's likely a town/city
          let alt = null;
          for (let i = 0; i < parts.length; i++) {
            const p = parts[i];
            if (!p) continue;
            if (p === country) continue;
            if (postcode && p.indexOf(postcode) !== -1) continue;
            const pl = p.toLowerCase();
            if (facilityKeywords.some(k => pl.includes(k))) continue;
            // skip tokens that look like street numbers or short codes
            if (/^\d{1,4}\s?[-A-Z0-9]*$/i.test(p.trim())) continue;
            alt = p; break;
          }
          if (alt) city = alt;
          else {
            // fallback: show only postcode + country to avoid very long facility text
            if (postcode && country) return postcode + ', ' + country;
          }
        }
      }
    } catch (e) { /* ignore heuristic failures */ }

    // truncate overly long city names for modal compactness
    if (city && String(city).length > 40) city = String(city).slice(0,40) + 'â€¦';

    if (postcode && city && country) return postcode + ', ' + city + ', ' + country;
    if (city && country) return city + ', ' + country;
    if (postcode && country) return postcode + ', ' + country;
    if (postcode && city) return postcode + ', ' + city;
    if (postcode) return postcode;
    if (country) return country;
    return parts[0] || String(addr);
  } catch (e) { return String(addr); }
}

function updateDistanceList() {
  const listDiv = document.getElementById('distance-list');
  const itemsDiv = document.getElementById('distance-items');
  const resultDiv = document.getElementById('modal-distance-result');
  const resultText = resultDiv.querySelector('div:last-child');
  
  if (distanceSegments.length === 0) {
    listDiv.style.display = 'none';
    resultDiv.style.display = 'none';
    return;
  }
  
  // Liste Ã¶ÄŸelerini oluÅŸtur
  itemsDiv.innerHTML = '';
  let totalDistance = 0;
  let loadingDistance = 0;
  let unloadingDistance = 0;
  let exitDistance = 0;
  let europeDistance = 0;
  
  distanceSegments.forEach((segment, index) => {
    totalDistance += segment.distance;
    
    if (segment.type === 'loading') {
      loadingDistance += segment.distance;
    } else if (segment.type === 'unloading') {
      unloadingDistance += segment.distance;
    } else if (segment.type === 'exit') {
      exitDistance += segment.distance;
    } else if (segment.type === 'europe') {
      europeDistance += segment.distance;
    }

    const typeIcon = segment.type === 'loading' ? 'ğŸ”µ' : (segment.type === 'unloading' ? 'ğŸŸ¢' : (segment.type === 'exit' ? 'ğŸ”¶' : 'ğŸ‡ªğŸ‡º'));
    const typeName = segment.type === 'loading' ? 'YÃ¼kleme' : (segment.type === 'unloading' ? 'BoÅŸaltma' : (segment.type === 'exit' ? 'Ã‡Ä±kÄ±ÅŸ' : 'Avrupa'));
    const typeColor = segment.type === 'loading' ? '#3b82f6' : (segment.type === 'unloading' ? '#22c55e' : (segment.type === 'exit' ? '#f59e0b' : '#8b5cf6'));
    
    // Adresi kÄ±salt: Posta Kodu, Åehir, Ãœlke
    function formatShortAddr(addr) {
      if (!addr) return '-';
      const parts = addr.split(',').map(p => p.trim());
      // Ä°lk kÄ±sÄ±m genelde posta kodu veya yer adÄ±
      const postcode = parts[0] || '';
      // Ãœlke genelde son kÄ±sÄ±m
      const country = parts[parts.length - 1] || '';
      // Åehir genelde sondan 2. veya 3. kÄ±sÄ±m
      let city = '';
      if (parts.length >= 3) {
        // Sondan 2. veya 3. kÄ±smÄ± al (county deÄŸil city)
        city = parts[parts.length - 3] || parts[parts.length - 2] || '';
      } else if (parts.length >= 2) {
        city = parts[parts.length - 2] || '';
      }
      // Sadece posta kodu, ÅŸehir ve Ã¼lke
      if (city && city !== country && city !== postcode) {
        return `${postcode}, ${city}, ${country}`;
      }
      return `${postcode}, ${country}`;
    }
    
    const shortFrom = formatShortAddr(segment.from);
    const shortTo = formatShortAddr(segment.to);
    const fullTitle = (segment.from || '-') + ' â†’ ' + (segment.to || '-');
    
    const item = document.createElement('div');
    item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: #020617; border-left: 3px solid ' + typeColor + '; border-radius: 8px; font-size: 13px;';
    item.innerHTML = `
      <div style="flex: 1; display:flex; gap:8px; align-items:center;">
        <span style="font-size:13px; width:20px; flex-shrink:0;">${typeIcon}</span>
        <div style="flex:1; min-width:0;">
          <div style="font-size:11px; color:#9ca3af; font-weight:700; margin-bottom:4px;">${typeName} - Segment ${index + 1}</div>
          <div style="font-size:12px; color:#e5e7eb; line-height:1.4;" title="${fullTitle}">${shortFrom} â†’ ${shortTo}</div>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 8px; margin-left:8px; flex-shrink:0;">
        <span style="font-size:13px; font-weight:700; color: ${typeColor};">${segment.distance.toFixed(1)} km</span>
        <button 
          onclick="deleteDistanceSegment(${index})"
          style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 0 6px;"
          title="Sil"
        >Ã—</button>
      </div>
    `;
    itemsDiv.appendChild(item);
  });
  
  // Alt toplam gÃ¶ster (YÃ¼kleme ve BoÅŸaltma)
  // Show subtotals for Loading / Unloading / Exit
  const subtotalDiv = document.createElement('div');
  subtotalDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 8px; padding: 8px; background: #0f172a; border-radius: 8px;';
  subtotalDiv.innerHTML = `
    <div style="flex: 1; text-align: center; padding: 6px; background: #020617; border-radius: 6px;">
      <div style="font-size: 10px; color: #9ca3af; margin-bottom: 2px;">ğŸ”µ YÃœKLEME</div>
      <div style="font-size: 14px; font-weight: 600; color: #3b82f6;">${loadingDistance.toFixed(1)} km</div>
    </div>
    <div style="flex: 1; text-align: center; padding: 6px; background: #020617; border-radius: 6px;">
      <div style="font-size: 10px; color: #9ca3af; margin-bottom: 2px;">ğŸŸ¢ BOÅALTMA</div>
      <div style="font-size: 14px; font-weight: 600; color: #22c55e;">${unloadingDistance.toFixed(1)} km</div>
    </div>
    <div style="flex: 1; text-align: center; padding: 6px; background: #020617; border-radius: 6px;">
      <div style="font-size: 10px; color: #9ca3af; margin-bottom: 2px;">ğŸ”¶ Ã‡IKIÅ</div>
      <div style="font-size: 14px; font-weight: 600; color: #f59e0b;">${exitDistance.toFixed(1)} km</div>
    </div>
    <div style="flex: 1; text-align: center; padding: 6px; background: #020617; border-radius: 6px;">
      <div style="font-size: 10px; color: #9ca3af; margin-bottom: 2px;">ğŸ‡ªğŸ‡º AVRUPA</div>
      <div style="font-size: 14px; font-weight: 600; color: #8b5cf6;">${europeDistance.toFixed(1)} km</div>
    </div>
  `;
  itemsDiv.appendChild(subtotalDiv);
  
  // Toplam mesafeyi 20'nin katÄ±na yuvarla ve gÃ¶ster
  const roundedTotalDistance = Math.ceil(totalDistance / 20) * 20;
  resultText.textContent = roundedTotalDistance + ' km';
  listDiv.style.display = 'block';
  resultDiv.style.display = 'block';

  // Update HERSTAL display (if enabled)
  try {
    updateHerstalDisplay(totalDistance);
  } catch (e) { /* ignore */ }

  // Update Avrupa Mazot display (if enabled)
  try {
    const avrupaCheckbox = document.getElementById('avrupa-checkbox');
    if (avrupaCheckbox && avrupaCheckbox.checked) {
      updateAvrupaDisplay(totalDistance);
    }
  } catch (e) { /* ignore */ }
}

// HERSTAL calculations
function computeHerstal(totalDistance) {
  const t = Number(totalDistance) || 0;
  const step1 = t + 1750;
  const step2 = step1 + 125;
  const step3 = step2 * 0.3;
  const finalResult = 1450 - step3;
  return { step1, step2, step3, finalResult };
}

function updateHerstalDisplay(totalDistance) {
  const checkbox = document.getElementById('herstal-checkbox');
  const panel = document.getElementById('herstal-panel');
  const orig = document.getElementById('herstal-original');
  const s1 = document.getElementById('herstal-step1');
  const s2 = document.getElementById('herstal-step2');
  const sf = document.getElementById('herstal-final');
  if (!orig || !s1 || !s2 || !sf || !panel || !checkbox) return;

  const t = Number(totalDistance) || 0;
  orig.textContent = 'TOPLAM = ' + t.toFixed(1) + ' km';

  const vals = computeHerstal(totalDistance);
  // show direct calculation operations instead of only numbers
  s1.textContent = `${t.toFixed(1)} + 1750 = ${vals.step1.toFixed(1)} km`;
  s2.textContent = `${vals.step1.toFixed(1)} + 125 = ${vals.step2.toFixed(1)} km`;
  const s3el = document.getElementById('herstal-step3');
  if (s3el) s3el.textContent = `${vals.step2.toFixed(1)} * 0.3 = ${vals.step3.toFixed(1)} lt`;
  
  // Round finalResult to nearest 10 (e.g., 402 -> 410, 455 -> 460)
  const roundedFinal = Math.ceil(vals.finalResult / 10) * 10;
  sf.textContent = `1450 - ${vals.step3.toFixed(1)} = ${roundedFinal} lt`;

  // Calculate HERSTAL MAZOT: complete to 500 (500 - roundedFinal)
  // Example: if finalResult is 450, HERSTAL MAZOT = 500 - 450 = 50
  // If roundedFinal >= 500, show "YOK"
  const herstalMazotEl = document.getElementById('herstal-mazot');
  if (herstalMazotEl) {
    if (roundedFinal >= 500) {
      herstalMazotEl.textContent = 'YOK';
      herstalMazotEl.style.color = '#ef4444'; // kÄ±rmÄ±zÄ±
    } else {
      const herstalMazot = 500 - roundedFinal;
      herstalMazotEl.textContent = `500 - ${roundedFinal} = ${herstalMazot} lt`;
      herstalMazotEl.style.color = ''; // varsayÄ±lan renk
    }
  }

  // Calculate MACAR: complete to 1050 (1050 - roundedFinal)
  // Example: if finalResult is 600, MACAR = 1050 - 600 = 450
  const macar = Math.max(0, 1050 - roundedFinal);
  const macarEl = document.getElementById('herstal-macar');
  if (macarEl) {
    macarEl.textContent = `${macar} lt`;
  }

  // show/hide panel based on checkbox
  panel.style.display = checkbox.checked ? 'block' : 'none';
}

// Wire checkbox event
document.addEventListener('DOMContentLoaded', function() {
  const positionNo = '<%= positionNo %>';
  const storageKey = 'km_checkbox_' + positionNo;
  
  const chk = document.getElementById('herstal-checkbox');
  if (!chk) return;
  
  // Restore checkbox state from localStorage
  const savedState = localStorage.getItem(storageKey);
  if (savedState) {
    try {
      const state = JSON.parse(savedState);
      if (state.herstal) {
        chk.checked = true;
        // Trigger display update after a short delay
        setTimeout(() => {
          const modalValEl = document.getElementById('modal-distance-value');
          let td = 0;
          if (modalValEl && modalValEl.textContent) {
            const txt = modalValEl.textContent.replace(/[^0-9\.,-]/g, '').replace(',', '.');
            td = parseFloat(txt) || 0;
          }
          updateHerstalDisplay(td);
        }, 100);
      }
    } catch(e) {}
  }
  
  chk.addEventListener('change', function() {
    // Save checkbox state to localStorage
    const avrupaChk = document.getElementById('avrupa-checkbox');
    const state = {
      herstal: chk.checked,
      avrupa: avrupaChk ? avrupaChk.checked : false
    };
    localStorage.setItem(storageKey, JSON.stringify(state));
    
    // try to read displayed total from modal-distance-value
    const modalValEl = document.getElementById('modal-distance-value');
    let td = 0;
    if (modalValEl && modalValEl.textContent) {
      const txt = modalValEl.textContent.replace(/[^0-9\.,-]/g, '').replace(',', '.');
      td = parseFloat(txt) || 0;
    }
    updateHerstalDisplay(td);
  });
});

// Macaristan koordinatlarÄ± (hedef nokta)
const MACARISTAN_COORDS = { lat: 47.8465963, lon: 17.2571754 };
// Rozvadov (Ã‡ekya-Almanya sÄ±nÄ±rÄ±) - Avusturya yerine Ã‡ekya Ã¼zerinden geÃ§iÅŸ
const ROZVADOV_COORDS = { lat: 49.6589, lon: 12.5511 };

// OSRM'den mesafe hesapla (tek nokta)
async function getRouteDistance(lon1, lat1, lon2, lat2) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.code === 'Ok' && data.routes && data.routes[0]) {
      return Math.round(data.routes[0].distance / 1000); // metre -> km
    }
  } catch (e) {
    console.warn('Route distance calculation failed:', e);
  }
  return null;
}

// OSRM'den Rozvadov Ã¼zerinden Macaristan'a mesafe hesapla (waypoint ile)
async function getRouteDistanceViaRozvadov(lon1, lat1) {
  try {
    // BaÅŸlangÄ±Ã§ -> Rozvadov -> Macaristan
    const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${ROZVADOV_COORDS.lon},${ROZVADOV_COORDS.lat};${MACARISTAN_COORDS.lon},${MACARISTAN_COORDS.lat}?overview=false`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.code === 'Ok' && data.routes && data.routes[0]) {
      return Math.round(data.routes[0].distance / 1000); // metre -> km
    }
  } catch (e) {
    console.warn('Route via Rozvadov calculation failed:', e);
  }
  return null;
}

// Avrupa Mazot Hesaplama
async function updateAvrupaDisplay(totalKm) {
  const panel = document.getElementById('avrupa-panel');
  const checkbox = document.getElementById('avrupa-checkbox');
  if (!panel || !checkbox) return;

  const totalEl = document.getElementById('avrupa-total');
  const macarKmEl = document.getElementById('avrupa-macar-km');
  const finalEl = document.getElementById('avrupa-final');
  const mazotUsedEl = document.getElementById('avrupa-mazot-used');
  const mazotResultEl = document.getElementById('avrupa-mazot-result');

  // Toplam mesafeyi 20'nin katÄ±na yuvarla (yukarÄ±)
  const roundedTotalKm = Math.ceil(totalKm / 20) * 20;
  if (totalEl) totalEl.textContent = `${roundedTotalKm} km`;

  // Son segment'ten Rozvadov Ã¼zerinden Macaristan'a mesafe hesapla
  let macarKm = 0;
  if (distanceSegments.length > 0) {
    const lastSeg = distanceSegments[distanceSegments.length - 1];
    if (lastSeg.lat2 != null && lastSeg.lon2 != null) {
      // Loading gÃ¶stergesi
      if (macarKmEl) macarKmEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rozvadov Ã¼zerinden hesaplanÄ±yor...';
      
      // Rozvadov (Ã‡ekya) Ã¼zerinden Macaristan'a rota
      const routeKm = await getRouteDistanceViaRozvadov(lastSeg.lon2, lastSeg.lat2);
      if (routeKm !== null) {
        macarKm = routeKm;
      } else {
        // Fallback: direkt rota dene
        const directKm = await getRouteDistance(lastSeg.lon2, lastSeg.lat2, MACARISTAN_COORDS.lon, MACARISTAN_COORDS.lat);
        if (directKm !== null) {
          macarKm = directKm;
        } else {
          // Son fallback: Haversine formÃ¼lÃ¼ ile kuÅŸ bakÄ±ÅŸÄ± mesafe
          const R = 6371;
          const dLat = (MACARISTAN_COORDS.lat - lastSeg.lat2) * Math.PI / 180;
          const dLon = (MACARISTAN_COORDS.lon - lastSeg.lon2) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lastSeg.lat2 * Math.PI / 180) * Math.cos(MACARISTAN_COORDS.lat * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          macarKm = Math.round(R * c * 1.3); // 1.3 faktÃ¶rÃ¼ yol katsayÄ±sÄ±
        }
      }
    }
  }

  if (macarKmEl) macarKmEl.textContent = `${macarKm} km (Rozvadov Ã¼zerinden)`;

  // Toplam = YuvarlanmÄ±ÅŸ toplam mesafe + Macaristan mesafesi + 1400
  const grandTotal = roundedTotalKm + macarKm + 1400;
  if (finalEl) finalEl.textContent = `${grandTotal.toFixed(0)} km`;

  // Harcanan mazot = grandTotal * 0.3
  const mazotUsed = grandTotal * 0.3;
  if (mazotUsedEl) mazotUsedEl.textContent = `${mazotUsed.toFixed(1)} lt`;

  // Kalan mazot = 1450 - harcanan (round to nearest 10)
  const mazotResult = Math.ceil((1450 - mazotUsed) / 10) * 10;
  if (mazotResultEl) mazotResultEl.textContent = `${mazotResult} lt`;

  // KALAN MAZOT label'Ä±nÄ± gÃ¼ncelle - deÄŸeri gÃ¶ster
  const kalanLabelEl = document.getElementById('avrupa-kalan-label');
  if (kalanLabelEl) {
    kalanLabelEl.textContent = `KALAN MAZOT (1450 - ${mazotUsed.toFixed(0)})`;
  }

  // MACAR = 600'e tamamla (600 - kalanMazot)
  const macarResultEl = document.getElementById('avrupa-macar-result');
  if (macarResultEl) {
    const macarValue = 600 - mazotResult;
    if (macarValue <= 0) {
      macarResultEl.textContent = 'YOK';
      macarResultEl.style.color = '#ff6b6b';
      macarResultEl.style.textShadow = '0 0 10px rgba(255,107,107,0.5)';
    } else {
      macarResultEl.textContent = `${macarValue} lt`;
      macarResultEl.style.color = '#ffffff';
      macarResultEl.style.textShadow = '0 0 10px rgba(255,255,255,0.5)';
    }
  }

  // show/hide panel based on checkbox
  panel.style.display = checkbox.checked ? 'block' : 'none';
}

// Avrupa checkbox event
document.addEventListener('DOMContentLoaded', function() {
  const positionNo = '<%= positionNo %>';
  const storageKey = 'km_checkbox_' + positionNo;
  
  const chk = document.getElementById('avrupa-checkbox');
  if (!chk) return;
  
  // Restore checkbox state from localStorage
  const savedState = localStorage.getItem(storageKey);
  if (savedState) {
    try {
      const state = JSON.parse(savedState);
      if (state.avrupa) {
        chk.checked = true;
        // Trigger display update after a short delay
        setTimeout(async () => {
          const modalValEl = document.getElementById('modal-distance-value');
          let td = 0;
          if (modalValEl && modalValEl.textContent) {
            const txt = modalValEl.textContent.replace(/[^0-9\.,-]/g, '').replace(',', '.');
            td = parseFloat(txt) || 0;
          }
          await updateAvrupaDisplay(td);
        }, 150);
      }
    } catch(e) {}
  }
  
  chk.addEventListener('change', async function() {
    // Save checkbox state to localStorage
    const herstalChk = document.getElementById('herstal-checkbox');
    const state = {
      herstal: herstalChk ? herstalChk.checked : false,
      avrupa: chk.checked
    };
    localStorage.setItem(storageKey, JSON.stringify(state));
    
    const modalValEl = document.getElementById('modal-distance-value');
    let td = 0;
    if (modalValEl && modalValEl.textContent) {
      const txt = modalValEl.textContent.replace(/[^0-9\.,-]/g, '').replace(',', '.');
      td = parseFloat(txt) || 0;
    }
    await updateAvrupaDisplay(td);
  });
});

// --- Map handling for distance preview (Leaflet) ---
function ensureLeafletLoaded(cb) {
  if (window.L) return cb && cb();
  // add CSS
  if (!document.getElementById('leaflet-css')) {
    const link = document.createElement('link');
    link.id = 'leaflet-css';
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);
  }
  if (!document.getElementById('leaflet-js')) {
    const s = document.createElement('script');
    s.id = 'leaflet-js';
    s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    s.onload = function() { if (cb) cb(); };
    document.body.appendChild(s);
  } else {
    // script exists but L may not be ready yet
    const wait = setInterval(() => { if (window.L) { clearInterval(wait); if (cb) cb(); } }, 50);
  }
}

function initDistanceMap() {
  const container = document.getElementById('distance-map');
  if (!container) return;
  if (!window.L) return;
  // avoid double-init
  if (window.distanceMap) return;
  // clear placeholder content
  container.innerHTML = '';
  container.style.padding = '8px';

  const map = window.L.map(container, { zoomControl: false }).setView([54.0, -2.0], 6);
  window.distanceMap = map;
  window.distanceLayerGroup = window.L.layerGroup().addTo(map);

  window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

// OpenRouteService API Key (Ã¼cretsiz hesap ile 2000 istek/gÃ¼n)
const ORS_API_KEY = '5b3ce3597851110001cf6248a1b2c3d4e5f6a7b8c9d0e1f2'; // Public demo key

// TIR/Kamyon rotasÄ± iÃ§in OpenRouteService veya OSRM kullan
async function getTruckRoute(lon1, lat1, lon2, lat2) {
  // Ã–nce OSRM dene (daha hÄ±zlÄ± ve limitsiz)
  try {
    // OSRM driving profili - TIR iÃ§in de geÃ§erli ana yollarÄ± kullanÄ±r
    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
    const response = await fetch(osrmUrl);
    const data = await response.json();
    if (data.code === 'Ok' && data.routes && data.routes[0]) {
      const route = data.routes[0];
      // Mesafeyi km olarak dÃ¶ndÃ¼r (metre -> km)
      const distanceKm = Math.round(route.distance / 1000);
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      return { coords, distance: distanceKm };
    }
  } catch (e) {
    console.warn('OSRM routing failed:', e);
  }
  return null;
}

// Route cache - aynÄ± koordinatlar iÃ§in tekrar istek atmamak iÃ§in
const routeCache = new Map();

function updateDistanceMap() {
  if (!window.L) return;
  const container = document.getElementById('distance-map');
  if (!container) return;
  ensureLeafletLoaded(async () => {
    initDistanceMap();
    const group = window.distanceLayerGroup;
    group.clearLayers();
    const bounds = [];
    
    // Loading gÃ¶stergesi
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'map-loading';
    loadingDiv.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,0.9);color:#fff;padding:12px 20px;border-radius:8px;z-index:1000;font-size:13px;"><i class="fas fa-truck fa-bounce"></i> TIR rotasÄ± hesaplanÄ±yor...</div>';
    loadingDiv.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;z-index:1000;';
    container.appendChild(loadingDiv);
    
    let routeDistancesUpdated = false;
    
    for (let index = 0; index < distanceSegments.length; index++) {
      const seg = distanceSegments[index];
      if (seg.lat1 == null || seg.lat2 == null) continue;
      
      const color = seg.type === 'loading' ? '#3b82f6' : (seg.type === 'unloading' ? '#22c55e' : (seg.type === 'exit' ? '#f59e0b' : '#8b5cf6'));
      
      // Cache key
      const cacheKey = `truck:${seg.lon1},${seg.lat1};${seg.lon2},${seg.lat2}`;
      let routeData = routeCache.get(cacheKey);
      
      // TIR rotasÄ± al
      if (!routeData) {
        routeData = await getTruckRoute(seg.lon1, seg.lat1, seg.lon2, seg.lat2);
        if (routeData) {
          routeCache.set(cacheKey, routeData);
        }
      }
      
      if (routeData && routeData.coords && routeData.coords.length > 0) {
        // GerÃ§ek yol gÃ¼zergahÄ±nÄ± Ã§iz
        const poly = window.L.polyline(routeData.coords, { 
          color: color, 
          weight: 6, 
          opacity: 0.85,
          lineJoin: 'round',
          lineCap: 'round'
        }).addTo(group);
        
        // Segment mesafesini gerÃ§ek rota mesafesiyle gÃ¼ncelle
        if (routeData.distance && routeData.distance !== seg.distance) {
          seg.distance = routeData.distance;
          seg.routeCalculated = true; // Ä°ÅŸaretleyelim
          routeDistancesUpdated = true;
        }
        
        // TÃ¼m rota noktalarÄ±nÄ± bounds'a ekle
        routeData.coords.forEach(coord => bounds.push(coord));
      } else {
        // Fallback: dÃ¼z Ã§izgi (routing baÅŸarÄ±sÄ±z olursa)
        const latlngs = [ [seg.lat1, seg.lon1], [seg.lat2, seg.lon2] ];
        const poly = window.L.polyline(latlngs, { 
          color: color, 
          weight: 4, 
          opacity: 0.7,
          dashArray: '10, 10' // kesikli Ã§izgi - fallback olduÄŸunu belirtir
        }).addTo(group);
        bounds.push([seg.lat1, seg.lon1]);
        bounds.push([seg.lat2, seg.lon2]);
      }
      
      // BaÅŸlangÄ±Ã§ noktasÄ± iÃ§in TIR ikonu
      const startIcon = window.L.divIcon({
        className: '',
        html: `<div style="background:${color};color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.4);">${index + 1}</div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });
      
      // BitiÅŸ noktasÄ±
      const endIcon = window.L.divIcon({
        className: '',
        html: `<div style="background:#fff;color:${color};width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:3px solid ${color};box-shadow:0 2px 6px rgba(0,0,0,0.3);">âœ“</div>`,
        iconSize: [22, 22],
        iconAnchor: [11, 11]
      });
      
      window.L.marker([seg.lat1, seg.lon1], { icon: startIcon, zIndexOffset: 1000 }).addTo(group);
      window.L.marker([seg.lat2, seg.lon2], { icon: endIcon, zIndexOffset: 999 }).addTo(group);
    }
    
    // Loading gÃ¶stergesini kaldÄ±r
    const loadingEl = document.getElementById('map-loading');
    if (loadingEl) loadingEl.remove();
    
    // EÄŸer mesafeler gÃ¼ncellendiyse listeyi yenile
    if (routeDistancesUpdated) {
      updateDistanceList();
    }
    
    if (bounds.length > 0) {
      try { window.distanceMap.fitBounds(bounds, { padding: [40,40] }); } catch(e) { /* ignore */ }
    }
  });
}

function deleteDistanceSegment(index) {
  distanceSegments.splice(index, 1);
  updateDistanceList();
}

function saveDistanceCalculation() {
  // localStorage'a kaydet (boÅŸ bile olsa)
  const positionNo = '<%= positionNo %>';
  const totalKmAll = distanceSegments.reduce((sum, seg) => sum + seg.distance, 0);
  // For accounting, exclude 'europe' segments
  const totalKm = distanceSegments.filter(seg => seg.type !== 'europe').reduce((sum, seg) => sum + seg.distance, 0);

  const distanceData = {
    segments: distanceSegments,
    // totalKm stored on server is the accounting total (excluding 'europe')
    totalKm: totalKm,
    savedAt: new Date().toISOString(),
    // include full total for client-side reference if needed
    totalKmAll: totalKmAll
  };
  
  // No localStorage persistence anymore â€” rely on server-stored KM only
  
  // AyrÄ±ca backend'e kaydet (DB) â€” accounting sayfasÄ± iÃ§in
  try {
    // Counts for accounting should exclude 'europe' segments
  function shortAddr(addr) {
    if (!addr) return '-';
    try {
      const parts = addr.split(',').map(s => s.trim()).filter(Boolean);
      // UK postcode heuristic
      const postcodeRegex = /[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}/i;
      let postcode = null;
      let city = null;
      let country = null;

      for (let i = 0; i < parts.length; i++) {
        const p = parts[i];
        const m = p.match(postcodeRegex);
        if (m) {
          postcode = m[0];
          // prefer remaining text in same part as city, else next part
          const remaining = p.replace(m[0], '').trim();
          if (remaining) city = remaining;
          else if (parts[i+1]) city = parts[i+1];
          break;
        }
      }

      if (!postcode) {
        // fallback: if first part starts with code-like token (e.g. CT16 1JA ...)
        const m2 = parts[0] && parts[0].match(/[A-Z0-9]{2,}\s*[A-Z0-9]{1,}/i);
        if (m2) postcode = m2[0];
      }

      if (!city) {
        // pick first meaningful part that isn't a country or region word
        const blacklist = ['england','united kingdom','uk','france','germany','spain','italy'];
        for (let i=0;i<parts.length;i++) {
          const p = parts[i];
          const pl = p.toLowerCase();
          if (postcode && p.indexOf(postcode) !== -1) continue;
          if (blacklist.some(b => pl.includes(b))) continue;
          if (p.length > 1 && p.length < 60) { city = p; break; }
        }
      }

      // try to detect country as a trailing part (last segment that's not city/postcode)
      for (let i = parts.length - 1; i >= 0; i--) {
        const p = parts[i];
        const pl = p.toLowerCase();
        if (city && p === city) continue;
        if (postcode && p.indexOf(postcode) !== -1) continue;
        // skip common region tokens
        const skip = ['england','united kingdom','uk','county','state','region'];
        if (skip.some(s => pl === s || pl.includes(s))) continue;
        // consider this as country
        country = parts[i];
        break;
      }

      if (!postcode && parts.length) postcode = parts[0].split(' ').slice(0,2).join(' ');
      if (!city && parts.length > 1) city = parts[1];

      // include country if available
      if (postcode && city && country) return postcode + ', ' + city + ', ' + country;
      if (postcode && city) return postcode + ', ' + city;
      if (postcode && country) return postcode + ', ' + country;
      if (postcode) return postcode;
      if (city && country) return city + ', ' + country;
      if (city) return city;
      // final fallback: trim long address
      return parts[0].length > 60 ? parts[0].slice(0,60) + 'â€¦' : parts[0];
    } catch (e) {
      return addr;
    }
  }
    const loadingCount = distanceSegments.filter(s => s.type === 'loading').length;
    const unloadingCount = distanceSegments.filter(s => s.type === 'unloading').length;
    const europeCount = distanceSegments.filter(s => s.type === 'europe').length;
    const herstalFlag = (document.getElementById('herstal-checkbox') && document.getElementById('herstal-checkbox').checked) ? 1 : 0;

    fetch(`/api/position/${encodeURIComponent(positionNo)}/km`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        segments: distanceSegments,
        // use camelCase keys to match server-side model expectations
        totalKm: totalKm,
        totalKmAll: totalKmAll,
        europeCount: europeCount,
        loadingCount: loadingCount,
        unloadingCount: unloadingCount,
        herstal: herstalFlag
      })
    }).then(resp => resp.json()).then(data => {
      if (!data || !data.success) {
        console.warn('Position KM save responded with error', data);
        showMrnModal('AraÃ§ KM sunucuya kaydedilemedi: ' + (data && data.error ? data.error : 'Sunucu hatasÄ±'), 'error');
        return;
      }
      // Only update UI and close modal after successful server save
      // update button with accounting total (excluding Europe) and show subtotals / all-total
      const loadingDistance = distanceSegments.filter(s=>s.type==='loading').reduce((s,x)=>s+(Number(x.distance)||0),0);
      const unloadingDistance = distanceSegments.filter(s=>s.type==='unloading').reduce((s,x)=>s+(Number(x.distance)||0),0);
      const exitDistance = distanceSegments.filter(s=>s.type==='exit').reduce((s,x)=>s+(Number(x.distance)||0),0);
      const europeDistance = distanceSegments.filter(s=>s.type==='europe').reduce((s,x)=>s+(Number(x.distance)||0),0);
      const europeSegments = distanceSegments.filter(s=>s.type==='europe').map(s => Number(s.distance) || 0);
      updateButtonTotalKm({ accountingTotal: totalKm, loadingDistance, unloadingDistance, exitDistance, europeDistance, europeSegments, totalAll: totalKmAll });
      hideModal('distanceCalculatorModal');
      showMrnModal('AraÃ§ KM hesabÄ± kaydedildi!', 'success', 'ARAÃ‡ KM BÄ°LDÄ°RÄ°MÄ°');
    }).catch(err => {
      console.warn('Error saving position KM to server:', err);
      showMrnModal('AraÃ§ KM sunucuya kaydedilemedi: ' + err.message, 'error');
    });
  } catch (e) {
    console.error('Error preparing position KM save:', e);
  }
  
}

function exportKmPdf() {
  const positionNo = '<%= positionNo %>';
  if (!distanceSegments || !distanceSegments.length) {
    showMrnModal('Ã–nce mesafeleri hesaplayÄ±n ve segment ekleyin', 'warning');
    return;
  }
  const totalKmAll = distanceSegments.reduce((sum, seg) => sum + (Number(seg.distance)||0), 0);
  const totalKm = distanceSegments.filter(seg => seg.type !== 'europe').reduce((sum, seg) => sum + (Number(seg.distance)||0), 0);
  
  // Ä°ngiltere Ã‡Ä±kÄ±ÅŸ Mazot HesabÄ± checkbox
  const ingiltereFlag = (document.getElementById('herstal-checkbox') && document.getElementById('herstal-checkbox').checked) ? 1 : 0;
  
  // Avrupa Mazot HesabÄ± checkbox ve verileri
  const avrupaFlag = (document.getElementById('avrupa-checkbox') && document.getElementById('avrupa-checkbox').checked) ? 1 : 0;
  
  // Avrupa hesabÄ± verilerini topla
  let avrupaData = {};
  if (avrupaFlag) {
    // HTML'deki ID'leri kullanarak deÄŸerleri al
    const avrupaTotalEl = document.getElementById('avrupa-total');
    const avrupaMacarKmEl = document.getElementById('avrupa-macar-km');
    const avrupaFinalEl = document.getElementById('avrupa-final');
    const avrupaMazotUsedEl = document.getElementById('avrupa-mazot-used');
    const avrupaMazotResultEl = document.getElementById('avrupa-mazot-result');
    const avrupaMacarResultEl = document.getElementById('avrupa-macar-result');
    
    avrupaData = {
      totalKm: avrupaTotalEl ? parseFloat(avrupaTotalEl.textContent) || 0 : 0,
      macarKm: avrupaMacarKmEl ? parseFloat(avrupaMacarKmEl.textContent) || 0 : 0,
      grandTotal: avrupaFinalEl ? parseFloat(avrupaFinalEl.textContent) || 0 : 0,
      mazotUsed: avrupaMazotUsedEl ? parseFloat(avrupaMazotUsedEl.textContent) || 0 : 0,
      kalanMazot: avrupaMazotResultEl ? parseFloat(avrupaMazotResultEl.textContent) || 0 : 0,
      macar: avrupaMacarResultEl ? (avrupaMacarResultEl.textContent === 'YOK' ? 0 : parseFloat(avrupaMacarResultEl.textContent) || 0) : 0
    };
  }

  const payload = { 
    segments: distanceSegments, 
    totalKm: totalKm, 
    totalKmAll: totalKmAll, 
    herstal: ingiltereFlag,
    avrupa: avrupaFlag,
    avrupaData: avrupaData
  };
  const url = `/loads/position/${encodeURIComponent(positionNo)}/km-pdf`;
  // disable button to avoid double clicks
  const btn = document.getElementById('export-pdf-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'HazÄ±rlanÄ±yor...'; }

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(async resp => {
    if (!resp.ok) {
      const txt = await resp.text();
      showMrnModal('PDF oluÅŸturulamadÄ±: ' + txt, 'error');
      return;
    }
    const blob = await resp.blob();
    // Open in new tab instead of downloading
    const blobUrl = window.URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
  }).catch(err => {
    console.error('PDF export error', err);
    showMrnModal('PDF oluÅŸturulurken hata oluÅŸtu: ' + err.message, 'error');
  }).finally(() => { if (btn) { btn.disabled = false; btn.textContent = 'PDF Olarak DÄ±ÅŸa Aktar'; } });
}

function updateButtonTotalKm(totalKm) {
  // totalKm may be a number (accounting total) or an object with subtotals/totalAll
  const summary = document.getElementById('btn-km-summary');
  const accEl = document.getElementById('btn-acc-km');
  const subtEl = document.getElementById('btn-subtotals');
  const totalAllEl = document.getElementById('btn-totalall');
  if (!summary || !accEl || !subtEl || !totalAllEl) return;

  let acc = 0;
  let load = 0, unload = 0, exit = 0, totalAll = 0;
  let eu = 0;
  let euList = [];

  if (typeof totalKm === 'object' && totalKm !== null) {
    acc = Number(totalKm.accountingTotal || totalKm.totalKm || 0) || 0;
    load = Number(totalKm.loadingDistance || 0) || 0;
    unload = Number(totalKm.unloadingDistance || 0) || 0;
    exit = Number(totalKm.exitDistance || 0) || 0;
    totalAll = Number(totalKm.totalAll || 0) || 0;
    eu = Number(totalKm.europeDistance || totalKm.europe || 0) || 0;
    euList = Array.isArray(totalKm.europeSegments) ? totalKm.europeSegments.map(x=>Number(x)||0) : [];
  } else {
    acc = Number(totalKm) || 0;
    // if we only have acc number, try to compute subtotals from distanceSegments if present
    if (window.distanceSegments && Array.isArray(window.distanceSegments)) {
      load = window.distanceSegments.filter(s => s.type === 'loading').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      unload = window.distanceSegments.filter(s => s.type === 'unloading').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      exit = window.distanceSegments.filter(s => s.type === 'exit').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      totalAll = window.distanceSegments.reduce((s, x) => s + (Number(x.distance) || 0), 0);
    }
  }

  // render
  if (acc > 0 || totalAll > 0) {
    accEl.textContent = acc.toFixed(1) + ' km';
    subtEl.textContent = `YÃ¼kleme: ${load.toFixed(1)} | BoÅŸaltma: ${unload.toFixed(1)} | Ã‡Ä±kÄ±ÅŸ: ${exit.toFixed(1)}`;
    // Europe pill and list
    const euEl = document.getElementById('btn-eu-km');
    const euListEl = document.getElementById('btn-eu-list');
    if (euEl) euEl.textContent = eu.toFixed(1) + ' km';
    if (euListEl) euListEl.textContent = euList.length ? ('Avrupa segmentleri: ' + euList.map(n => n.toFixed(1)).join(', ')) : 'Avrupa YÃ¼kleme: -';
    // write emphasized total into the new pill
    const totalValEl = document.getElementById('btn-totalall-val');
    if (totalValEl) totalValEl.textContent = totalAll.toFixed(1) + ' km';
    summary.style.display = 'block';
  } else {
    summary.style.display = 'none';
  }
}

function openDistanceCalculator() {
  const positionNo = '<%= positionNo %>';
  
  // Prefer saved data from server (shared across machines). Fallback to localStorage.
  distanceSegments = [];
  // Load segments from server only (no localStorage fallback)
  distanceSegments = [];
  fetch(`/api/position/${encodeURIComponent(positionNo)}/km`).then(r => r.json()).then(serverData => {
    if (serverData && serverData.success && serverData.km) {
      try { distanceSegments = serverData.km.segments && typeof serverData.km.segments === 'string' ? JSON.parse(serverData.km.segments) : (serverData.km.segments || []); } catch(e) { distanceSegments = serverData.km.segments || []; }
      // set HERSTAL checkbox from saved value
      try {
        const chk = document.getElementById('herstal-checkbox');
        if (chk) chk.checked = !!serverData.km.herstal;
      } catch (e) { /* ignore */ }
    } else {
      distanceSegments = [];
    }
    updateDistanceList();
    (function(){
      const f = document.getElementById('modal-postcode-from');
      const t = document.getElementById('modal-postcode-to');
      if (f) { f.value = ''; f.dataset.lat=''; f.dataset.lon=''; const c = document.getElementById('modal-postcode-from-suggestions'); if (c) { c.innerHTML=''; c.style.display='none'; } }
      if (t) { t.value = ''; t.dataset.lat=''; t.dataset.lon=''; const c2 = document.getElementById('modal-postcode-to-suggestions'); if (c2) { c2.innerHTML=''; c2.style.display='none'; } }
    })();
    document.getElementById('distanceCalculatorModal').classList.add('active');
    ensureLeafletLoaded(function() { setTimeout(function() { try { initDistanceMap(); updateDistanceMap(); if (window.distanceMap && window.distanceMap.invalidateSize) window.distanceMap.invalidateSize(); } catch(e){} }, 80); });
  }).catch(err => {
    // If server request fails, just open empty modal (no local data)
    distanceSegments = [];
    updateDistanceList();
    (function(){
      const f = document.getElementById('modal-postcode-from');
      const t = document.getElementById('modal-postcode-to');
      if (f) { f.value = ''; f.dataset.lat=''; f.dataset.lon=''; const c = document.getElementById('modal-postcode-from-suggestions'); if (c) { c.innerHTML=''; c.style.display='none'; } }
      if (t) { t.value = ''; t.dataset.lat=''; t.dataset.lon=''; const c2 = document.getElementById('modal-postcode-to-suggestions'); if (c2) { c2.innerHTML=''; c2.style.display='none'; } }
    })();
    document.getElementById('distanceCalculatorModal').classList.add('active');
    ensureLeafletLoaded(function() { setTimeout(function() { try { initDistanceMap(); updateDistanceMap(); if (window.distanceMap && window.distanceMap.invalidateSize) window.distanceMap.invalidateSize(); } catch(e){} }, 80); });
  });
}

// Sayfa yÃ¼klendiÄŸinde kaydedilmiÅŸ km'yi butonda gÃ¶ster
document.addEventListener('DOMContentLoaded', function() {
  const positionNo = '<%= positionNo %>';
  // Use server value only (no localStorage fallback)
  fetch(`/api/position/${encodeURIComponent(positionNo)}/km`).then(r => r.json()).then(serverData => {
    if (serverData && serverData.success && serverData.km) {
      // accounting total stored in DB
      const accTotal = Number(serverData.km.total_km) || 0;
      // try to parse segments to compute subtotals and totalAll
      let segments = [];
      try { segments = serverData.km.segments && typeof serverData.km.segments === 'string' ? JSON.parse(serverData.km.segments) : (serverData.km.segments || []); } catch (e) { segments = serverData.km.segments || []; }
      const loadingDistance = segments.filter(s => s.type === 'loading').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      const unloadingDistance = segments.filter(s => s.type === 'unloading').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      const exitDistance = segments.filter(s => s.type === 'exit').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      const europeDistance = segments.filter(s => s.type === 'europe').reduce((s, x) => s + (Number(x.distance) || 0), 0);
      const europeSegments = segments.filter(s => s.type === 'europe').map(s => Number(s.distance) || 0);
      const totalAll = segments.reduce((s, x) => s + (Number(x.distance) || 0), 0);

      updateButtonTotalKm({ accountingTotal: accTotal, loadingDistance, unloadingDistance, exitDistance, europeDistance, europeSegments, totalAll });
      // also set global distanceSegments so updateButtonTotalKm fallback can use it
      window.distanceSegments = segments;
    }
  }).catch(err => {
    // on error: do not show any local value
  });
});

async function calculateUKDistance() {
  const fromPostcode = document.getElementById('postcode-from').value.trim().toUpperCase();
  const toPostcode = document.getElementById('postcode-to').value.trim().toUpperCase();
  const resultDiv = document.getElementById('uk-distance-result');
  const resultText = resultDiv.querySelector('div:last-child');
  
  if (!fromPostcode || !toPostcode) {
    showMrnModal('LÃ¼tfen her iki posta kodunu da girin', 'warning');
    return;
  }
  
  try {
    // Use shared geocoder (postcodes.io first, then Nominatim fallback)
    const fromCoords = await geocodePostcode(fromPostcode);
    if (!fromCoords) {
      showMrnModal('BaÅŸlangÄ±Ã§ posta kodu bulunamadÄ±', 'error');
      return;
    }

    const toCoords = await geocodePostcode(toPostcode);
    if (!toCoords) {
      showMrnModal('BitiÅŸ posta kodu bulunamadÄ±', 'error');
      return;
    }

    // KoordinatlarÄ± al
    const lat1 = fromCoords.lat;
    const lon1 = fromCoords.lon;
    const lat2 = toCoords.lat;
    const lon2 = toCoords.lon;
    
    // OSRM API kullanarak gerÃ§ek yol mesafesi hesapla
    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
    
    try {
      const osrmResponse = await fetch(osrmUrl);
      const osrmData = await osrmResponse.json();
      
      if (osrmData.code === 'Ok' && osrmData.routes && osrmData.routes.length > 0) {
        const distanceInMeters = osrmData.routes[0].distance;
        const distance = distanceInMeters / 1000; // km'ye Ã§evir
        
        // Sonucu gÃ¶ster
        resultText.textContent = distance.toFixed(1) + ' km';
        resultDiv.style.display = 'block';
        showMrnModal(`Yol Mesafesi: ${distance.toFixed(1)} km`, 'success');
        return;
      }
    } catch (osrmError) {
      console.log('OSRM hatasÄ±, tahmini hesaplama yapÄ±lÄ±yor:', osrmError);
    }
    
    // OSRM Ã§alÄ±ÅŸmazsa Haversine formÃ¼lÃ¼ ile tahmini hesapla (1.35 katsayÄ±lÄ±)
    const R = 6371; // DÃ¼nya yarÄ±Ã§apÄ± km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const straightDistance = R * c;
    const estimatedRoadDistance = straightDistance * 1.35; // ~35% daha fazla
    
    resultText.textContent = estimatedRoadDistance.toFixed(1) + ' km (tahmini)';
    resultDiv.style.display = 'block';
    showMrnModal(`Tahmini Mesafe: ${estimatedRoadDistance.toFixed(1)} km`, 'success');
    
  } catch (error) {
    showMrnModal('Mesafe hesaplanÄ±rken hata oluÅŸtu', 'error');
    console.error(error);
  }
}

function showMrnModal(message, type = 'success', title) {
  // remove existing
  const existingModal = document.getElementById('mrn-modal');
  if (existingModal) existingModal.remove();

  const iconMap = {
    success: 'âœ“',
    error: 'Ã—',
    warning: 'âš '
  };

  const colorMap = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b'
  };

  const modal = document.createElement('div');
  modal.id = 'mrn-modal';
  modal.className = 'modal-overlay active';
  modal.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.55); z-index:100000; padding:20px;';
  modal.tabIndex = -1;

  const cardHtml = `
    <div style="width:360px; max-width:100%; background: linear-gradient(180deg, #071126, #0b1220); color: #e6eef6; border-radius:12px; padding:18px; box-shadow: 0 18px 50px rgba(2,6,23,0.6); border: 1px solid rgba(148,163,184,0.06);">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="width:40px; height:40px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:${colorMap[type]}; color:white; font-weight:700; font-size:18px;">${iconMap[type]}</div>
        <div style="font-size:15px; font-weight:700;">${title || 'MRN NO'}</div>
      </div>
      <div style="font-size:14px; color:#cbd5e1; margin-bottom:14px; line-height:1.35;">${message}</div>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button id="mrn-ok-btn" style="background:#3b82f6; color:white; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;">Tamam</button>
      </div>
    </div>
  `;

  modal.innerHTML = cardHtml;
  document.body.appendChild(modal);

  // focus so ESC works
  modal.focus();

  // auto-close after 3s
  const autoClose = setTimeout(closeMrnModal, 3000);

  // handlers
  const okBtn = document.getElementById('mrn-ok-btn');
  if (okBtn) okBtn.addEventListener('click', () => { clearTimeout(autoClose); closeMrnModal(); });

  // close on overlay click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) { clearTimeout(autoClose); closeMrnModal(); }
  });

  // ESC key
  function escHandler(e) { if (e.key === 'Escape') { clearTimeout(autoClose); closeMrnModal(); } }
  document.addEventListener('keydown', escHandler);

  // remove esc handler when modal closes
  // wrap original close to remove handler
  const originalClose = window.closeMrnModal;
  window.closeMrnModal = function() {
    document.removeEventListener('keydown', escHandler);
    if (originalClose) originalClose();
  };
}

function closeMrnModal() {
  const modal = document.getElementById('mrn-modal');
  if (modal) modal.remove();
}

// Pozisyon Bilgileri Modal
function updatePositionInlineDriver() {
  const truckSelect = document.getElementById('pos_inline_truck_plate');
  const driverInput = document.getElementById('pos_inline_driver_name');
  if (!truckSelect || !driverInput) return;
  const selectedOption = truckSelect.options[truckSelect.selectedIndex];
  const driverName = selectedOption ? (selectedOption.getAttribute('data-driver') || '') : '';
  driverInput.value = driverName;
}

function resetPositionInlineForm() {
  const truck = <%- JSON.stringify(loads[0].truck_plate || '') %>;
  const trailer = <%- JSON.stringify(loads[0].trailer_plate || '') %>;
  const driver = <%- JSON.stringify(loads[0].driver_name || '') %>;
  const loadingDate = <%- JSON.stringify(loads[0].loading_date || '') %>;
  const unloadingDate = <%- JSON.stringify(loads[0].unloading_date || '') %>;

  const truckEl = document.getElementById('pos_inline_truck_plate');
  const trailerEl = document.getElementById('pos_inline_trailer_plate');
  const driverEl = document.getElementById('pos_inline_driver_name');
  const loadingEl = document.getElementById('pos_inline_loading_date');
  const unloadingEl = document.getElementById('pos_inline_unloading_date');

  if (truckEl) truckEl.value = truck;
  if (trailerEl) trailerEl.value = trailer;
  if (driverEl) driverEl.value = driver;
  if (loadingEl) loadingEl.value = loadingDate;
  if (unloadingEl) unloadingEl.value = unloadingDate;
}
</script>

<!-- Inline position info form moved into header (modal removed) -->

<!-- Mail Modal -->
<div id="mailModalPosition" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;" onclick="if(event.target === this) closeMailModal();">
  <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 900px; width: 100%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); max-height: 90vh; overflow-y: auto;">
    <!-- Modal Header -->
    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 24px 32px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
      <div id="mail_modal_header_title" style="font-size: 24px; font-weight: 700; color: white; letter-spacing: 0.5px;">YÃ¼kleme Bilgisi</div>
      <button onclick="hideMailModalPosition()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; width: 36px; height: 36px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">&times;</button>
    </div>
    
    <!-- Modal Body -->
    <div style="padding: 32px;">
      <!-- Ãœst Bilgi Tablosu -->
      <div style="margin-bottom: 24px; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af; width: 20%;">Kime</td>
            <td style="padding: 14px 20px; background: white; border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_customer_name_pos"></td>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af; width: 20%;">Tarih</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_date_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Konu</td>
            <td style="padding: 14px 20px; background: white; border-right: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_subject_pos"></td>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Pozisyon No</td>
            <td style="padding: 14px 20px; background: white; color: #1f2937; font-weight: 500;" id="mail_position_no_pos"></td>
          </tr>
        </table>
      </div>

      <!-- AÃ§Ä±klama Metni -->
      <div id="mail_intro_text" style="background: #f9fafb; padding: 16px 20px; color: #374151; margin-bottom: 8px; font-style: italic; font-size: 14px; border-left: 4px solid #3b82f6; border-radius: 4px;">
        Ä°ngiltere'den adÄ±nÄ±za alÄ±nan sevkiyata ait yÃ¼kleme bilgileri aÅŸaÄŸÄ±da bilginize sunulmuÅŸtur.
      </div>
      <div id="mail_gate_line" style="background: transparent; padding: 0 20px 16px 20px; color: #374151; margin-bottom: 16px; font-weight:600; display:none;">
        GiriÅŸ KapÄ±sÄ± - KapÄ±kule
      </div>

      <!-- YÃ¼kleme Bilgileri Tablosu -->
      <div style="border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af; width: 30%;">GÃ¶nderen</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_sender_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">AlÄ±cÄ±</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_consignee_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Kap Adedi</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_packages_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Malzeme Cinsi</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_goods_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">BrÃ¼t AÄŸÄ±rlÄ±k</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_weight_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">AraÃ§ PlakasÄ±</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_truck_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">VarÄ±ÅŸ GÃ¼mrÃ¼ÄŸÃ¼</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_customs_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Ã‡Ä±kÄ±ÅŸ Tarihi</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_exit_date_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; border-bottom: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">VarÄ±ÅŸ Tarihi</td>
            <td style="padding: 14px 20px; background: white; border-bottom: 1px solid #e5e7eb; color: #1f2937; font-weight: 500;" id="mail_arrival_date_pos"></td>
          </tr>
          <tr>
            <td style="padding: 14px 20px; background: #dbeafe; border-right: 1px solid #bfdbfe; font-weight: 600; color: #1e40af;">Malla Gelen Evraklar</td>
            <td style="padding: 14px 20px; background: white; color: #1f2937; font-weight: 500;">Fatura</td>
          </tr>
        </table>
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div style="padding: 24px 32px; border-top: 2px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; background: #f9fafb; border-radius: 0 0 12px 12px;">
      <button onclick="hideMailModalPosition()" style="padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; background: #e5e7eb; color: #374151; border: none; transition: all 0.2s;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">Kapat</button>
      <button onclick="copyMailContentPosition()" style="padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; background: #22c55e; color: white; border: none; transition: all 0.2s; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);" onmouseover="this.style.background='#16a34a'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(34, 197, 94, 0.4)'" onmouseout="this.style.background='#22c55e'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(34, 197, 94, 0.3)'">ğŸ“‹ Kopyala</button>
      <button onclick="sendMailPosition()" style="padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white; border: none; transition: all 0.2s; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)'">âœ‰ï¸ Mail GÃ¶nder</button>
    </div>
  </div>
</div>

<script>
  // Position-level fallback values (from loads[0])
  window.positionInfo = {
    truck_plate: <%- JSON.stringify(loads[0].truck_plate || '') %>,
    trailer_plate: <%- JSON.stringify(loads[0].trailer_plate || '') %>,
    loading_date: <%- JSON.stringify(loads[0].loading_date || '') %>,
    arrival_date: <%- JSON.stringify(loads[0].arrival_date || '') %>,
    unloading_date: <%- JSON.stringify(loads[0].unloading_date || '') %>
  };

function formatDatePos(dateStr) {
  if (!dateStr) return '-';
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return `${parts[2]}.${parts[1]}.${parts[0]}`;
  }
  return dateStr;
}

function openMailModalForLoad(loadData, mode) {
  if (!mode) mode = 'yukleme';
  const today = new Date();
  const dateStr = today.toLocaleDateString('tr-TR');
  
  // Store current load's ref value for mail sending
  window.currentMailLoadRef = loadData.ref || '';
  
  document.getElementById('mail_customer_name_pos').textContent = loadData.consignee_name || '-';
  document.getElementById('mail_date_pos').textContent = dateStr;
  document.getElementById('mail_subject_pos').textContent = 'Ä°ngiltere-Ä°stanbul Nakliyesi';
  document.getElementById('mail_position_no_pos').textContent = loadData.position_no || '-';
  document.getElementById('mail_sender_pos').textContent = loadData.customer_name || '-';
  document.getElementById('mail_consignee_pos').textContent = loadData.consignee_name || '-';
  document.getElementById('mail_packages_pos').textContent = (loadData.packages || '-') + ' PK';
  document.getElementById('mail_goods_pos').textContent = loadData.goods_description || '-';
  document.getElementById('mail_weight_pos').textContent = (loadData.gross_weight || '-') + ' KG';
  
  const truckInfo = loadData.trailer_plate || window.positionInfo.trailer_plate || window.positionInfo.truck_plate || '-';
  document.getElementById('mail_truck_pos').textContent = truckInfo;
  
  const customsInfo = (loadData.unloading_country || 'Ã‡erkezkÃ¶y') + ' / ' + (loadData.unloading_city || 'Aksa') + ' Antrepo';
  document.getElementById('mail_customs_pos').textContent = customsInfo;
  document.getElementById('mail_exit_date_pos').textContent = formatDatePos(loadData.loading_date || window.positionInfo.loading_date);
  document.getElementById('mail_arrival_date_pos').textContent = formatDatePos(loadData.arrival_date || loadData.unloading_date || window.positionInfo.arrival_date || window.positionInfo.unloading_date);

  // mode specific text (yukleme | varis)
  const headerEl = document.getElementById('mail_modal_header_title');
  const introEl = document.getElementById('mail_intro_text');
  const gateEl = document.getElementById('mail_gate_line');
  if (mode === 'varis') {
    headerEl.textContent = 'VarÄ±ÅŸ Bilgisi';
    introEl.textContent = 'LÃ¼tfen Antrepo Beyannamesinin acil aÃ§Ä±lmasÄ±nÄ± rica ederim.';
    // make intro text bold, red and larger for VarÄ±ÅŸ
    introEl.style.color = '#ef4444';
    introEl.style.fontWeight = '700';
    introEl.style.fontSize = '16px';
    introEl.style.padding = '14px 20px';
    gateEl.style.display = 'block';
  } else {
    headerEl.textContent = 'YÃ¼kleme Bilgisi';
    introEl.textContent = "Ä°ngiltere'den adÄ±nÄ±za alÄ±nan sevkiyata ait yÃ¼kleme bilgileri aÅŸaÄŸÄ±da bilginize sunulmuÅŸtur.";
    // reset any inline styles when not varis
    introEl.style.color = '#1e3a8a';
    introEl.style.fontWeight = 'normal';
    introEl.style.fontSize = '';
    introEl.style.padding = '12px 15px';
    gateEl.style.display = 'none';
  }

  // record mode on modal for later use by send function
  const mailModalEl = document.getElementById('mailModalPosition');
  if (mailModalEl) {
    mailModalEl.dataset.mode = mode;
  }
  // also keep a global reference
  window.currentMailModalMode = mode;

  document.getElementById('mailModalPosition').style.display = 'flex';
}

function hideMailModalPosition() {
  document.getElementById('mailModalPosition').style.display = 'none';
}

function copyMailContentPosition() {
  const subject = document.getElementById('mail_subject_pos').textContent;
  const customer = document.getElementById('mail_customer_name_pos').textContent;
  const date = document.getElementById('mail_date_pos').textContent;
  const positionNo = document.getElementById('mail_position_no_pos').textContent;
  const sender = document.getElementById('mail_sender_pos').textContent;
  const consignee = document.getElementById('mail_consignee_pos').textContent;
  const packages = document.getElementById('mail_packages_pos').textContent;
  const goods = document.getElementById('mail_goods_pos').textContent;
  const weight = document.getElementById('mail_weight_pos').textContent;
  const truck = document.getElementById('mail_truck_pos').textContent;
  const customs = document.getElementById('mail_customs_pos').textContent;
  const exitDate = document.getElementById('mail_exit_date_pos').textContent;
  const arrivalDate = document.getElementById('mail_arrival_date_pos').textContent;
  
  const headerTitle = (document.getElementById('mail_modal_header_title') ? document.getElementById('mail_modal_header_title').textContent : 'YÃ¼kleme Bilgisi');
  const introText = (document.getElementById('mail_intro_text') ? document.getElementById('mail_intro_text').textContent : "Ä°ngiltere'den adÄ±nÄ±za alÄ±nan sevkiyata ait yÃ¼kleme bilgileri aÅŸaÄŸÄ±da bilginize sunulmuÅŸtur.");
  const gateEl = document.getElementById('mail_gate_line');
  const gateLine = (gateEl && gateEl.style.display !== 'none') ? gateEl.textContent : '';
  const isVaris = headerTitle === 'VarÄ±ÅŸ Bilgisi';
  const introHtml = isVaris ? `<div style="color:#ef4444; font-weight:700; font-size:16px; padding:14px 20px;">${introText}</div>` : `${introText}`;
  
  // enhance VarÄ±ÅŸ copy to match requested layout (blue header, red intro, detail lines)
  const ambarCode = (document.getElementById('mail_ambar_code_pos') ? document.getElementById('mail_ambar_code_pos').textContent : '');
  const antrepoCode = (document.getElementById('mail_antrepo_code_pos') ? document.getElementById('mail_antrepo_code_pos').textContent : '');
  const guarantee = (document.getElementById('mail_guarantee_pos') ? document.getElementById('mail_guarantee_pos').textContent : '');

  const htmlContent = `<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>body{margin:0;padding:0;background:#ffffff;font-family:Arial, Helvetica, sans-serif;color:#111}table{border-collapse:collapse}</style>
</head>
<body style="margin:0; padding:0; background:#ffffff; font-family: Arial, Helvetica, sans-serif;">
  <table width="100%" style="width:100%; background:transparent; padding:18px 0;">
    <tr>
      <td align="left" style="padding-left:0;">
        <table width="100%" style="max-width:1200px; background:#ffffff; border:1px solid #e1f0fb; margin:0;">
          <tr>
            <td style="background:#38a7e6; text-align:center; padding:12px 8px;">
              <div style="font-size:30px; font-weight:800; color:#ffffff;">${headerTitle}</div>
            </td>
          </tr>
          <tr>
            <td style="padding:12px 14px 6px 14px;">
              <table width="100%" style="border-collapse:collapse;">
                <tr>
                  <td style="width:28%; padding:10px; background:#d8f0ff; font-weight:700; border:1px solid #dbeff6;">Kime</td>
                  <td style="width:22%; padding:10px; border:1px solid #dbeff6;">${customer}</td>
                  <td style="width:28%; padding:10px; background:#d8f0ff; font-weight:700; border:1px solid #dbeff6;">Tarih</td>
                  <td style="width:22%; padding:10px; border:1px solid #dbeff6;">${date}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#d8f0ff; font-weight:700; border:1px solid #dbeff6;">Konu</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${subject}</td>
                  <td style="padding:10px; background:#d8f0ff; font-weight:700; border:1px solid #dbeff6;">Pozisyon No</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${positionNo}</td>
                </tr>
              </table>

              <div style="height:12px"></div>

              ${ (introText || gateLine) ? `<div style="text-align:center; margin:12px 0;">\n                  <div style="color:${isVaris ? '#ff0000' : '#374151'}; font-weight:800; font-size:16px; line-height:1.25;">${introText}</div>\n                  ${ gateLine ? `<div style="color:${isVaris ? '#ff0000' : '#374151'}; font-weight:800; font-size:16px; line-height:1.25; margin-top:8px;">${gateLine}</div>` : '' }\n                </div>` : ''}

              ${ambarCode ? `<div style="margin-bottom:6px; font-weight:600;">Ambar Kodu ${ambarCode}</div>` : ''}
              ${antrepoCode ? `<div style="margin-bottom:6px; font-weight:600;">Antrepo Kodu ${antrepoCode}</div>` : ''}
              ${guarantee ? `<div style="margin-bottom:6px; font-weight:600;">Teminat No: ${guarantee}</div>` : ''}

              <table width="100%" style="border-collapse:collapse; margin-top:6px;">
                <tr>
                  <td style="width:30%; padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">GÃ¶nderen</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${sender}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">AlÄ±cÄ±</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${consignee}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">Kap Adedi</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${packages}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">Malzeme Cinsi</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${goods}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">BrÃ¼t AÄŸÄ±rlÄ±k</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${weight}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">AraÃ§ PlakasÄ±</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${truck}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">VarÄ±ÅŸ GÃ¼mrÃ¼ÄŸÃ¼</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${customs}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">Ã‡Ä±kÄ±ÅŸ Tarihi</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${exitDate}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">VarÄ±ÅŸ Tarihi</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">${arrivalDate}</td>
                </tr>
                <tr>
                  <td style="padding:10px; background:#e6f6ff; font-weight:700; border:1px solid #dbeff6;">Malla Gelen Evraklar</td>
                  <td style="padding:10px; border:1px solid #dbeff6;">Fatura</td>
                </tr>
              </table>

            </td>
          </tr>
          <tr>
            <td style="padding:12px 14px; color:#6b7280; font-size:13px;">Ä°yi Ã§alÄ±ÅŸmalar dileriz.</td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  tempDiv.style.position = 'absolute';
  tempDiv.style.left = '-9999px';
  document.body.appendChild(tempDiv);
  
  const range = document.createRange();
  range.selectNode(tempDiv);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);
  
  const copyHtml = () => {
    const listener = (e) => {
      e.clipboardData.setData('text/html', htmlContent);
      e.clipboardData.setData('text/plain', 'YÃœKLEME BÄ°LGÄ°SÄ° - ' + positionNo);
      e.preventDefault();
    };
    document.addEventListener('copy', listener);
    document.execCommand('copy');
    document.removeEventListener('copy', listener);
  };
  
  try {
    copyHtml();
    window.getSelection().removeAllRanges();
    document.body.removeChild(tempDiv);
    
    alert('âœ… HTML formatÄ± panoya kopyalandÄ±!\n\nOutlook veya herhangi bir mail programÄ±nda Ctrl+V ile yapÄ±ÅŸtÄ±rabilirsiniz.');
  } catch (err) {
    document.body.removeChild(tempDiv);
    alert('Kopyalama baÅŸarÄ±sÄ±z oldu!');
  }
}

async function sendMailPosition() {
  const subject = document.getElementById('mail_subject_pos').textContent;
  const customer = document.getElementById('mail_customer_name_pos').textContent;
  const date = document.getElementById('mail_date_pos').textContent;
  const positionNo = document.getElementById('mail_position_no_pos').textContent;
  const sender = document.getElementById('mail_sender_pos').textContent;
  const consignee = document.getElementById('mail_consignee_pos').textContent;
  const packages = document.getElementById('mail_packages_pos').textContent;
  const goods = document.getElementById('mail_goods_pos').textContent;
  const weight = document.getElementById('mail_weight_pos').textContent;
  const truck = document.getElementById('mail_truck_pos').textContent;
  const customs = document.getElementById('mail_customs_pos').textContent;
  const exitDate = document.getElementById('mail_exit_date_pos').textContent;
  const arrivalDate = document.getElementById('mail_arrival_date_pos').textContent;

  // Determine To/CC lists from DB (if mapped) and open a modern modal for confirmation/edit
  let toList = [];
  let ccList = [];
  let modalResult = null;
  try {
    const recipientName = (consignee || customer || '').trim();
    if (recipientName) {
      // include sender so server can provide sender-specific recipient mappings
      const resp = await fetch('/mail-data/emails-full?name=' + encodeURIComponent(recipientName) + '&sender=' + encodeURIComponent(sender));
      if (resp && resp.ok) {
        const j = await resp.json();
        const rows = j.emails || [];
        rows.forEach(r => {
          if (r.is_active === 1) {
            const t = (r.recipient_type || 'to').toString().toLowerCase();
            if (t === 'cc') ccList.push(r.email);
            else toList.push(r.email);
          }
        });
      }
    }

    // Show modern modal to review/edit To and CC lists
    modalResult = await showSendConfirmModal(toList, ccList, positionNo);
    if (!modalResult || !modalResult.ok) return; // user cancelled
    toList = modalResult.toList;
    ccList = modalResult.ccList;
  } catch (err) {
    console.error('Recipient lookup/modal error', err);
    await showResultModal('âŒ AlÄ±cÄ± belirlenirken hata', 'AlÄ±cÄ± belirlenirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.\n\n' + (err.message || ''), true);
    return;
  }

  try {
    const form = new FormData();
    form.append('customer', customer || '');
    form.append('date', date || '');
    form.append('subject', subject || '');
    form.append('positionNo', positionNo || '');
    form.append('sender', sender || '');
    form.append('consignee', consignee || '');
    form.append('packages', packages || '');
    form.append('goods', goods || '');
    form.append('weight', weight || '');
    form.append('truck', truck || '');
    form.append('customs', customs || '');
    form.append('exitDate', exitDate || '');
    form.append('arrivalDate', arrivalDate || '');
    form.append('to', toList.join(','));
    form.append('cc', ccList.join(','));
    // include modal mode (yukleme | varis) so server can render correct content
    form.append('mode', window.currentMailModalMode || 'yukleme');
    // include ref value from the specific load row (not all loads in position)
    form.append('ref', window.currentMailLoadRef || '');

    // append files if user added new file objects in modal (rare)
    if (modalResult && modalResult.files && modalResult.files.length) {
      modalResult.files.forEach((f, idx) => {
        try {
          form.append('attachments', f, f.name || ('file' + idx));
        } catch (e) {
          console.warn('Attachment append error', e);
        }
      });
    }

    // append selected existing document IDs so server can attach stored files
    if (modalResult && modalResult.selectedDocs && modalResult.selectedDocs.length) {
      form.append('selected_docs', JSON.stringify(modalResult.selectedDocs));
    }

    const response = await fetch('/loads/send-mail-outlook', {
      method: 'POST',
      body: form
    });

    const result = await response.json();
    
    if (result.success) {
      await showResultModal('âœ… Mail baÅŸarÄ±yla gÃ¶nderildi!', 'TO: ' + (toList.join(',') || '-') + '\nCC: ' + (ccList.join(',') || '-'), false);
      hideMailModalPosition();
    } else {
      await showResultModal('âŒ Mail gÃ¶nderilemedi!', (result.error || 'Bilinmeyen hata'), true);
    }
  } catch (error) {
    console.error('Mail gÃ¶nderme hatasÄ±:', error);
    await showResultModal('âŒ Mail gÃ¶nderilemedi!', (error.message || 'LÃ¼tfen mail ayarlarÄ±nÄ±zÄ± kontrol edin.'), true);
  }
}

// Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapat
document.getElementById('mailModalPosition')?.addEventListener('click', function(e) {
  if (e.target === this) {
    hideMailModalPosition();
  }
});

// Inline edit fonksiyonu
function updateLoadField(loadId, field, value) {
  // Ensure Fatura No values always start with E-
  if (field === 'fatura_no') {
    value = (value || '');
    if (value && !value.startsWith('E-')) value = 'E-' + value;
  }

  fetch(`/loads/${loadId}/update-field`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ field, value })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotification('Alan gÃ¼ncellendi', 'success');
    } else {
      showNotification('GÃ¼ncelleme hatasÄ±: ' + (data.message || 'Bilinmeyen hata'), 'error');
    }
  })
  .catch(err => {
    showNotification('GÃ¼ncelleme sÄ±rasÄ±nda hata: ' + err.message, 'error');
  });
}

// Assign missing 5-digit UIDs for loads on page load by requesting server-side assignment
async function assignMissingUids() {
  const toAssign = Array.from(document.querySelectorAll('.uid-span[data-has-uid="0"]'));
  if (toAssign.length === 0) return;

  for (const el of toAssign) {
    const loadId = el.getAttribute('data-load-id');
    if (!loadId) continue;

    try {
      const resp = await fetch(`/loads/${loadId}/assign-uid`, { method: 'POST' });
      const data = await resp.json();
      if (data && data.success && data.uid) {
        el.textContent = String(data.uid);
        el.setAttribute('data-has-uid', '1');
      } else {
        console.error('UID assign failed for', loadId, data && data.message);
      }
    } catch (err) {
      console.error('UID assign hata:', err);
    }
  }
}

// Run after DOMContent loaded
window.addEventListener('DOMContentLoaded', function() {
  // slight delay to ensure other inits complete
  setTimeout(assignMissingUids, 160);
});

// Result modal implementation (used to show final success/error messages)
function showResultModal(title, message, isError) {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.background = 'rgba(0,0,0,0.55)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = 100001;

    const color = isError ? '#ef4444' : '#10b981';
    modal.innerHTML = `
      <div style="width:560px; max-width:90%; background:#0b1220; color:#e5e7eb; border-radius:10px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(148,163,184,0.06);">
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="width:44px; height:44px; border-radius:8px; background:${color}; display:flex; align-items:center; justify-content:center; font-size:20px;">${isError? 'âœ•' : 'âœ“'}</div>
          <div style="flex:1;">
            <div style="font-weight:700; margin-bottom:6px;">${title}</div>
            <div style="color:#9ca3af; white-space:pre-wrap;">${String(message)}</div>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:14px;">
          <button id="resultOkBtn" style="background:#16a34a; color:white; padding:8px 12px; border-radius:6px; border:0;">Tamam</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    modal.querySelector('#resultOkBtn').addEventListener('click', () => {
      if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
      resolve();
    });
  });
}

// Yeni yÃ¼k satÄ±rÄ± ekle
function addNewLoadRow() {
  const positionNo = '<%= positionNo %>';
  const companies = <%- JSON.stringify(companies || []) %>;
  
  const tbody = document.getElementById('loadsTableBody');
  const newRow = document.createElement('tr');
  newRow.style.background = '#1f2937';
  newRow.innerHTML = `
    <td>
      <select class="inline-edit-select" id="new-customer">
        <option value="">SeÃ§iniz...</option>
        ${companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
      </select>
    </td>
    <td>
      <select class="inline-edit-select" id="new-consignee">
        <option value="">SeÃ§iniz...</option>
        ${companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
      </select>
    </td>
    <td><input type="text" class="inline-edit-input" id="new-loading" placeholder="Åehir / Ãœlke"></td>
    <td><input type="text" class="inline-edit-input" id="new-unloading" placeholder="Åehir / Ãœlke"></td>
    <td><input type="number" class="inline-edit-input" id="new-packages" placeholder="Kap" style="width: 60px;"></td>
    <td><input type="number" class="inline-edit-input" id="new-weight" placeholder="Kilo" style="width: 80px;"></td>
    <td><input type="text" class="inline-edit-input" id="new-goods" placeholder="Malzeme"></td>
    <td>
      <div style="display: flex; gap: 4px;">
        <input type="number" class="inline-edit-input" id="new-navlun-amount" placeholder="Tutar" style="width: 70px;">
        <select class="inline-edit-select" id="new-navlun-currency" style="width: 60px;">
          <option value="">SeÃ§iniz...</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="USD">USD</option>
          <option value="TRY">TRY</option>
        </select>
      </div>
    </td>
    <td>
      <select class="inline-edit-select" id="new-fatura">
        <option value="">-</option>
        ${companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
      </select>
    </td>
    <td><input type="number" class="inline-edit-input" id="new-ordino" placeholder="TL" style="width: 80px;"></td>
    <td><input type="text" class="inline-edit-input" id="new-fatura-no" placeholder="Fatura No" style="width: 120px;"></td>
    <td>
      <div style="display: flex; gap: 4px;">
        <button onclick="saveNewLoad('${positionNo}')" class="btn btn-sm" style="background: #10b981; color: white;">âœ“</button>
        <button onclick="this.closest('tr').remove()" class="btn btn-sm" style="background: #ef4444; color: white;">âœ•</button>
      </div>
    </td>
  `;
  tbody.appendChild(newRow);
}

// Yeni yÃ¼kÃ¼ kaydet
function saveNewLoad(positionNo) {
  const data = {
    position_no: positionNo,
    customer_name: document.getElementById('new-customer').value,
    consignee_name: document.getElementById('new-consignee').value,
    loading_location: document.getElementById('new-loading').value,
    unloading_location: document.getElementById('new-unloading').value,
    packages: document.getElementById('new-packages').value,
    gross_weight: document.getElementById('new-weight').value,
    goods_description: document.getElementById('new-goods').value,
    navlun_amount: document.getElementById('new-navlun-amount').value,
    navlun_currency: document.getElementById('new-navlun-currency').value,
    fatura_kime: document.getElementById('new-fatura').value,
    ordino_cost: document.getElementById('new-ordino').value,
    fatura_no: (function(){
      const v = document.getElementById('new-fatura-no').value || '';
      if (!v) return '';
      return v.startsWith('E-') ? v : ('E-' + v);
    })()
  };

  fetch('/loads', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      showNotification('Yeni yÃ¼k eklendi', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showNotification('Ekleme hatasÄ±: ' + (result.message || 'Bilinmeyen hata'), 'error');
    }
  })
  .catch(err => {
    showNotification('Ekleme sÄ±rasÄ±nda hata: ' + err.message, 'error');
  });
}

// Create a new empty load on the server immediately (no confirmation)
function createEmptyLoad(positionNo, btn) {
  const originalBtnHtml = btn ? btn.innerHTML : null;
  if (btn) {
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.innerHTML = 'Ekleniyor...';
  }

  // insert optimistic temporary row to reduce perceived lag
  const tbody = document.getElementById('loadsTableBody');
  let tempRow = null;
  if (tbody) {
    tempRow = document.createElement('tr');
    tempRow.className = 'temp-loading-row';
    tempRow.style.opacity = '0.9';
    tempRow.innerHTML = `
      <td colspan="15" style="padding:12px; color:#9ca3af; background:#0b1220;">
        <span style="display:inline-block; margin-right:8px;">â³</span> Yeni yÃ¼k ekleniyor...
      </td>
    `;
    tbody.insertBefore(tempRow, tbody.firstChild);
  }

  const data = {
    position_no: positionNo,
    customer_name: '',
    consignee_name: '',
    loading_location: '',
    unloading_location: '',
    packages: null,
    gross_weight: null,
    goods_description: '',
    navlun_amount: null,
    navlun_currency: '',
    fatura_kime: '',
    fatura_no: '',
    ordino_cost: null
  };

  fetch('/loads', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      showNotification('Yeni yÃ¼k eklendi', 'success');
      // reload to show the created row with its ID
      setTimeout(() => location.reload(), 300);
    } else {
      showNotification('Ekleme hatasÄ±: ' + (result.message || 'Bilinmeyen hata'), 'error');
      if (tempRow) tempRow.remove();
      if (btn) { btn.disabled = false; btn.style.opacity = '1'; if (originalBtnHtml) btn.innerHTML = originalBtnHtml; }
    }
  })
  .catch(err => {
    showNotification('Ekleme sÄ±rasÄ±nda hata: ' + err.message, 'error');
    if (tempRow) tempRow.remove();
    if (btn) { btn.disabled = false; btn.style.opacity = '1'; if (originalBtnHtml) btn.innerHTML = originalBtnHtml; }
  });
}

// Companies list for client-side autocomplete
const companiesList = <%- JSON.stringify(companies || []) %>;

function initCompanyAutocompletes() {
  document.querySelectorAll('.company-autocomplete').forEach(input => {
    // store previous value to revert if invalid
    input.dataset.prev = input.value || '';
    setupAutocompleteForInput(input);
  });
}

function setupAutocompleteForInput(input) {
  const loadId = input.dataset.loadId;
  const field = input.dataset.field;
  const allowedTypes = (input.dataset.allowedTypes || '').split(',').map(s => s.trim()).filter(Boolean);
  const sugContainer = document.getElementById((field === 'customer_name' ? 'customer-sug-' : 'consignee-sug-') + loadId);

  let activeIndex = -1;

  function closeSuggestions() {
    if (sugContainer) {
      sugContainer.style.display = 'none';
      sugContainer.innerHTML = '';
    }
    activeIndex = -1;
  }

  function showSuggestions(items) {
    if (!sugContainer) return;
    if (!items || items.length === 0) { closeSuggestions(); return; }
    sugContainer.innerHTML = '';
    items.forEach((c, idx) => {
      const el = document.createElement('div');
      el.textContent = c.name;
      el.style.cssText = 'padding:8px 10px; cursor:pointer; color:#e5e7eb; border-bottom: 1px solid rgba(255,255,255,0.03);';
      el.addEventListener('mousedown', function(e) {
        e.preventDefault(); // prevent blur
        input.value = c.name;
        input.dataset.prev = c.name;
        closeSuggestions();
        updateLoadField(loadId, field, c.name);
      });
      sugContainer.appendChild(el);
    });
    sugContainer.style.display = 'block';
  }

  function filterCompanies(query) {
    const q = (query || '').toLowerCase().trim();
    return companiesList.filter(c => {
      const typeOk = allowedTypes.length === 0 || allowedTypes.includes(c.type) || c.type === 'both';
      return typeOk && c.name.toLowerCase().includes(q);
    }).slice(0, 30);
  }

  input.addEventListener('input', function(e) {
    const q = this.value;
    if (!q) { closeSuggestions(); return; }
    const items = filterCompanies(q);
    showSuggestions(items);
  });

  input.addEventListener('keydown', function(e) {
    const children = sugContainer ? Array.from(sugContainer.children) : [];
    if (!children.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = Math.min(children.length - 1, activeIndex + 1);
      children.forEach((ch, i) => ch.style.background = i === activeIndex ? '#0f172a' : 'transparent');
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = Math.max(0, activeIndex - 1);
      children.forEach((ch, i) => ch.style.background = i === activeIndex ? '#0f172a' : 'transparent');
    } else if (e.key === 'Enter') {
      e.preventDefault();
      // If an item is highlighted, choose it
      if (activeIndex >= 0 && children[activeIndex]) {
        children[activeIndex].dispatchEvent(new MouseEvent('mousedown'));
        return;
      }

      // If there's exactly one suggestion, pick it
      if (children.length === 1) {
        children[0].dispatchEvent(new MouseEvent('mousedown'));
        return;
      }

      // If the current input exactly matches a company name, use it
      const exact = companiesList.find(c => c.name.toLowerCase() === input.value.trim().toLowerCase() && (allowedTypes.length === 0 || allowedTypes.includes(c.type) || c.type === 'both'));
      if (exact) {
        input.value = exact.name;
        input.dataset.prev = exact.name;
        closeSuggestions();
        updateLoadField(loadId, field, exact.name);
        return;
      }

      // As a fallback, select the first suggestion
      if (children.length > 0) {
        children[0].dispatchEvent(new MouseEvent('mousedown'));
      }
    } else if (e.key === 'Escape') {
      closeSuggestions();
    }
  });

  input.addEventListener('blur', function() {
    setTimeout(() => {
      const exact = companiesList.find(c => c.name === input.value && (allowedTypes.length === 0 || allowedTypes.includes(c.type) || c.type === 'both'));
      if (exact) {
        input.dataset.prev = exact.name;
        updateLoadField(loadId, field, exact.name);
      } else {
        // revert to previous valid value to avoid saving free text
        if (input.dataset.prev) {
          input.value = input.dataset.prev;
        } else {
          input.value = '';
          updateLoadField(loadId, field, '');
        }
      }
      closeSuggestions();
    }, 150);
  });

  input.addEventListener('focus', function() {
    const items = filterCompanies(this.value || '');
    if (items && items.length) showSuggestions(items);
  });
}

// initialize autocompletes once DOM ready
document.addEventListener('DOMContentLoaded', function() {
  initCompanyAutocompletes();
});
</script>

<!-- Antrepo Liste Modal -->
<div id="antrepoListeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:linear-gradient(180deg,#0a1628,#0f1d32); border-radius:16px; padding:24px; max-width:900px; width:95%; max-height:85vh; overflow-y:auto; border:1px solid rgba(148,163,184,0.1);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="color:#e6eef6; font-size:20px; margin:0;">ğŸ“¦ Antrepo Liste - SatÄ±r SeÃ§imi</h2>
      <button onclick="closeAntrepoListeModal()" style="background:transparent; border:none; color:#9ca3af; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:flex; align-items:center; gap:8px; color:#e6eef6; cursor:pointer;">
        <input type="checkbox" id="antrepoSelectAll" onchange="toggleAllAntrepoRows(this.checked)" style="width:18px; height:18px;" checked>
        <span style="font-weight:600;">TÃ¼mÃ¼nÃ¼ SeÃ§/KaldÄ±r</span>
      </label>
    </div>
    
    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
      <thead>
        <tr style="background:#FFE600; color:#000;">
          <th style="padding:10px; text-align:center; width:40px;">SeÃ§</th>
          <th style="padding:10px; text-align:left;">GÃ¶nderici</th>
          <th style="padding:10px; text-align:left;">AlÄ±cÄ±</th>
          <th style="padding:10px; text-align:center;">Kap</th>
          <th style="padding:10px; text-align:right;">Kilo</th>
          <th style="padding:10px; text-align:left;">GÃ¼mrÃ¼k</th>
        </tr>
      </thead>
      <tbody id="antrepoListeBody">
        <% loads.forEach(function(load, idx) { %>
        <tr style="border-bottom:1px solid #1e293b;">
          <td style="padding:10px; text-align:center;">
            <input type="checkbox" class="antrepo-row-check" data-idx="<%= idx %>" checked style="width:18px; height:18px;">
          </td>
          <td style="padding:10px; color:#e6eef6;"><%= load.customer_name || '-' %></td>
          <td style="padding:10px; color:#e6eef6;"><%= load.consignee_name || '-' %></td>
          <td style="padding:10px; text-align:center; color:#e6eef6;"><%= load.packages || '-' %></td>
          <td style="padding:10px; text-align:right; color:#e6eef6;"><%= load.gross_weight ? parseFloat(load.gross_weight).toLocaleString('tr-TR') : '-' %></td>
          <td style="padding:10px; color:#e6eef6;"><%= [load.unloading_country, load.unloading_city].filter(Boolean).join(' - ') || '-' %></td>
        </tr>
        <% }); %>
      </tbody>
    </table>
    
    <div style="display:flex; justify-content:flex-end; gap:12px;">
      <button onclick="closeAntrepoListeModal()" class="btn" style="background:#475569; color:#fff; padding:12px 24px; border-radius:10px; font-weight:600;">Ä°ptal</button>
      <button onclick="downloadAntrepoListePdf()" class="btn" style="background:linear-gradient(135deg, #059669, #10b981); color:#fff; padding:12px 24px; border-radius:10px; font-weight:700;">ğŸ“„ PDF Ä°ndir</button>
    </div>
  </div>
</div>

<script>
// Antrepo Liste Modal iÅŸlemleri
const antrepoLoadsData = <%- JSON.stringify(loads.map(l => ({
  customer_name: l.customer_name || '-',
  consignee_name: l.consignee_name || '-',
  packages: l.packages || '-',
  gross_weight: l.gross_weight || 0,
  unloading_country: l.unloading_country || '',
  unloading_city: l.unloading_city || ''
}))) %>;

const antrepoTrailerPlate = '<%= loads[0].trailer_plate || loads[0].truck_plate || "-" %>';
const antrepoPositionNo = '<%= positionNo %>';

function openAntrepoListeModal() {
  document.getElementById('antrepoListeModal').style.display = 'flex';
}

function closeAntrepoListeModal() {
  document.getElementById('antrepoListeModal').style.display = 'none';
}

function toggleAllAntrepoRows(checked) {
  document.querySelectorAll('.antrepo-row-check').forEach(cb => cb.checked = checked);
}

function downloadAntrepoListePdf() {
  const selectedIndices = [];
  document.querySelectorAll('.antrepo-row-check:checked').forEach(cb => {
    selectedIndices.push(parseInt(cb.dataset.idx));
  });
  
  if (selectedIndices.length === 0) {
    alert('LÃ¼tfen en az bir satÄ±r seÃ§in.');
    return;
  }
  
  // SeÃ§ili satÄ±rlarÄ± al
  const selectedLoads = selectedIndices.map(idx => antrepoLoadsData[idx]);
  
  // POST ile gÃ¶nder
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/loads/position/' + encodeURIComponent(antrepoPositionNo) + '/antrepo-liste';
  form.target = '_blank';
  
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'selectedLoads';
  input.value = JSON.stringify(selectedLoads);
  form.appendChild(input);
  
  const plateInput = document.createElement('input');
  plateInput.type = 'hidden';
  plateInput.name = 'trailerPlate';
  plateInput.value = antrepoTrailerPlate;
  form.appendChild(plateInput);
  
  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
  
  closeAntrepoListeModal();
}
</script>