<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YL - Pozisyon <%= positionNo %></title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 15px;
      color: #000;
    }

    .ameta-container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid #000;
    }

    .company-info {
      flex: 1;
    }

    .company-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #000;
    }

    .info-section {
      border: 2px solid #000;
      margin-bottom: 15px;
      background: white;
    }

    .info-row {
      display: flex;
      border-bottom: 1px solid #000;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-cell {
      flex: 1;
      padding: 8px 10px;
      border-right: 1px solid #000;
      font-size: 12px;
      background: white;
      color: #000;
    }

    .info-cell:last-child {
      border-right: none;
    }

    .info-label {
      font-weight: bold;
      display: block;
      font-size: 9px;
      margin-bottom: 3px;
      color: #333;
      text-transform: uppercase;
    }

    .loads-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 11px;
      border: 2px solid #000;
    }

    .loads-table th,
    .loads-table td {
      border: 1px solid #000;
      padding: 6px 5px;
      text-align: left;
      color: #000;
    }

    .loads-table th {
      background: #e9ecef;
      font-weight: bold;
      text-align: center;
      font-size: 11px;
      color: #000;
      text-transform: uppercase;
    }

    .loads-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    /* KM Section Styles */
    .km-section {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      border: 2px solid #000;
      padding: 10px;
      background: #fff;
    }

    .km-segments {
      flex: 2;
    }

    .km-summary {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .km-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px;
      color: #000;
      text-transform: uppercase;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
      text-decoration: underline;
    }

    .km-segments-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .km-segments-table th,
    .km-segments-table td {
      border: 1px solid #000;
      padding: 5px 6px;
      text-align: left;
    }

    .km-segments-table th {
      background: #eee;
      font-weight: bold;
      text-align: center;
    }

    .km-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 10px;
      border: 1px solid #000;
      font-size: 12px;
      font-weight: bold;
    }

    .km-box.loading { background: #fff; }
    .km-box.unloading { background: #fff; }
    .km-box.exit { background: #fff; }
    .km-box.europe { background: #fff; }
    .km-box.ingiltere { background: #fff; }
    .km-box.total { background: #eee; border: 2px solid #000; }

    /* Mazot Hesabƒ± Stilleri */
    .km-mazot-section {
      flex: 1;
      padding: 10px;
      border: 1px solid #000;
      font-size: 11px;
      background: #fff;
    }
    
    .km-mazot-section.herstal {
      background: #fff;
      border: 1px solid #000;
    }
    
    .km-mazot-section.avrupa {
      background: #fff;
      border: 1px solid #000;
    }
    
    .mazot-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 8px;
      border-bottom: 1px solid #ccc;
      font-size: 11px;
    }
    
    .mazot-row.final {
      background: #fff;
      font-weight: bold;
      border: 1px solid #000;
      margin: 4px 0;
    }
    
    .mazot-row.extra {
      background: #fff;
      font-weight: bold;
      border: 1px solid #000;
      margin-top: 2px;
    }
    
    .mazot-row.extra.green {
      background: #fff;
      color: #000;
    }
    
    .mazot-row.extra.purple {
      background: #fff;
      color: #000;
    }
    
    .val-green { color: #000; font-weight: bold; }
    .val-blue { color: #000; font-weight: bold; }
    .val-orange { color: #000; font-weight: bold; text-decoration: underline; }
    .val-purple { color: #000; font-weight: bold; }

    .footer-section {
      margin-top: 10px;
      border: 2px solid #000;
      padding: 8px;
      background: #f8f9fa;
      color: #000;
      font-size: 9px;
    }

    .footer-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      color: #000;
      gap: 30px;
    }

    .footer-row > div {
      line-height: 1.3;
      white-space: nowrap;
    }

    .print-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
    }

    .print-btn:hover {
      background: #1e40af;
    }

    @media print {
      @page {
        size: A4 landscape;
        margin: 8mm;
      }
      
      .print-btn {
        display: none;
      }
      body {
        padding: 0;
        background: white !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .ameta-container {
        background: white !important;
        max-width: none;
        box-shadow: none;
      }
      
      .info-cell, .info-label, .loads-table th, .loads-table td,
      .footer-section, .footer-row, .footer-row > div, .company-name {
        color: #000 !important;
        background-color: inherit !important;
      }
      
      .loads-table th {
        background: #e9ecef !important;
        color: #000 !important;
      }
      
      .loads-table tr:nth-child(even) {
        background: #f8f9fa !important;
      }
      
      .info-label {
        color: #333 !important;
      }
      
      .footer-section, .km-section {
        background: #f8f9fa !important;
      }

      .km-box.loading { background: #dbeafe !important; }
      .km-box.unloading { background: #dcfce7 !important; }
      .km-box.exit { background: #fef3c7 !important; }
      .km-box.europe { background: #ede9fe !important; }
      .km-box.ingiltere { background: #fee2e2 !important; }
      .km-box.total { background: #d1fae5 !important; }
      
      .km-mazot-section.herstal { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important; }
      .km-mazot-section.avrupa { background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%) !important; }
      .mazot-row.final { background: #fef3c7 !important; }
      .mazot-row.extra { background: #ede9fe !important; }
      .mazot-row.extra.green { background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important; color: #fff !important; }
      .mazot-row.extra.purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%) !important; color: #fff !important; }
    }
  </style>
</head>
<body>
  <button class="print-btn" onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>

  <div class="ameta-container">
    <!-- Header -->
    <div class="header">
      <div class="company-info">
        <div class="company-name">BEST ULUSLARARASI NAKLƒ∞YAT VE Tƒ∞C LTD ≈ûTƒ∞</div>
      </div>
    </div>

    <!-- Pozisyon Bilgileri -->
    <div class="info-section">
      <div class="info-row">
        <div class="info-cell">
          <span class="info-label">POZ / DOSYA NO</span>
          <%= positionNo %>
        </div>
        <div class="info-cell">
          <span class="info-label">√áEKƒ∞Cƒ∞ PLAKASI</span>
          <%= firstLoad.truck_plate || '' %>
        </div>
        <div class="info-cell">
          <span class="info-label">DORSE PLAKASI</span>
          <%= firstLoad.trailer_plate || '' %>
        </div>
      </div>
      <div class="info-row">
        <div class="info-cell">
          <span class="info-label">√áIKI≈û TARƒ∞Hƒ∞</span>
          <% 
            const ldYL = firstLoad.loading_date || '';
            const ldYLParts = ldYL.split('-');
            const ldYLFormatted = ldYLParts.length === 3 ? `${ldYLParts[2]}.${ldYLParts[1]}.${ldYLParts[0]}` : ldYL;
          %>
          <%= ldYLFormatted %>
        </div>
        <div class="info-cell" style="flex: 2;">
          <span class="info-label">BO≈ûALTMA G√úMR√úKLERƒ∞</span>
          <% const unloadingCountries = (loads || []).map(l => l.unloading_country).filter(Boolean);
             const uniqueCountries = [...new Set(unloadingCountries)]; %>
          <%= uniqueCountries.length ? uniqueCountries.join(', ') : '' %>
        </div>
        <div class="info-cell">
          <span class="info-label">≈ûOF√ñR ADI</span>
          <%= firstLoad.driver_name || '' %>
        </div>
      </div>
      <div class="info-row">
        <div class="info-cell" style="flex: 2;">
          <span class="info-label">Antrepo</span>
          <% 
            const antrepoEntries = (loads || []).map(l => l.unloading_city).filter(Boolean);
            const uniqueAntrepos = [...new Set(antrepoEntries)];
          %>
          <%= uniqueAntrepos.length ? uniqueAntrepos.join(' | ') : '' %>
        </div>
        <div class="info-cell">
          <span class="info-label">MRN NUMARASI</span>
          <%= firstLoad.mrn_no || '' %>
        </div>
        <div class="info-cell">
          <span class="info-label">M√úH√úR NUMARASI</span>
          <%= firstLoad.seal_code || '' %>
        </div>
      </div>
    </div>

    <!-- Y√ºkler Tablosu -->
    <table class="loads-table">
      <thead>
        <tr>
          <th>NO</th>
          <th>UID</th>
          <th>G√ñNDERƒ∞Cƒ∞</th>
          <th>ALICI Fƒ∞RMA</th>
          <th>Y√úKLEME YERƒ∞</th>
          <th>LDM</th>
          <th>REF</th>
          <th>VARI≈û G√úMR√úƒû√ú</th>
          <th>ANTREPO</th>
          <th>MAL Cƒ∞NSƒ∞</th>
          <th>KAP AD.</th>
          <th>KAP NEVƒ∞</th>
          <th>BR√úT Kƒ∞LO</th>
          <th>FATURA Kƒ∞ME</th>
          <th>D√ñVƒ∞Z</th>
          <th>NAVLUN</th>
          <th>YDG</th>
          <th>TOPLM</th>
          <th>ORDƒ∞NO</th>
          <th>FATURA NO</th>
        </tr>
      </thead>
      <tbody>
        <% 
          let totalPackages = 0;
          let totalGrossWeight = 0;
          let totalTL = 0;
          let totalOrdino = 0;
        %>
        <% loads.forEach((load, index) => { 
          const navlun = parseFloat(load.navlun_amount) || 0;
          const currency = (load.navlun_currency || 'EUR').toUpperCase();
          let rate = 1;
          if (currency === 'USD') rate = rates.USD;
          else if (currency === 'EUR') rate = rates.EUR;
          else if (currency === 'GBP') rate = rates.GBP;
          const tlValue = navlun * rate;
          const ordinoCost = parseFloat(load.ordino_cost) || 0;
          const ydgAmount = parseFloat(load.ydg_amount) || 0;
          const eurRate = rates.EUR;
          const ydgTL = ydgAmount * eurRate;
          
          totalPackages += parseInt(load.packages) || 0;
          totalGrossWeight += parseFloat(load.gross_weight) || 0;
          totalTL += tlValue + ydgTL + ordinoCost;
          totalOrdino += ordinoCost;
        %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= load.uid || '' %></td>
          <td><%= load.customer_name || '' %></td>
          <td><%= load.consignee_name || '' %></td>
          <td><%= [load.loading_city, load.loading_country].filter(Boolean).join(', ') %></td>
          <td><%= load.ldm || '' %></td>
          <td><%= load.ref || '' %></td>
          <td><%= load.unloading_country || '' %></td>
          <td><%= load.unloading_city || '' %></td>
          <td><%= load.goods_description || '' %></td>
          <td><%= load.packages || '' %></td>
          <td>KAP</td>
          <td><%= load.gross_weight || '' %></td>
          <td><%= load.fatura_kime || '' %></td>
          <td><%= load.navlun_currency || '' %></td>
          <td><%= load.navlun_amount || '' %></td>
          <td><%= ydgAmount > 0 ? ydgAmount.toFixed(2) : '' %></td>
          <td><%= (navlun + ydgAmount) > 0 ? (navlun + ydgAmount).toFixed(2) : '' %></td>
          <td><%= ordinoCost > 0 ? ordinoCost.toFixed(2) + ' TL' : '' %></td>
          <td></td>
        </tr>
        <% }); %>
        <tr>
          <td colspan="10" style="font-weight:bold; background:#e0e0e0;">GENEL TOPLAM</td>
          <td style="font-weight:bold; background:#e0e0e0;"><%= totalPackages %> KAP</td>
          <td style="background:#e0e0e0;"></td>
          <td style="font-weight:bold; background:#e0e0e0;"><%= totalGrossWeight.toFixed(2) %> KG</td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
          <td style="background:#e0e0e0;"></td>
        </tr>
      </tbody>
    </table>

    <% if (kmInfo && kmInfo.segments && kmInfo.segments.length > 0) { %>
    <!-- KM Bilgileri -->
    <div class="km-section">
      <div class="km-segments">
        <div class="km-title">ARA√á KM Bƒ∞LGƒ∞LERƒ∞</div>
        <table class="km-segments-table">
          <thead>
            <tr>
              <th style="width:25px;">#</th>
              <th style="width:60px;">Tƒ∞P</th>
              <th>BA≈ûLANGI√á</th>
              <th>Bƒ∞Tƒ∞≈û</th>
              <th style="width:70px;">MESAFE</th>
            </tr>
          </thead>
          <tbody>
            <% kmInfo.segments.forEach((seg, idx) => { 
              const typeNames = { loading: 'Y√ºkleme', unloading: 'Bo≈üaltma', exit: '√áƒ±kƒ±≈ü', europe: 'Avrupa Y√ºkleme' };
              const typeName = typeNames[seg.type] || seg.type;
              
              // Adresi kƒ±salt
              function shortAddr(addr) {
                if (!addr) return '-';
                const parts = addr.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                  return parts[0] + ', ' + parts[parts.length - 1];
                }
                return parts[0] || '-';
              }
            %>
            <tr>
              <td style="text-align:center;"><%= idx + 1 %></td>
              <td><%= typeName %></td>
              <td><%= shortAddr(seg.from) %></td>
              <td><%= shortAddr(seg.to) %></td>
              <td style="text-align:right; font-weight:bold;"><%= (seg.distance || 0).toFixed(1) %> km</td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:10px; font-size:14px; font-weight:bold;">
          <div style="border:2px solid #000; padding:8px 20px;">
            <u>Bo≈üaltma:</u> <%= kmInfo.segments.filter(s => s.type === 'unloading').length %>
          </div>
          <div style="border:2px solid #000; padding:8px 20px;">
            <u>Y√ºkleme:</u> <%= kmInfo.segments.filter(s => s.type === 'loading' || s.type === 'europe').length %>
          </div>
        </div>
      </div>
      <div class="km-summary">
        <div class="km-title">KM √ñZET</div>
        <%
          // 20'nin katƒ±na yuvarla
          const roundTo20 = (val) => Math.ceil(val / 20) * 20;
          const loadingKmRounded = roundTo20(kmInfo.loadingKm);
          const unloadingKmRounded = roundTo20(kmInfo.unloadingKm);
          const exitKmRounded = roundTo20(kmInfo.exitKm);
          const europeKmRounded = roundTo20(kmInfo.europeKm);
          const ingiltereKmRounded = roundTo20(kmInfo.ingiltereKm);
          const totalKmRounded = roundTo20(kmInfo.totalKm);
        %>
        <div class="km-box loading">
          <span>Y√úKLEME KM</span>
          <span><%= loadingKmRounded %> km</span>
        </div>
        <div class="km-box unloading">
          <span>BO≈ûALTMA KM</span>
          <span><%= unloadingKmRounded %> km</span>
        </div>
        <div class="km-box exit">
          <span>√áIKI≈û KM</span>
          <span><%= exitKmRounded %> km</span>
        </div>
        <div class="km-box europe">
          <span>AVRUPA KM</span>
          <span><%= europeKmRounded %> km</span>
        </div>
        <div class="km-box ingiltere">
          <span>ƒ∞NGƒ∞LTERE KM</span>
          <span><%= ingiltereKmRounded %> km</span>
        </div>
        <div class="km-box total">
          <span>TOPLAM KM</span>
          <span><%= totalKmRounded %> km</span>
        </div>
      </div>
      
      <% if (kmInfo.herstalData) { %>
      <!-- ƒ∞ngiltere Mazot Hesabƒ± -->
      <div class="km-mazot-section herstal">
        <div class="km-title">ƒ∞NGƒ∞LTERE √áIKI≈û MAZOT HESABI</div>
        <div class="mazot-row"><span>DOVER-DOVER</span><span class="val-green"><%= kmInfo.herstalData.doverDover %> km</span></div>
        <div class="mazot-row"><span>DOVER-DOVER + HERSTAL (+1750 KM)</span><span class="val-blue"><%= kmInfo.herstalData.ddHerstal %> km</span></div>
        <div class="mazot-row"><span>TOPLAM + EXTRA (+125 KM)</span><span class="val-blue"><%= kmInfo.herstalData.toplamExtra %> km</span></div>
        <div class="mazot-row"><span>HARCANAN MAZOT (x0.3 ƒ∞LE HESAPLANIYOR)</span><span class="val-blue"><%= kmInfo.herstalData.harcananMazot.toFixed(1) %> LT HARCADI</span></div>
        <div class="mazot-row final"><span>KALAN MAZOT (1450 - HARCANAN MAZOT)</span><span class="val-orange"><%= kmInfo.herstalData.kalanMazot %> LT kaldƒ±</span></div>
        <div class="mazot-row extra"><span>HERSTAL MAZOT (500 LT'ye TAMAMLANACAK)</span><span class="val-purple"><%= kmInfo.herstalData.herstalMazot > 0 ? kmInfo.herstalData.herstalMazot + ' LT alƒ±nacak' : 'YOK' %></span></div>
        <div class="mazot-row extra"><span>SHELL MOSONMAGYAR ALINACAK MAZOT</span><span class="val-purple"><%= kmInfo.herstalData.macar %> LT</span></div>
      </div>
      <% } %>
      
      <% if (kmInfo.avrupaData) { %>
      <!-- Avrupa Mazot Hesabƒ± -->
      <div class="km-mazot-section avrupa">
        <div class="km-title">AVRUPA MAZOT HESABI</div>
        <div class="mazot-row"><span>Toplam Mesafe</span><span class="val-green"><%= kmInfo.avrupaData.totalKm %> km</span></div>
        <div class="mazot-row"><span>Son Nokta ‚Üí Macaristan (Rozvadov √ºzerinden)</span><span class="val-blue"><%= kmInfo.avrupaData.macarKm %> km</span></div>
        <div class="mazot-row"><span>Macaristan Ekleme</span><span class="val-blue">+ 1500 km</span></div>
        <div class="mazot-row final"><span>TOPLAM KM</span><span class="val-orange"><%= kmInfo.avrupaData.grandTotal %> km</span></div>
        <div class="mazot-row"><span>HARCANAN MAZOT (x0.3)</span><span class="val-blue"><%= kmInfo.avrupaData.mazotUsed.toFixed(1) %> lt</span></div>
        <div class="mazot-row extra green" style="border:2px solid #000; padding:8px 12px;"><span><u>KALAN MAZOT (1450 - harcanan)</u></span><span><%= kmInfo.avrupaData.kalanMazot %> lt</span></div>
        <div class="mazot-row extra purple" style="border:2px solid #000; padding:8px 12px;"><span><u>MACAR (600'e tamamla)</u></span><span><%= kmInfo.avrupaData.macar > 0 ? kmInfo.avrupaData.macar + ' lt' : 'YOK' %></span></div>
      </div>
      <% } %>
    </div>
    <% } %>

  </div>
</body>
</html>
